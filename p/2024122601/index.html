<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='容器编排的强大工具，负责管理容器的部署、调度、伸缩等操作。比如在应对流量高峰时，可以自动扩展容器实例数量来保障服务性能，在流量低谷时又能相应收缩，节省资源。'>
<title>Kubernetes详细教程</title>
<link rel='canonical' href='https://www.colorfulgz.com/p/2024122601/'>

<link rel="stylesheet" href="/scss/style.min.ddca736db85fa62296cbc16390278c3c703c5350931c8a162abbc545d67c6647.css">
    <link rel="shortcut icon" href="/favicon.ico" />

        <meta name="baidu-site-verification" content="codeva-Xk4wHYYoxI" />
        <meta name="msvalidate.01" content="348985D817128258C5763978D0B59116" /><script defer src="/script.js" data-website-id=""></script><script src="https://registry.npmmirror.com/twikoo/1.6.38/files/dist/twikoo.all.min.js" integrity="sha384-iwCuZOQXH9C9J67oqn6gT5NKj9GRVo/CY8N3mOGk1Vr4aIiAgme2gXTh7QGagg3B" crossorigin="anonymous"></script>
        
        <script>
            var mainColor = '#FFA500'; 
            document.documentElement.style.setProperty('--main-color', mainColor);
        </script>
    </head>
    <body class="
    article-page
    "  id="top">
        <div class="global-bg"></div>
<div id="loader-wrapper">
    <div id="loader"></div>
    <div class="loader-section section-top"></div>
    <div class="loader-section section-bottom"></div>
</div>
<script type="text/javascript">
    window.onload = function () { document.body.className += ' loaded'; };
    window.setTimeout(function () { document.body.className += ' loaded'; }, 500);
</script>

    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "light");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<nav class="no-copy" id="navbar">
    <div class="nav-main">
        <div class="title nav-left">
            
            <a href="/">
                
                <img src='/favicon.ico' width="60" height="60" alt="alt">
            </a>
        </div>
        <div class="nav-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler" width="24" height="24" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
 <title id="chevronsRightIconTitle">Chevrons Right</title> <polyline points="13 7 18 12 13 17 13 17"/> <polyline points="7 7 12 12 7 17 7 17"/> </svg>
        </div>
        <div class="nav-center">
            <div class="menu--commpect" id="switch">
                <div class="menu" >
                    
                    
                    
                    <span >
                        <a href='/archives/' >
                            <span>归档</span>
                        </a>
                    </span>
                    
                </div>
                <div class="page-name">Kubernetes详细教程</div>
            </div>
        </div>
        <div class="nav-right">
            
            <div class="search">
                <a href="/search/index.html">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                </a>
            </div>
            <div class="hamburger" type="button" id="toggleButton" aria-label="">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler" width="24" height="24" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
<title id="hamburgerIconTitle">Menu</title> 
<path d="M6 7L18 7M6 12L18 12M6 17L18 17"/> 
</svg>

            </div>
            
                <div class="dark-mode-toggle" id="dark-mode-toggle-2">
                    <svg t="1712810451251" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7439" width="25" height="25"><path d="M512 0C227.84 0 0 227.84 0 512s227.84 512 512 512 512-227.84 512-512S796.16 0 512 0z m0 977.408V46.592c256 0 465.408 209.408 465.408 465.408S768 977.408 512 977.408z" fill="var(--icon-color-main)"></path></svg>
                </div>
            
        </div>
    </div>
</nav>

<script>
    let lastScrollTop = 0;
    const navbar = document.getElementById('switch');
  
    window.addEventListener('scroll', function() {
      let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  
      if (scrollTop > lastScrollTop) {
        
        navbar.classList.add('hidden');
      } else {
        
        navbar.classList.remove('hidden');
      }
      lastScrollTop = scrollTop;
    });
</script><div id="overlay"></div>
        
<aside class="left-sidebar" id="left-sidebar">
    
    <div class="info-widget no-copy widget--card">
        <div class="info-bg">
        </div>
      
        <div class="site-avatar">
          <img src="/images/apple-touch-icon.png" alt="" />
        </div>
      
        <div class="site-meta">
          <p class="site-name">运维匠</p>
          <p class="site-description">运维经验技术分享</p>
        </div>
        <div class="social">
          
        </div>
      </div>
      
    <ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg t="1712835356065" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="9171" width="200" height="200"><path d="M298.666667 550.4h426.666666v-42.666667H298.666667v42.666667z m0-132.266667h426.666666v-42.666666H298.666667v42.666666z m0-136.533333h426.666666v-42.666667H298.666667v42.666667z m576 388.266667v247.466666h-725.333334v-247.466666h93.866667c4.266667 0 8.533333 0 12.8 4.266666L384 768c12.8 8.533333 25.6 12.8 38.4 12.8h183.466667c12.8 0 25.6-4.266667 38.4-12.8l128-93.866667c4.266667-4.266667 8.533333-4.266667 12.8-4.266666h89.6z m0-42.666667h-89.6c-12.8 0-25.6 4.266667-38.4 12.8l-128 93.866667c-4.266667 4.266667-8.533333 4.266667-12.8 4.266666H418.133333c-4.266667 0-8.533333 0-12.8-4.266666l-128-93.866667c-12.8-8.533333-25.6-12.8-38.4-12.8H149.333333V106.666667h725.333334v520.533333z" fill="var(--icon-color-main)" p-id="9172"></path></svg>
                
                <span>归档</span>
            </a>
        </li>
        
    </ol>
    <div class="left-bottom">
        
            <div class="dark-mode-toggle" id="dark-mode-toggle-1">
                <svg t="1712810451251" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7439" width="25" height="25"><path d="M512 0C227.84 0 0 227.84 0 512s227.84 512 512 512 512-227.84 512-512S796.16 0 512 0z m0 977.408V46.592c256 0 465.408 209.408 465.408 465.408S768 977.408 512 977.408z" fill="var(--icon-color-main)"></path></svg>
            </div>
        
        
    </div>
</aside>

<div class="overlay" id="closeButton" style=""></div>

        <div class="container main-container flex">
            <main class="main article-grid">
                <div class="article-main">

    
    
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/2024122601/">
                <img src="/p/2024122601/cloud_hu26b4ff2c5f4e80c16b83cdd5c401a19e_26382_800x0_resize_box_3.png"
                        srcset="/p/2024122601/cloud_hu26b4ff2c5f4e80c16b83cdd5c401a19e_26382_800x0_resize_box_3.png 800w, /p/2024122601/cloud_hu26b4ff2c5f4e80c16b83cdd5c401a19e_26382_1600x0_resize_box_3.png 1600w"
                        width="800" 
                        height="349" 
                        loading="lazy"
                        alt="Featured image of post Kubernetes详细教程" />
                
            </a>
            
            
                <a href="https://unsplash.com/photos/a-person-holding-up-a-sign-that-says-hello-PVr9Gsj93Pc" title="封面来源" class="cover-url">
                    <svg t="1720510544804" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4274" width="200" height="200"><path d="M607.934444 417.856853c-6.179746-6.1777-12.766768-11.746532-19.554358-16.910135l-0.01228 0.011256c-6.986111-6.719028-16.47216-10.857279-26.930349-10.857279-21.464871 0-38.864146 17.400299-38.864146 38.864146 0 9.497305 3.411703 18.196431 9.071609 24.947182l-0.001023 0c0.001023 0.001023 0.00307 0.00307 0.005117 0.004093 2.718925 3.242857 5.953595 6.03853 9.585309 8.251941 3.664459 3.021823 7.261381 5.997598 10.624988 9.361205l3.203972 3.204995c40.279379 40.229237 28.254507 109.539812-12.024871 149.820214L371.157763 796.383956c-40.278355 40.229237-105.761766 40.229237-146.042167 0l-3.229554-3.231601c-40.281425-40.278355-40.281425-105.809861 0-145.991002l75.93546-75.909877c9.742898-7.733125 15.997346-19.668968 15.997346-33.072233 0-23.312962-18.898419-42.211381-42.211381-42.211381-8.797363 0-16.963347 2.693342-23.725354 7.297197-0.021489-0.045025-0.044002-0.088004-0.066515-0.134053l-0.809435 0.757247c-2.989077 2.148943-5.691629 4.669346-8.025791 7.510044l-78.913281 73.841775c-74.178443 74.229608-74.178443 195.632609 0 269.758863l3.203972 3.202948c74.178443 74.127278 195.529255 74.127278 269.707698 0l171.829484-171.880649c74.076112-74.17435 80.357166-191.184297 6.282077-265.311575L607.934444 417.856853z" p-id="4275"></path><path d="M855.61957 165.804257l-3.203972-3.203972c-74.17742-74.178443-195.528232-74.178443-269.706675 0L410.87944 334.479911c-74.178443 74.178443-78.263481 181.296089-4.085038 255.522628l3.152806 3.104711c3.368724 3.367701 6.865361 6.54302 10.434653 9.588379 2.583848 2.885723 5.618974 5.355985 8.992815 7.309476 0.025583 0.020466 0.052189 0.041956 0.077771 0.062422l0.011256-0.010233c5.377474 3.092431 11.608386 4.870938 18.257829 4.870938 20.263509 0 36.68962-16.428158 36.68962-36.68962 0-5.719258-1.309832-11.132548-3.645017-15.95846l0 0c-4.850471-10.891048-13.930267-17.521049-20.210297-23.802102l-3.15383-3.102664c-40.278355-40.278355-24.982998-98.79612 15.295358-139.074476l171.930791-171.830507c40.179095-40.280402 105.685018-40.280402 145.965419 0l3.206018 3.152806c40.279379 40.281425 40.279379 105.838513 0 146.06775l-75.686796 75.737962c-10.296507 7.628748-16.97358 19.865443-16.97358 33.662681 0 23.12365 18.745946 41.87062 41.87062 41.87062 8.048303 0 15.563464-2.275833 21.944801-6.211469 0.048095 0.081864 0.093121 0.157589 0.141216 0.240477l1.173732-1.083681c3.616364-2.421142 6.828522-5.393847 9.529027-8.792247l79.766718-73.603345C929.798013 361.334535 929.798013 239.981676 855.61957 165.804257z" p-id="4276"></path></svg>
                </a>
            
            
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/" >
                云原生
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/2024122601/">Kubernetes详细教程</a>
        </h2>
        
        <h3 class="article-subtitle">
            容器编排的强大工具，负责管理容器的部署、调度、伸缩等操作。比如在应对流量高峰时，可以自动扩展容器实例数量来保障服务性能，在流量低谷时又能相应收缩，节省资源。
        </h3>
        
    </div>

    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Dec 23, 2024</time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    
    
    <h2 id="kubernetes-详细教程">Kubernetes 详细教程</h2>
<h3 id="1-kubernetes-介绍">1. Kubernetes 介绍</h3>
<h4 id="11-应用部署方式演变">1.1 应用部署方式演变</h4>
<p>在部署应用程序的方式上，主要经历了三个时代：</p>
<ul>
<li>
<p>传统部署：互联网早期，会直接将应用程序部署在物理机上</p>
<blockquote>
<p>优点：简单，不需要其它技术的参与</p>
<p>缺点：不能为应用程序定义资源使用边界，很难合理地分配计算资源，而且程序之间容易产生影响</p>
</blockquote>
</li>
<li>
<p>虚拟化部署：可以在一台物理机上运行多个虚拟机，每个虚拟机都是独立的一个环境</p>
<blockquote>
<p>优点：程序环境不会相互产生影响，提供了一定程度的安全性</p>
<p>缺点：增加了操作系统，浪费了部分资源</p>
</blockquote>
</li>
<li>
<p>容器化部署：与虚拟化类似，但是共享了操作系统</p>
<blockquote>
<p>优点：</p>
<p>可以保证每个容器拥有自己的文件系统、CPU、内存、进程空间等</p>
<p>运行应用程序所需要的资源都被容器包装，并和底层基础架构解耦</p>
<p>容器化的应用程序可以跨云服务商、跨 Linux 操作系统发行版进行部署</p>
</blockquote>
</li>
</ul>
<p><a href="/p/2024122601/upload/image-20200505183738289.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200505183738289.png"
	width="1112"
	height="418"
	srcset="/p/2024122601/upload/image-20200505183738289_hud81018a6f6b9efe480c97ee051844577_16640_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200505183738289_hud81018a6f6b9efe480c97ee051844577_16640_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200505183738289"
	
>
</a></p>
<p>容器化部署方式给带来很多的便利，但是也会出现一些问题，比如说：</p>
<ul>
<li>一个容器故障停机了，怎么样让另外一个容器立刻启动去替补停机的容器</li>
<li>当并发访问量变大的时候，怎么样做到横向扩展容器数量</li>
</ul>
<p>这些容器管理的问题统称为容器编排问题，为了解决这些容器编排问题，就产生了一些容器编排的软件：</p>
<ul>
<li>Swarm：Docker 自己的容器编排工具</li>
<li>Mesos：Apache 的一个资源统一管控的工具，需要和 Marathon 结合使用</li>
<li>Kubernetes：Google 开源的的容器编排工具</li>
</ul>
<p><a href="/p/2024122601/upload/image-20200524150339551.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200524150339551.png"
	width="593"
	height="272"
	srcset="/p/2024122601/upload/image-20200524150339551_hu35c531ffcd55fa66c8b2389c90240301_9715_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200524150339551_hu35c531ffcd55fa66c8b2389c90240301_9715_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200524150339551"
	
>
</a></p>
<h4 id="12-kubernetes-简介">1.2 kubernetes 简介</h4>
<p><a href="/p/2024122601/upload/image-20200406232838722.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200406232838722.png"
	width="541"
	height="281"
	srcset="/p/2024122601/upload/image-20200406232838722_hu0ceb01e66ee286ff30f90aba2f0a28ea_43233_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200406232838722_hu0ceb01e66ee286ff30f90aba2f0a28ea_43233_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200406232838722"
	
>
</a></p>
<p>kubernetes，是一个全新的基于容器技术的分布式架构领先方案，是谷歌严格保密十几年的秘密武器&mdash;-Borg 系统的一个开源版本，于 2014 年 9 月发布第一个版本，2015 年 7 月发布第一个正式版本。</p>
<p>kubernetes 的本质是一组服务器集群，它可以在集群的每个节点上运行特定的程序，来对节点中的容器进行管理。目的是实现资源管理的自动化，主要提供了如下的主要功能：</p>
<ul>
<li>自我修复：一旦某一个容器崩溃，能够在 1 秒中左右迅速启动新的容器</li>
<li>弹性伸缩：可以根据需要，自动对集群中正在运行的容器数量进行调整</li>
<li>服务发现：服务可以通过自动发现的形式找到它所依赖的服务</li>
<li>负载均衡：如果一个服务起动了多个容器，能够自动实现请求的负载均衡</li>
<li>版本回退：如果发现新发布的程序版本有问题，可以立即回退到原来的版本</li>
<li>存储编排：可以根据容器自身的需求自动创建存储卷</li>
</ul>
<h4 id="13-kubernetes-组件">1.3 kubernetes 组件</h4>
<p>一个 kubernetes 集群主要是由控制节点(master)、工作节点(node)构成，每个节点上都会安装不同的组件。</p>
<p>master：集群的控制平面，负责集群的决策 ( 管理 )</p>
<blockquote>
<p>ApiServer : 资源操作的唯一入口，接收用户输入的命令，提供认证、授权、API 注册和发现等机制</p>
<p>Scheduler : 负责集群资源调度，按照预定的调度策略将 Pod 调度到相应的 node 节点上</p>
<p>ControllerManager : 负责维护集群的状态，比如程序部署安排、故障检测、自动扩展、滚动更新等</p>
<p>Etcd ：负责存储集群中各种资源对象的信息</p>
</blockquote>
<p>node：集群的数据平面，负责为容器提供运行环境 ( 干活 )</p>
<blockquote>
<p>Kubelet : 负责维护容器的生命周期，即通过控制 docker，来创建、更新、销毁容器</p>
<p>KubeProxy : 负责提供集群内部的服务发现和负载均衡</p>
<p>Docker : 负责节点上容器的各种操作</p>
</blockquote>
<p><a href="/p/2024122601/upload/image-20200406184656917.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200406184656917.png"
	width="1436"
	height="745"
	srcset="/p/2024122601/upload/image-20200406184656917_hua134daed280c19d7bf688226539459b0_29159_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200406184656917_hua134daed280c19d7bf688226539459b0_29159_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200406184656917"
	
>
</a></p>
<p>下面，以部署一个 nginx 服务来说明 kubernetes 系统各个组件调用关系：</p>
<ol>
<li>
<p>首先要明确，一旦 kubernetes 环境启动之后，master 和 node 都会将自身的信息存储到 etcd 数据库中</p>
</li>
<li>
<p>一个 nginx 服务的安装请求会首先被发送到 master 节点的 apiServer 组件</p>
</li>
<li>
<p>apiServer 组件会调用 scheduler 组件来决定到底应该把这个服务安装到哪个 node 节点上</p>
<p>在此时，它会从 etcd 中读取各个 node 节点的信息，然后按照一定的算法进行选择，并将结果告知 apiServer</p>
</li>
<li>
<p>apiServer 调用 controller-manager 去调度 Node 节点安装 nginx 服务</p>
</li>
<li>
<p>kubelet 接收到指令后，会通知 docker，然后由 docker 来启动一个 nginx 的 pod</p>
<p>pod 是 kubernetes 的最小操作单元，容器必须跑在 pod 中至此，</p>
</li>
<li>
<p>一个 nginx 服务就运行了，如果需要访问 nginx，就需要通过 kube-proxy 来对 pod 产生访问的代理</p>
</li>
</ol>
<p>这样，外界用户就可以访问集群中的 nginx 服务了</p>
<h4 id="14-kubernetes-概念">1.4 kubernetes 概念</h4>
<p>Master：集群控制节点，每个集群需要至少一个 master 节点负责集群的管控</p>
<p>Node：工作负载节点，由 master 分配容器到这些 node 工作节点上，然后 node 节点上的 docker 负责容器的运行</p>
<p>Pod：kubernetes 的最小控制单元，容器都是运行在 pod 中的，一个 pod 中可以有 1 个或者多个容器</p>
<p>Controller：控制器，通过它来实现对 pod 的管理，比如启动 pod、停止 pod、伸缩 pod 的数量等等</p>
<p>Service：pod 对外服务的统一入口，下面可以维护者同一类的多个 pod</p>
<p>Label：标签，用于对 pod 进行分类，同一类 pod 会拥有相同的标签</p>
<p>NameSpace：命名空间，用来隔离 pod 的运行环境</p>
<h3 id="2-kubernetes-集群环境搭建">2. kubernetes 集群环境搭建</h3>
<h4 id="21-前置知识点">2.1 前置知识点</h4>
<p>目前生产部署 Kubernetes 集群主要有两种方式：</p>
<p>kubeadm</p>
<p>Kubeadm 是一个 K8s 部署工具，提供 kubeadm init 和 kubeadm join，用于快速部署 Kubernetes 集群。</p>
<p>官方地址：<a class="link" href="https:/kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/"  target="_blank" rel="noopener"
    >https:/kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/
    
    <span style="white-space: nowrap;"><svg width=".7em"
        height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
        <path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
        <path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
            fill="currentColor">
    </svg></span>
        
</a></p>
<p>二进制包</p>
<p>从 github 下载发行版的二进制包，手动部署每个组件，组成 Kubernetes 集群。</p>
<p>Kubeadm 降低部署门槛，但屏蔽了很多细节，遇到问题很难排查。如果想更容易可控，推荐使用二进制包部署 Kubernetes 集群，虽然手动部署麻烦点，期间可以学习很多工作原理，也利于后期维护。</p>
<p><a href="/p/2024122601/upload/image-20200404094800622.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200404094800622.png"
	width="1291"
	height="513"
	srcset="/p/2024122601/upload/image-20200404094800622_hu7497210785e8ed04505f91231d980929_13207_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200404094800622_hu7497210785e8ed04505f91231d980929_13207_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200404094800622"
	
>
</a></p>
<h4 id="22-kubeadm-部署方式介绍">2.2 kubeadm 部署方式介绍</h4>
<p>kubeadm 是官方社区推出的一个用于快速部署 kubernetes 集群的工具，这个工具能通过两条指令完成一个 kubernetes 集群的部署：</p>
<ul>
<li>创建一个 Master 节点 kubeadm init</li>
<li>将 Node 节点加入到当前集群中$ kubeadm join &lt;Master 节点的 IP 和端口&gt;</li>
</ul>
<h4 id="23-安装要求">2.3 安装要求</h4>
<p>在开始之前，部署 Kubernetes 集群机器需要满足以下几个条件：</p>
<ul>
<li>一台或多台机器，操作系统 CentOS7.x-86_x64</li>
<li>硬件配置：2GB 或更多 RAM，2 个 CPU 或更多 CPU，硬盘 30GB 或更多</li>
<li>集群中所有机器之间网络互通</li>
<li>可以访问外网，需要拉取镜像</li>
<li>禁止 swap 分区</li>
</ul>
<h4 id="24-最终目标">2.4 最终目标</h4>
<ul>
<li>在所有节点上安装 Docker 和 kubeadm</li>
<li>部署 Kubernetes Master</li>
<li>部署容器网络插件</li>
<li>部署 Kubernetes Node，将节点加入 Kubernetes 集群中</li>
<li>部署 Dashboard Web 页面，可视化查看 Kubernetes 资源</li>
</ul>
<h4 id="25-准备环境">2.5 准备环境</h4>
<p><a href="/p/2024122601/upload/image-20210609000002940.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20210609000002940.png"
	width="662"
	height="455"
	srcset="/p/2024122601/upload/image-20210609000002940_hu2a67abbea270e784bbd793592c859f09_63298_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20210609000002940_hu2a67abbea270e784bbd793592c859f09_63298_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210609000002940"
	
>
</a></p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th style="text-align:left">角色</th>
<th style="text-align:left">IP 地址</th>
<th style="text-align:left">组件</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">master01</td>
<td style="text-align:left">192.168.90.100</td>
<td style="text-align:left">docker，kubectl，kubeadm，kubelet</td>
</tr>
<tr>
<td style="text-align:left">node01</td>
<td style="text-align:left">192.168.90.106</td>
<td style="text-align:left">docker，kubectl，kubeadm，kubelet</td>
</tr>
<tr>
<td style="text-align:left">node02</td>
<td style="text-align:left">192.168.90.107</td>
<td style="text-align:left">docker，kubectl，kubeadm，kubelet</td>
</tr>
</tbody>
</table></div>
<h4 id="26-环境初始化">2.6 环境初始化</h4>
<h5 id="261-检查操作系统的版本">2.6.1 检查操作系统的版本</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># 此方式下安装kubernetes集群要求Centos版本要在7.5或之上</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># cat /etc/redhat-release</span>
</span></span><span class="line"><span class="cl"><span class="n">Centos</span> <span class="n">Linux</span> <span class="mf">7.5</span><span class="p">.</span><span class="py">1804</span> <span class="p">(</span><span class="n">Core</span><span class="p">)</span>
</span></span></code></pre></div><h5 id="262-主机名解析">2.6.2 主机名解析</h5>
<p>为了方便集群节点间的直接调用，在这个配置一下主机名解析，企业中推荐使用内部 DNS 服务器</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># 主机名成解析 编辑三台服务器的/etc/hosts文件，添加下面内容</span>
</span></span><span class="line"><span class="cl"><span class="mf">192.168</span><span class="p">.</span><span class="py">90</span><span class="p">.</span><span class="py">100</span> <span class="n">master</span>
</span></span><span class="line"><span class="cl"><span class="mf">192.168</span><span class="p">.</span><span class="py">90</span><span class="p">.</span><span class="py">106</span> <span class="n">node1</span>
</span></span><span class="line"><span class="cl"><span class="mf">192.168</span><span class="p">.</span><span class="py">90</span><span class="p">.</span><span class="py">107</span> <span class="n">node2</span>
</span></span></code></pre></div><h5 id="263-时间同步">2.6.3 时间同步</h5>
<p>kubernetes 要求集群中的节点时间必须精确一直，这里使用 chronyd 服务从网络同步时间</p>
<p>企业中建议配置内部的会见同步服务器</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># 启动chronyd服务</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># systemctl start chronyd</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># systemctl enable chronyd</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># date</span>
</span></span></code></pre></div><h5 id="264-禁用-iptable-和-firewalld-服务">2.6.4 禁用 iptable 和 firewalld 服务</h5>
<p>kubernetes 和 docker 在运行的中会产生大量的 iptables 规则，为了不让系统规则跟它们混淆，直接关闭系统的规则</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># 1 关闭firewalld服务</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># systemctl stop firewalld</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># systemctl disable firewalld</span>
</span></span><span class="line"><span class="cl"><span class="c"># 2 关闭iptables服务</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># systemctl stop iptables</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># systemctl disable iptables</span>
</span></span></code></pre></div><h5 id="265-禁用-selinux">2.6.5 禁用 selinux</h5>
<p>selinux 是 linux 系统下的一个安全服务，如果不关闭它，在安装集群中会产生各种各样的奇葩问题</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># 编辑 /etc/selinux/config 文件，修改SELINUX的值为disable</span>
</span></span><span class="line"><span class="cl"><span class="c"># 注意修改完毕之后需要重启linux服务</span>
</span></span><span class="line"><span class="cl"><span class="n">SELINUX</span><span class="p">=</span><span class="n">disabled</span>
</span></span></code></pre></div><h5 id="266-禁用-swap-分区">2.6.6 禁用 swap 分区</h5>
<p>swap 分区指的是虚拟内存分区，它的作用是物理内存使用完，之后将磁盘空间虚拟成内存来使用，启用 swap 设备会对系统的性能产生非常负面的影响，因此 kubernetes 要求每个节点都要禁用 swap 设备，但是如果因为某些原因确实不能关闭 swap 分区，就需要在集群安装过程中通过明确的参数进行配置说明</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># 编辑分区配置文件/etc/fstab，注释掉swap分区一行</span>
</span></span><span class="line"><span class="cl"><span class="c"># 注意修改完毕之后需要重启linux服务</span>
</span></span><span class="line"><span class="cl"><span class="n">vim</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">fstab</span>
</span></span><span class="line"><span class="cl"><span class="n">注释掉</span> <span class="p">/</span><span class="n">dev</span><span class="p">/</span><span class="n">mapper</span><span class="p">/</span><span class="nb">centos-swap</span> <span class="n">swap</span>
</span></span><span class="line"><span class="cl"><span class="c"># /dev/mapper/centos-swap swap</span>
</span></span></code></pre></div><h5 id="267-修改-linux-的内核参数">2.6.7 修改 linux 的内核参数</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># 修改linux的内核采纳数，添加网桥过滤和地址转发功能</span>
</span></span><span class="line"><span class="cl"><span class="c"># 编辑/etc/sysctl.d/kubernetes.conf文件，添加如下配置：</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="p">.</span><span class="py">bridge</span><span class="p">.</span><span class="nb">bridge-nf</span><span class="n">-call-ip6tables</span> <span class="p">=</span> <span class="mf">1</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="p">.</span><span class="py">bridge</span><span class="p">.</span><span class="nb">bridge-nf</span><span class="n">-call-iptables</span> <span class="p">=</span> <span class="mf">1</span>
</span></span><span class="line"><span class="cl"><span class="n">net</span><span class="p">.</span><span class="py">ipv4</span><span class="p">.</span><span class="py">ip_forward</span> <span class="p">=</span> <span class="mf">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 重新加载配置</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># sysctl -p</span>
</span></span><span class="line"><span class="cl"><span class="c"># 加载网桥过滤模块</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># modprobe br_netfilter</span>
</span></span><span class="line"><span class="cl"><span class="c"># 查看网桥过滤模块是否加载成功</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># lsmod | grep br_netfilter</span>
</span></span></code></pre></div><h5 id="268-配置-ipvs-功能">2.6.8 配置 ipvs 功能</h5>
<p>在 Kubernetes 中 Service 有两种带来模型，一种是基于 iptables 的，一种是基于 ipvs 的两者比较的话，ipvs 的性能明显要高一些，但是如果要使用它，需要手动载入 ipvs 模块</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># 1.安装ipset和ipvsadm</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># yum install ipset ipvsadm -y</span>
</span></span><span class="line"><span class="cl"><span class="c"># 2.添加需要加载的模块写入脚本文件</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># cat &lt;&lt;EOF&gt; /etc/sysconfig/modules/ipvs.modules</span>
</span></span><span class="line"><span class="cl"><span class="c">#!/bin/bash</span>
</span></span><span class="line"><span class="cl"><span class="n">modprobe</span> <span class="p">--</span> <span class="n">ip_vs</span>
</span></span><span class="line"><span class="cl"><span class="n">modprobe</span> <span class="p">--</span> <span class="n">ip_vs_rr</span>
</span></span><span class="line"><span class="cl"><span class="n">modprobe</span> <span class="p">--</span> <span class="n">ip_vs_wrr</span>
</span></span><span class="line"><span class="cl"><span class="n">modprobe</span> <span class="p">--</span> <span class="n">ip_vs_sh</span>
</span></span><span class="line"><span class="cl"><span class="n">modprobe</span> <span class="p">--</span> <span class="n">nf_conntrack_ipv4</span>
</span></span><span class="line"><span class="cl"><span class="n">EOF</span>
</span></span><span class="line"><span class="cl"><span class="c"># 3.为脚本添加执行权限</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># chmod +x /etc/sysconfig/modules/ipvs.modules</span>
</span></span><span class="line"><span class="cl"><span class="c"># 4.执行脚本文件</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># /bin/bash /etc/sysconfig/modules/ipvs.modules</span>
</span></span><span class="line"><span class="cl"><span class="c"># 5.查看对应的模块是否加载成功</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span>
</span></span></code></pre></div><h5 id="269-安装-docker">2.6.9 安装 docker</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># 1、切换镜像源</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># wget https:/mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 2、查看当前镜像源中支持的docker版本</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># yum list docker-ce --showduplicates</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 3、安装特定版本的docker-ce</span>
</span></span><span class="line"><span class="cl"><span class="c"># 必须制定--setopt=obsoletes=0，否则yum会自动安装更高版本</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># yum install --setopt=obsoletes=0 docker-ce-18.06.3.ce-3.el7 -y</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 4、添加一个配置文件</span>
</span></span><span class="line"><span class="cl"><span class="c">#Docker 在默认情况下使用Vgroup Driver为cgroupfs，而Kubernetes推荐使用systemd来替代cgroupfs</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># mkdir /etc/docker</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># cat &lt;&lt;EOF&gt; /etc/docker/daemon.json</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="s2">&#34;exec-opts&#34;</span><span class="err">:</span> <span class="p">[</span><span class="s2">&#34;native.cgroupdriver=systemd&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl"> <span class="s2">&#34;registry-mirrors&#34;</span><span class="err">:</span> <span class="p">[</span><span class="s2">&#34;https:/kn0t2bca.mirror.aliyuncs.com&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 5、启动dokcer</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># systemctl restart docker</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># systemctl enable docker</span>
</span></span></code></pre></div><h5 id="2610-安装-kubernetes-组件">2.6.10 安装 Kubernetes 组件</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># 1、由于kubernetes的镜像在国外，速度比较慢，这里切换成国内的镜像源</span>
</span></span><span class="line"><span class="cl"><span class="c"># 2、编辑/etc/yum.repos.d/kubernetes.repo,添加下面的配置</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="no">kubernetes</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">name</span><span class="p">=</span><span class="n">Kubernetes</span>
</span></span><span class="line"><span class="cl"><span class="n">baseurl</span><span class="p">=</span><span class="n">http</span><span class="err">:</span><span class="p">/</span><span class="n">mirrors</span><span class="p">.</span><span class="py">aliyun</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">yum</span><span class="p">/</span><span class="n">repos</span><span class="p">/</span><span class="nb">kubernetes-el7</span><span class="n">-x86_64</span>
</span></span><span class="line"><span class="cl"><span class="n">enabled</span><span class="p">=</span><span class="mf">1</span>
</span></span><span class="line"><span class="cl"><span class="n">gpgchech</span><span class="p">=</span><span class="mf">0</span>
</span></span><span class="line"><span class="cl"><span class="n">repo_gpgcheck</span><span class="p">=</span><span class="mf">0</span>
</span></span><span class="line"><span class="cl"><span class="n">gpgkey</span><span class="p">=</span><span class="n">http</span><span class="err">:</span><span class="p">/</span><span class="n">mirrors</span><span class="p">.</span><span class="py">aliyun</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">yum</span><span class="p">/</span><span class="n">doc</span><span class="p">/</span><span class="nb">yum-key</span><span class="p">.</span><span class="py">gpg</span>
</span></span><span class="line"><span class="cl">       <span class="n">http</span><span class="err">:</span><span class="p">/</span><span class="n">mirrors</span><span class="p">.</span><span class="py">aliyun</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">kubernetes</span><span class="p">/</span><span class="n">yum</span><span class="p">/</span><span class="n">doc</span><span class="p">/</span><span class="nb">rpm-package</span><span class="n">-key</span><span class="p">.</span><span class="py">gpg</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 3、安装kubeadm、kubelet和kubectl</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># yum install --setopt=obsoletes=0 kubeadm-1.17.4-0 kubelet-1.17.4-0 kubectl-1.17.4-0 -y</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 4、配置kubelet的cgroup</span>
</span></span><span class="line"><span class="cl"><span class="c">#编辑/etc/sysconfig/kubelet, 添加下面的配置</span>
</span></span><span class="line"><span class="cl"><span class="n">KUBELET_CGROUP_ARGS</span><span class="p">=</span><span class="s2">&#34;--cgroup-driver=systemd&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">KUBE_PROXY_MODE</span><span class="p">=</span><span class="s2">&#34;ipvs&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 5、设置kubelet开机自启</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># systemctl enable kubelet</span>
</span></span></code></pre></div><h5 id="2611-准备集群镜像">2.6.11 准备集群镜像</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># 在安装kubernetes集群之前，必须要提前准备好集群需要的镜像，所需镜像可以通过下面命令查看</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># kubeadm config /upload list</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 下载镜像</span>
</span></span><span class="line"><span class="cl"><span class="c"># 此镜像kubernetes的仓库中，由于网络原因，无法连接，下面提供了一种替换方案</span>
</span></span><span class="line"><span class="cl"><span class="p">/</span><span class="n">upload</span><span class="p">=(</span>
</span></span><span class="line"><span class="cl">  <span class="nb">kube-apiserver</span><span class="err">:</span><span class="n">v1</span><span class="p">.</span><span class="py">17</span><span class="p">.</span><span class="py">4</span>
</span></span><span class="line"><span class="cl">  <span class="nb">kube-controller</span><span class="n">-manager:v1</span><span class="p">.</span><span class="py">17</span><span class="p">.</span><span class="py">4</span>
</span></span><span class="line"><span class="cl">  <span class="nb">kube-scheduler</span><span class="err">:</span><span class="n">v1</span><span class="p">.</span><span class="py">17</span><span class="p">.</span><span class="py">4</span>
</span></span><span class="line"><span class="cl">  <span class="nb">kube-proxy</span><span class="err">:</span><span class="n">v1</span><span class="p">.</span><span class="py">17</span><span class="p">.</span><span class="py">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">pause</span><span class="err">:</span><span class="mf">3.1</span>
</span></span><span class="line"><span class="cl">  <span class="n">etcd</span><span class="err">:</span><span class="mf">3.4</span><span class="p">.</span><span class="mf">3</span><span class="p">-</span><span class="mf">0</span>
</span></span><span class="line"><span class="cl">  <span class="n">coredns</span><span class="err">:</span><span class="mf">1.6</span><span class="p">.</span><span class="py">5</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">imageName</span> <span class="k">in</span> <span class="p">${/</span><span class="n">upload</span><span class="p">[@]};</span><span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="n">docker</span> <span class="n">pull</span> <span class="n">registry</span><span class="p">.</span><span class="nb">cn-hangzhou</span><span class="p">.</span><span class="py">aliyuncs</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="nv">$imageName</span>
</span></span><span class="line"><span class="cl">  <span class="n">docker</span> <span class="n">tag</span> <span class="n">registry</span><span class="p">.</span><span class="nb">cn-hangzhou</span><span class="p">.</span><span class="py">aliyuncs</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="nv">$imageName</span> <span class="n">k8s</span><span class="p">.</span><span class="py">gcr</span><span class="p">.</span><span class="n">io</span><span class="p">/</span><span class="nv">$imageName</span>
</span></span><span class="line"><span class="cl">  <span class="n">docker</span> <span class="n">rmi</span> <span class="n">registry</span><span class="p">.</span><span class="nb">cn-hangzhou</span><span class="p">.</span><span class="py">aliyuncs</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span><span class="p">/</span><span class="nv">$imageName</span>
</span></span><span class="line"><span class="cl"><span class="n">done</span>
</span></span></code></pre></div><h5 id="2611-集群初始化">2.6.11 集群初始化</h5>
<blockquote>
<p>下面的操作只需要在 master 节点上执行即可</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># 创建集群</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># kubeadm init \</span>
</span></span><span class="line"><span class="cl"> <span class="p">-</span><span class="n">-apiserver-advertise-address</span><span class="p">=</span><span class="mf">192.168</span><span class="p">.</span><span class="py">90</span><span class="p">.</span><span class="py">100</span> <span class="p">\</span>
</span></span><span class="line"><span class="cl"> <span class="p">-</span><span class="n">-image-repository</span> <span class="n">registry</span><span class="p">.</span><span class="py">aliyuncs</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">google_containers</span> <span class="p">\</span>
</span></span><span class="line"><span class="cl"> <span class="p">-</span><span class="n">-kubernetes-version</span><span class="p">=</span><span class="n">v1</span><span class="p">.</span><span class="py">17</span><span class="p">.</span><span class="py">4</span> <span class="p">\</span>
</span></span><span class="line"><span class="cl"> <span class="p">-</span><span class="n">-service-cidr</span><span class="p">=</span><span class="mf">10.96</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="mf">0</span><span class="p">/</span><span class="mf">12</span> <span class="p">\</span>
</span></span><span class="line"><span class="cl"> <span class="p">-</span><span class="n">-pod-network-cidr</span><span class="p">=</span><span class="mf">10.244</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="mf">0</span><span class="p">/</span><span class="mf">16</span>
</span></span><span class="line"><span class="cl"><span class="c"># 创建必要文件</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># mkdir -p $HOME/.kube</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># sudo chown $(id -u):$(id -g) $HOME/.kube/config</span>
</span></span></code></pre></div><blockquote>
<p>下面的操作只需要在 node 节点上执行即可</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">kubeadm</span> <span class="n">join</span> <span class="mf">192.168</span><span class="p">.</span><span class="py">0</span><span class="p">.</span><span class="mf">100</span><span class="err">:</span><span class="mf">6443</span> <span class="p">-</span><span class="n">-token</span> <span class="n">awk15p</span><span class="p">.</span><span class="py">t6bamck54w69u4s8</span> <span class="p">\</span>
</span></span><span class="line"><span class="cl">    <span class="p">-</span><span class="n">-discovery-token-ca-cert-hash</span> <span class="n">sha256</span><span class="err">:</span><span class="n">a94fa09562466d32d29523ab6cff122186f1127599fa4dcd5fa0152694f17117</span>
</span></span></code></pre></div><p>在 master 上查看节点信息</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># kubectl get nodes</span>
</span></span><span class="line"><span class="cl"><span class="n">NAME</span>    <span class="n">STATUS</span>   <span class="n">ROLES</span>     <span class="n">AGE</span>   <span class="n">VERSION</span>
</span></span><span class="line"><span class="cl"><span class="n">master</span>  <span class="n">NotReady</span>  <span class="n">master</span>   <span class="mf">6m</span>    <span class="n">v1</span><span class="p">.</span><span class="py">17</span><span class="p">.</span><span class="py">4</span>
</span></span><span class="line"><span class="cl"><span class="n">node1</span>   <span class="n">NotReady</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>  <span class="n">22s</span>   <span class="n">v1</span><span class="p">.</span><span class="py">17</span><span class="p">.</span><span class="py">4</span>
</span></span><span class="line"><span class="cl"><span class="n">node2</span>   <span class="n">NotReady</span>   <span class="p">&lt;</span><span class="n">none</span><span class="p">&gt;</span>  <span class="n">19s</span>   <span class="n">v1</span><span class="p">.</span><span class="py">17</span><span class="p">.</span><span class="py">4</span>
</span></span></code></pre></div><h5 id="2613-安装网络插件只在-master-节点操作即可">2.6.13 安装网络插件，只在 master 节点操作即可</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">wget </span><span class="n">https</span><span class="err">:</span><span class="p">/</span><span class="n">raw</span><span class="p">.</span><span class="py">githubusercontent</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">coreos</span><span class="p">/</span><span class="n">flannel</span><span class="p">/</span><span class="n">master</span><span class="p">/</span><span class="n">Documentation</span><span class="p">/</span><span class="nb">kube-flannel</span><span class="p">.</span><span class="py">yml</span>
</span></span></code></pre></div><p>由于外网不好访问，如果出现无法访问的情况，可以直接用下面的 记得文件名是 kube-flannel.yml，位置：/root/kube-flannel.yml 内容：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">https</span><span class="err">:</span><span class="p">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="nb">flannel-io</span><span class="p">/</span><span class="n">flannel</span><span class="p">/</span><span class="n">tree</span><span class="p">/</span><span class="n">master</span><span class="p">/</span><span class="n">Documentation</span><span class="p">/</span><span class="nb">kube-flannel</span><span class="p">.</span><span class="py">yml</span>
</span></span></code></pre></div><p>也可手动拉取指定版本
docker pull quay.io/coreos/flannel:v0.14.0 #拉取 flannel 网络，三台主机
docker /upload #查看仓库是否拉去下来</p>
<p><code>个人笔记</code>
若是集群状态一直是 notready,用下面语句查看原因，
journalctl -f -u kubelet.service
若原因是： cni.go:237] Unable to update cni config: no networks found in /etc/cni/net.d
mkdir -p /etc/cni/net.d #创建目录给 flannel 做配置文件
vim /etc/cni/net.d/10-flannel.conf #编写配置文件</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="s2">&#34;name&#34;</span><span class="err">:</span><span class="s2">&#34;cbr0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s2">&#34;cniVersion&#34;</span><span class="err">:</span><span class="s2">&#34;0.3.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s2">&#34;type&#34;</span><span class="err">:</span><span class="s2">&#34;flannel&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="s2">&#34;deledate&#34;</span><span class="err">:</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;hairpinMode&#34;</span><span class="err">:</span><span class="n">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;isDefaultGateway&#34;</span><span class="err">:</span><span class="n">true</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h5 id="2614-使用-kubeadm-reset-重置集群">2.6.14 使用 kubeadm reset 重置集群</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-TEXT" data-lang="TEXT"><span class="line"><span class="cl">#在master节点之外的节点进行操作
</span></span><span class="line"><span class="cl">kubeadm reset
</span></span><span class="line"><span class="cl">systemctl stop kubelet
</span></span><span class="line"><span class="cl">systemctl stop docker
</span></span><span class="line"><span class="cl">rm -rf /var/lib/cni/
</span></span><span class="line"><span class="cl">rm -rf /var/lib/kubelet/*
</span></span><span class="line"><span class="cl">rm -rf /etc/cni/
</span></span><span class="line"><span class="cl">ifconfig cni0 down
</span></span><span class="line"><span class="cl">ifconfig flannel.1 down
</span></span><span class="line"><span class="cl">ifconfig docker0 down
</span></span><span class="line"><span class="cl">ip link delete cni0
</span></span><span class="line"><span class="cl">ip link delete flannel.1
</span></span><span class="line"><span class="cl">##重启kubelet
</span></span><span class="line"><span class="cl">systemctl restart kubelet
</span></span><span class="line"><span class="cl">##重启docker
</span></span><span class="line"><span class="cl">systemctl restart docker
</span></span></code></pre></div><h5 id="2615-重启-kubelet-和-docker">2.6.15 重启 kubelet 和 docker</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># 重启kubelet</span>
</span></span><span class="line"><span class="cl"><span class="n">systemctl</span> <span class="n">restart</span> <span class="n">kubelet</span>
</span></span><span class="line"><span class="cl"><span class="c"># 重启docker</span>
</span></span><span class="line"><span class="cl"><span class="n">systemctl</span> <span class="n">restart</span> <span class="n">docker</span>
</span></span></code></pre></div><p>使用配置文件启动 fannel</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="nb">kube-flannel</span><span class="p">.</span><span class="py">yml</span>
</span></span></code></pre></div><p>等待它安装完毕 发现已经是 集群的状态已经是 Ready</p>
<p><a href="/p/2024122601/upload/2232696-20210621233106024-1676033717.png" data-lightbox="image">
<img src="/p/2024122601/upload/2232696-20210621233106024-1676033717.png"
	width="1646"
	height="300"
	srcset="/p/2024122601/upload/2232696-20210621233106024-1676033717_hudc1edee3220eafc7ff2a1754118f8641_37217_480x0_resize_box_3.png 480w, /p/2024122601/upload/2232696-20210621233106024-1676033717_hudc1edee3220eafc7ff2a1754118f8641_37217_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<h5 id="2616-kubeadm-中的命令">2.6.16 kubeadm 中的命令</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># 生成 新的token</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># kubeadm token create --print-join-command</span>
</span></span></code></pre></div><h4 id="27-集群测试">2.7 集群测试</h4>
<h5 id="271-创建一个-nginx-服务">2.7.1 创建一个 nginx 服务</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">kubectl</span> <span class="n">create</span> <span class="n">deployment</span> <span class="n">nginx</span>  <span class="p">-</span><span class="n">-image</span><span class="p">=</span><span class="n">nginx</span><span class="err">:</span><span class="mf">1.14</span><span class="n">-alpine</span>
</span></span></code></pre></div><h5 id="272-暴露端口">2.7.2 暴露端口</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">kubectl</span> <span class="n">expose</span> <span class="n">deploy</span> <span class="n">nginx</span>  <span class="p">-</span><span class="n">-port</span><span class="p">=</span><span class="mf">80</span> <span class="p">-</span><span class="n">-target-port</span><span class="p">=</span><span class="mf">80</span>  <span class="p">-</span><span class="n">-type</span><span class="p">=</span><span class="n">NodePort</span>
</span></span></code></pre></div><h5 id="273-查看服务">2.7.3 查看服务</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">kubectl</span> <span class="n">get</span> <span class="n">pod</span><span class="p">,</span><span class="n">svc</span>
</span></span></code></pre></div><h5 id="274-查看-pod">2.7.4 查看 pod</h5>
<p><a href="/p/2024122601/upload/2232696-20210621233130477-111035427.png" data-lightbox="image">
<img src="/p/2024122601/upload/2232696-20210621233130477-111035427.png"
	width="1919"
	height="560"
	srcset="/p/2024122601/upload/2232696-20210621233130477-111035427_huef3f8647bd6732e9cea5ccdf1bdd4a18_116809_480x0_resize_box_3.png 480w, /p/2024122601/upload/2232696-20210621233130477-111035427_huef3f8647bd6732e9cea5ccdf1bdd4a18_116809_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="2232696-20210621233130477-111035427"
	
>
</a></p>
<p>浏览器测试结果：</p>
<p><a href="/p/2024122601/upload/2232696-20210621233157075-1117518703.png" data-lightbox="image">
<img src="/p/2024122601/upload/2232696-20210621233157075-1117518703.png"
	width="1920"
	height="1542"
	srcset="/p/2024122601/upload/2232696-20210621233157075-1117518703_hu4e3721d85b7bd36f80e83768c9b0d959_125340_480x0_resize_box_3.png 480w, /p/2024122601/upload/2232696-20210621233157075-1117518703_hu4e3721d85b7bd36f80e83768c9b0d959_125340_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<h3 id="3-资源管理">3. 资源管理</h3>
<h4 id="31-资源管理介绍">3.1 资源管理介绍</h4>
<p>在 kubernetes 中，所有的内容都抽象为资源，用户需要通过操作资源来管理 kubernetes。</p>
<blockquote>
<p>kubernetes 的本质上就是一个集群系统，用户可以在集群中部署各种服务，所谓的部署服务，其实就是在 kubernetes 集群中运行一个个的容器，并将指定的程序跑在容器中。</p>
<p>kubernetes 的最小管理单元是 pod 而不是容器，所以只能将容器放在<code>Pod</code>中，而 kubernetes 一般也不会直接管理 Pod，而是通过<code>Pod控制器</code>来管理 Pod 的。</p>
<p>Pod 可以提供服务之后，就要考虑如何访问 Pod 中服务，kubernetes 提供了<code>Service</code>资源实现这个功能。</p>
<p>当然，如果 Pod 中程序的数据需要持久化，kubernetes 还提供了各种<code>存储</code>系统。</p>
</blockquote>
<p><a href="/p/2024122601/upload/image-20200406225334627.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200406225334627.png"
	width="1211"
	height="662"
	srcset="/p/2024122601/upload/image-20200406225334627_hu7dcc47f7ec25fad53f94c265c567920a_33107_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200406225334627_hu7dcc47f7ec25fad53f94c265c567920a_33107_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200406225334627"
	
>
</a></p>
<blockquote>
<p>学习 kubernetes 的核心，就是学习如何对集群上的<code>Pod、Pod控制器、Service、存储</code>等各种资源进行操作</p>
</blockquote>
<h4 id="32-yaml-语言介绍">3.2 YAML 语言介绍</h4>
<p>YAML 是一个类似 XML、JSON 的标记性语言。它强调以数据为中心，并不是以标识语言为重点。因而 YAML 本身的定义比较简单，号称&quot;一种人性化的数据格式语言&quot;。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">heima</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">age</span><span class="p">&gt;</span>15<span class="p">&lt;/</span><span class="nt">age</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">address</span><span class="p">&gt;</span>Beijing<span class="p">&lt;/</span><span class="nt">address</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">heima</span><span class="p">&gt;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">heima:
</span></span><span class="line"><span class="cl">  age: <span class="m">15</span>
</span></span><span class="line"><span class="cl">  address: Beijing
</span></span></code></pre></div><p>YAML 的语法比较简单，主要有下面几个：</p>
<ul>
<li>大小写敏感</li>
<li>使用缩进表示层级关系</li>
<li>缩进不允许使用 tab，只允许空格( 低版本限制 )</li>
<li>缩进的空格数不重要，只要相同层级的元素左对齐即可</li>
<li>&lsquo;#&lsquo;表示注释</li>
</ul>
<p>YAML 支持以下几种数据类型：</p>
<ul>
<li>纯量：单个的、不可再分的值</li>
<li>对象：键值对的集合，又称为映射（mapping）/ 哈希（hash） / 字典（dictionary）</li>
<li>数组：一组按次序排列的值，又称为序列（sequence） / 列表（list）</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># 纯量, 就是指的一个简单的值，字符串、布尔值、整数、浮点数、Null、时间、日期</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 1 布尔类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">c1</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="l">(或者True)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 2 整型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">c2</span><span class="p">:</span><span class="w"> </span><span class="m">234</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 3 浮点型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">c3</span><span class="p">:</span><span class="w"> </span><span class="m">3.14</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 4 null类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">c4</span><span class="p">:</span><span class="w"> </span><span class="l">~</span><span class="w"> </span><span class="c"># 使用~表示null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 5 日期类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">c5</span><span class="p">:</span><span class="w"> </span><span class="ld">2018-02-17</span><span class="w"> </span><span class="c"># 日期必须使用ISO 8601格式，即yyyy-MM-dd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 6 时间类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">c6</span><span class="p">:</span><span class="w"> </span><span class="ld">2018-02-17T15:02:31</span><span class="m">+08</span><span class="p">:</span><span class="m">00</span><span class="w"> </span><span class="c"># 时间使用ISO 8601格式，时间和日期之间使用T连接，最后使用+代表时区</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 7 字符串类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">c7</span><span class="p">:</span><span class="w"> </span><span class="l">heima</span><span class="w"> </span><span class="c"># 简单写法，直接写值 , 如果字符串中间有特殊字符，必须使用双引号或者单引号包裹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">c8</span><span class="p">:</span><span class="w"> </span><span class="l">line1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">line2</span><span class="w"> </span><span class="c"># 字符串过多的情况可以拆成多行，每一行会被转化成一个空格</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># 对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 形式一(推荐):</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">heima</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">age</span><span class="p">:</span><span class="w"> </span><span class="m">15</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l">Beijing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 形式二(了解):</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">heima</span><span class="p">:</span><span class="w"> </span>{<span class="nt">age: 15,address</span><span class="p">:</span><span class="w"> </span><span class="l">Beijing}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># 数组</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 形式一(推荐):</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">address</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">顺义</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">昌平</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 形式二(了解):</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">顺义,昌平]</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p>小提示：</p>
<p>1 书写 yaml 切记<code>:</code> 后面要加一个空格</p>
<p>2 如果需要将多段 yaml 配置放在一个文件中，中间要使用<code>---</code>分隔</p>
<p>3 下面是一个 yaml 转 json 的网站，可以通过它验证 yaml 是否书写正确
<a class="link" href="https:/www.json2yaml.com/convert-yaml-to-json"  target="_blank" rel="noopener"
    >https:/www.json2yaml.com/convert-yaml-to-json
    
    <span style="white-space: nowrap;"><svg width=".7em"
        height=".7em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg">
        <path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
        <path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
            fill="currentColor">
    </svg></span>
        
</a></p>
</blockquote>
<h4 id="33-资源管理方式">3.3 资源管理方式</h4>
<ul>
<li>
<p>命令式对象管理：直接使用命令去操作 kubernetes 资源</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">kubectl</span> <span class="n">run</span> <span class="nb">nginx-pod</span> <span class="p">-</span><span class="n">-image</span><span class="p">=</span><span class="n">nginx</span><span class="err">:</span><span class="mf">1.17</span><span class="p">.</span><span class="py">1</span> <span class="p">-</span><span class="n">-port</span><span class="p">=</span><span class="mf">80</span>
</span></span></code></pre></div></li>
<li>
<p>命令式对象配置：通过命令配置和配置文件去操作 kubernetes 资源</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">kubectl</span> <span class="n">create</span><span class="p">/</span><span class="n">patch</span> <span class="o">-f</span> <span class="nb">nginx-pod</span><span class="p">.</span><span class="py">yaml</span>
</span></span></code></pre></div></li>
<li>
<p>声明式对象配置：通过 apply 命令和配置文件去操作 kubernetes 资源</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-f</span> <span class="nb">nginx-pod</span><span class="p">.</span><span class="py">yaml</span>
</span></span></code></pre></div></li>
</ul>
<div class="table-wrapper"><table>
<thead>
<tr>
<th style="text-align:left">类型</th>
<th style="text-align:left">操作对象</th>
<th style="text-align:left">适用环境</th>
<th style="text-align:left">优点</th>
<th style="text-align:left">缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">命令式对象管理</td>
<td style="text-align:left">对象</td>
<td style="text-align:left">测试</td>
<td style="text-align:left">简单</td>
<td style="text-align:left">只能操作活动对象，无法审计、跟踪</td>
</tr>
<tr>
<td style="text-align:left">命令式对象配置</td>
<td style="text-align:left">文件</td>
<td style="text-align:left">开发</td>
<td style="text-align:left">可以审计、跟踪</td>
<td style="text-align:left">项目大时，配置文件多，操作麻烦</td>
</tr>
<tr>
<td style="text-align:left">声明式对象配置</td>
<td style="text-align:left">目录</td>
<td style="text-align:left">开发</td>
<td style="text-align:left">支持目录操作</td>
<td style="text-align:left">意外情况下难以调试</td>
</tr>
</tbody>
</table></div>
<h5 id="331-命令式对象管理">3.3.1 命令式对象管理</h5>
<p>kubectl 命令</p>
<p>kubectl 是 kubernetes 集群的命令行工具，通过它能够对集群本身进行管理，并能够在集群上进行容器化应用的安装部署。kubectl 命令的语法如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl <span class="o">[</span>command<span class="o">]</span> <span class="o">[</span>type<span class="o">]</span> <span class="o">[</span>name<span class="o">]</span> <span class="o">[</span>flags<span class="o">]</span>
</span></span></code></pre></div><p>comand：指定要对资源执行的操作，例如 create、get、delete</p>
<p>type：指定资源类型，比如 deployment、pod、service</p>
<p>name：指定资源的名称，名称大小写敏感</p>
<p>flags：指定额外的可选参数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 查看所有pod</span>
</span></span><span class="line"><span class="cl">kubectl get pod
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看某个pod</span>
</span></span><span class="line"><span class="cl">kubectl get pod pod_name
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看某个pod,以yaml格式展示结果</span>
</span></span><span class="line"><span class="cl">kubectl get pod pod_name -o yaml
</span></span></code></pre></div><p>资源类型</p>
<p>kubernetes 中所有的内容都抽象为资源，可以通过下面的命令进行查看:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl api-resources
</span></span></code></pre></div><p>经常使用的资源有下面这些：</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th style="text-align:left">资源分类</th>
<th style="text-align:left">资源名称</th>
<th style="text-align:left">缩写</th>
<th style="text-align:left">资源作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">集群级别资源</td>
<td style="text-align:left">nodes</td>
<td style="text-align:left">no</td>
<td style="text-align:left">集群组成部分</td>
</tr>
<tr>
<td style="text-align:left">namespaces</td>
<td style="text-align:left">ns</td>
<td style="text-align:left">隔离 Pod</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">pod 资源</td>
<td style="text-align:left">pods</td>
<td style="text-align:left">po</td>
<td style="text-align:left">装载容器</td>
</tr>
<tr>
<td style="text-align:left">pod 资源控制器</td>
<td style="text-align:left">replicationcontrollers</td>
<td style="text-align:left">rc</td>
<td style="text-align:left">控制 pod 资源</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">replicasets</td>
<td style="text-align:left">rs</td>
<td style="text-align:left">控制 pod 资源</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">deployments</td>
<td style="text-align:left">deploy</td>
<td style="text-align:left">控制 pod 资源</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">daemonsets</td>
<td style="text-align:left">ds</td>
<td style="text-align:left">控制 pod 资源</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">jobs</td>
<td style="text-align:left"></td>
<td style="text-align:left">控制 pod 资源</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">cronjobs</td>
<td style="text-align:left">cj</td>
<td style="text-align:left">控制 pod 资源</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">horizontalpodautoscalers</td>
<td style="text-align:left">hpa</td>
<td style="text-align:left">控制 pod 资源</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">statefulsets</td>
<td style="text-align:left">sts</td>
<td style="text-align:left">控制 pod 资源</td>
</tr>
<tr>
<td style="text-align:left">服务发现资源</td>
<td style="text-align:left">services</td>
<td style="text-align:left">svc</td>
<td style="text-align:left">统一 pod 对外接口</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">ingress</td>
<td style="text-align:left">ing</td>
<td style="text-align:left">统一 pod 对外接口</td>
</tr>
<tr>
<td style="text-align:left">存储资源</td>
<td style="text-align:left">volumeattachments</td>
<td style="text-align:left"></td>
<td style="text-align:left">存储</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">persistentvolumes</td>
<td style="text-align:left">pv</td>
<td style="text-align:left">存储</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">persistentvolumeclaims</td>
<td style="text-align:left">pvc</td>
<td style="text-align:left">存储</td>
</tr>
<tr>
<td style="text-align:left">配置资源</td>
<td style="text-align:left">configmaps</td>
<td style="text-align:left">cm</td>
<td style="text-align:left">配置</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">secrets</td>
<td style="text-align:left"></td>
<td style="text-align:left">配置</td>
</tr>
</tbody>
</table></div>
<p>操作</p>
<p>kubernetes 允许对资源进行多种操作，可以通过&ndash;help 查看详细的操作命令</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl --help
</span></span></code></pre></div><p>经常使用的操作有下面这些：</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th style="text-align:left">命令分类</th>
<th style="text-align:left">命令</th>
<th style="text-align:left">翻译</th>
<th style="text-align:left">命令作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">基本命令</td>
<td style="text-align:left">create</td>
<td style="text-align:left">创建</td>
<td style="text-align:left">创建一个资源</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">edit</td>
<td style="text-align:left">编辑</td>
<td style="text-align:left">编辑一个资源</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">get</td>
<td style="text-align:left">获取</td>
<td style="text-align:left">获取一个资源</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">patch</td>
<td style="text-align:left">更新</td>
<td style="text-align:left">更新一个资源</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">delete</td>
<td style="text-align:left">删除</td>
<td style="text-align:left">删除一个资源</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">explain</td>
<td style="text-align:left">解释</td>
<td style="text-align:left">展示资源文档</td>
</tr>
<tr>
<td style="text-align:left">运行和调试</td>
<td style="text-align:left">run</td>
<td style="text-align:left">运行</td>
<td style="text-align:left">在集群中运行一个指定的镜像</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">expose</td>
<td style="text-align:left">暴露</td>
<td style="text-align:left">暴露资源为 Service</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">describe</td>
<td style="text-align:left">描述</td>
<td style="text-align:left">显示资源内部信息</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">logs</td>
<td style="text-align:left">日志输出容器在 pod 中的日志</td>
<td style="text-align:left">输出容器在 pod 中的日志</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">attach</td>
<td style="text-align:left">缠绕进入运行中的容器</td>
<td style="text-align:left">进入运行中的容器</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">exec</td>
<td style="text-align:left">执行容器中的一个命令</td>
<td style="text-align:left">执行容器中的一个命令</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">cp</td>
<td style="text-align:left">复制</td>
<td style="text-align:left">在 Pod 内外复制文件</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">rollout</td>
<td style="text-align:left">首次展示</td>
<td style="text-align:left">管理资源的发布</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">scale</td>
<td style="text-align:left">规模</td>
<td style="text-align:left">扩(缩)容 Pod 的数量</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">autoscale</td>
<td style="text-align:left">自动调整</td>
<td style="text-align:left">自动调整 Pod 的数量</td>
</tr>
<tr>
<td style="text-align:left">高级命令</td>
<td style="text-align:left">apply</td>
<td style="text-align:left">rc</td>
<td style="text-align:left">通过文件对资源进行配置</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">label</td>
<td style="text-align:left">标签</td>
<td style="text-align:left">更新资源上的标签</td>
</tr>
<tr>
<td style="text-align:left">其他命令</td>
<td style="text-align:left">cluster-info</td>
<td style="text-align:left">集群信息</td>
<td style="text-align:left">显示集群信息</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">version</td>
<td style="text-align:left">版本</td>
<td style="text-align:left">显示当前 Server 和 Client 的版本</td>
</tr>
</tbody>
</table></div>
<p>下面以一个 namespace / pod 的创建和删除简单演示下命令的使用：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建一个namespace</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl create namespace dev</span>
</span></span><span class="line"><span class="cl">namespace/dev created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 获取namespace</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl get ns</span>
</span></span><span class="line"><span class="cl">NAME              STATUS   AGE
</span></span><span class="line"><span class="cl">default           Active   21h
</span></span><span class="line"><span class="cl">dev               Active   21s
</span></span><span class="line"><span class="cl">kube-node-lease   Active   21h
</span></span><span class="line"><span class="cl">kube-public       Active   21h
</span></span><span class="line"><span class="cl">kube-system       Active   21h
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 在此namespace下创建并运行一个nginx的Pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl run pod --image=nginx:latest -n dev</span>
</span></span><span class="line"><span class="cl">kubectl run --generator<span class="o">=</span>deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator<span class="o">=</span>run-pod/v1 or kubectl create instead.
</span></span><span class="line"><span class="cl">deployment.apps/pod created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看新创建的pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl get pod -n dev</span>
</span></span><span class="line"><span class="cl">NAME  READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod   1/1     Running   <span class="m">0</span>          21s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 删除指定的pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl delete pod pod-864f9875b9-pcw7x</span>
</span></span><span class="line"><span class="cl">pod <span class="s2">&#34;pod&#34;</span> deleted
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 删除指定的namespace</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl delete ns dev</span>
</span></span><span class="line"><span class="cl">namespace <span class="s2">&#34;dev&#34;</span> deleted
</span></span></code></pre></div><h3 id="332-命令式对象配置">3.3.2 命令式对象配置</h3>
<p>命令式对象配置就是使用命令配合配置文件一起来操作 kubernetes 资源。</p>
<p>1） 创建一个 nginxpod.yaml，内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Namespace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginxpod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-containers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:latest</span><span class="w">
</span></span></span></code></pre></div><p>2）执行 create 命令，创建资源：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="nv">@master</span> <span class="p">~]</span><span class="c"># kubectl create -f nginxpod.yaml</span>
</span></span><span class="line"><span class="cl"><span class="n">namespace</span><span class="p">/</span><span class="n">dev</span> <span class="n">created</span>
</span></span><span class="line"><span class="cl"><span class="n">pod</span><span class="p">/</span><span class="n">nginxpod</span> <span class="n">created</span>
</span></span></code></pre></div><p>此时发现创建了两个资源对象，分别是 namespace 和 pod</p>
<p>3）执行 get 命令，查看资源：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1">#  kubectl get -f nginxpod.yaml</span>
</span></span><span class="line"><span class="cl">NAME            STATUS   AGE
</span></span><span class="line"><span class="cl">namespace/dev   Active   18s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME            READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod/nginxpod    1/1     Running   <span class="m">0</span>          17s
</span></span></code></pre></div><p>这样就显示了两个资源对象的信息</p>
<p>4）执行 delete 命令，删除资源：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl delete -f nginxpod.yaml</span>
</span></span><span class="line"><span class="cl">namespace <span class="s2">&#34;dev&#34;</span> deleted
</span></span><span class="line"><span class="cl">pod <span class="s2">&#34;nginxpod&#34;</span> deleted
</span></span></code></pre></div><p>此时发现两个资源对象被删除了</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">总结:
</span></span><span class="line"><span class="cl">    命令式对象配置的方式操作资源，可以简单的认为：命令  +  yaml配置文件（里面是命令需要的各种参数）
</span></span></code></pre></div><h3 id="333-声明式对象配置">3.3.3 声明式对象配置</h3>
<p>声明式对象配置跟命令式对象配置很相似，但是它只有一个命令 apply。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 首先执行一次kubectl apply -f yaml文件，发现创建了资源</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1">#  kubectl apply -f nginxpod.yaml</span>
</span></span><span class="line"><span class="cl">namespace/dev created
</span></span><span class="line"><span class="cl">pod/nginxpod created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 再次执行一次kubectl apply -f yaml文件，发现说资源没有变动</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1">#  kubectl apply -f nginxpod.yaml</span>
</span></span><span class="line"><span class="cl">namespace/dev unchanged
</span></span><span class="line"><span class="cl">pod/nginxpod unchanged
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">总结</span><span class="err">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">其实声明式对象配置就是使用apply描述一个资源最终的状态</span><span class="err">（</span><span class="n">在yaml中定义状态</span><span class="err">）</span>
</span></span><span class="line"><span class="cl">    <span class="n">使用apply操作资源</span><span class="err">：</span>
</span></span><span class="line"><span class="cl">        <span class="n">如果资源不存在</span><span class="err">，</span><span class="n">就创建</span><span class="err">，</span><span class="n">相当于</span> <span class="n">kubectl</span> <span class="n">create</span>
</span></span><span class="line"><span class="cl">        <span class="n">如果资源已存在</span><span class="err">，</span><span class="n">就更新</span><span class="err">，</span><span class="n">相当于</span> <span class="n">kubectl</span> <span class="n">patch</span>
</span></span></code></pre></div><blockquote>
<p>扩展：kubectl 可以在 node 节点上运行吗 ?</p>
</blockquote>
<p>kubectl 的运行是需要进行配置的，它的配置文件是$HOME/.kube，如果想要在 node 节点运行此命令，需要将 master 上的.kube 文件复制到 node 节点上，即在 master 节点上执行下面操作：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">scp  -r  HOME/.kube   node1: HOME/
</span></span></code></pre></div><blockquote>
<p>使用推荐: 三种方式应该怎么用 ?</p>
</blockquote>
<p>创建/更新资源 使用声明式对象配置 kubectl apply -f XXX.yaml</p>
<p>删除资源 使用命令式对象配置 kubectl delete -f XXX.yaml</p>
<p>查询资源 使用命令式对象管理 kubectl get(describe) 资源名称</p>
<h3 id="4-实战入门">4. 实战入门</h3>
<p>本章节将介绍如何在 kubernetes 集群中部署一个 nginx 服务，并且能够对其进行访问。</p>
<h4 id="41-namespace">4.1 Namespace</h4>
<p>Namespace 是 kubernetes 系统中的一种非常重要资源，它的主要作用是用来实现多套环境的资源隔离或者多租户的资源隔离。</p>
<p>默认情况下，kubernetes 集群中的所有的 Pod 都是可以相互访问的。但是在实际中，可能不想让两个 Pod 之间进行互相的访问，那此时就可以将两个 Pod 划分到不同的 namespace 下。kubernetes 通过将集群内部的资源分配到不同的 Namespace 中，可以形成逻辑上的&quot;组&quot;，以方便不同的组的资源进行隔离使用和管理。</p>
<p>可以通过 kubernetes 的授权机制，将不同的 namespace 交给不同租户进行管理，这样就实现了多租户的资源隔离。此时还能结合 kubernetes 的资源配额机制，限定不同租户能占用的资源，例如 CPU 使用量、内存使用量等等，来实现租户可用资源的管理。</p>
<p><a href="/p/2024122601/upload/image-20200407100850484.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200407100850484.png"
	width="1097"
	height="572"
	srcset="/p/2024122601/upload/image-20200407100850484_hu29816599a7e39bfe417cc2f6835a17f8_24989_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200407100850484_hu29816599a7e39bfe417cc2f6835a17f8_24989_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200407100850484"
	
>
</a></p>
<p>kubernetes 在集群启动之后，会默认创建几个 namespace</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl  get namespace</span>
</span></span><span class="line"><span class="cl">NAME              STATUS   AGE
</span></span><span class="line"><span class="cl">default           Active   45h     <span class="c1">#  所有未指定Namespace的对象都会被分配在default命名空间</span>
</span></span><span class="line"><span class="cl">kube-node-lease   Active   45h     <span class="c1">#  集群节点之间的心跳维护，v1.13开始引入</span>
</span></span><span class="line"><span class="cl">kube-public       Active   45h     <span class="c1">#  此命名空间下的资源可以被所有人访问（包括未认证用户）</span>
</span></span><span class="line"><span class="cl">kube-system       Active   45h     <span class="c1">#  所有由Kubernetes系统创建的资源都处于这个命名空间</span>
</span></span></code></pre></div><p>下面来看 namespace 资源的具体操作：</p>
<h5 id="411-查看">4.1.1 查看</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 1 查看所有的ns  命令：kubectl get ns</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl get ns</span>
</span></span><span class="line"><span class="cl">NAME              STATUS   AGE
</span></span><span class="line"><span class="cl">default           Active   45h
</span></span><span class="line"><span class="cl">kube-node-lease   Active   45h
</span></span><span class="line"><span class="cl">kube-public       Active   45h
</span></span><span class="line"><span class="cl">kube-system       Active   45h
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 2 查看指定的ns   命令：kubectl get ns ns名称</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl get ns default</span>
</span></span><span class="line"><span class="cl">NAME      STATUS   AGE
</span></span><span class="line"><span class="cl">default   Active   45h
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 3 指定输出格式  命令：kubectl get ns ns名称  -o 格式参数</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kubernetes支持的格式有很多，比较常见的是wide、json、yaml</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl get ns default -o yaml</span>
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Namespace
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  creationTimestamp: <span class="s2">&#34;2021-05-08T04:44:16Z&#34;</span>
</span></span><span class="line"><span class="cl">  name: default
</span></span><span class="line"><span class="cl">  resourceVersion: <span class="s2">&#34;151&#34;</span>
</span></span><span class="line"><span class="cl">  selfLink: /api/v1/namespaces/default
</span></span><span class="line"><span class="cl">  uid: 7405f73a-e486-43d4-9db6-145f1409f090
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  finalizers:
</span></span><span class="line"><span class="cl">  - kubernetes
</span></span><span class="line"><span class="cl">status:
</span></span><span class="line"><span class="cl">  phase: Active
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 4 查看ns详情  命令：kubectl describe ns ns名称</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl describe ns default</span>
</span></span><span class="line"><span class="cl">Name:         default
</span></span><span class="line"><span class="cl">Labels:       &lt;none&gt;
</span></span><span class="line"><span class="cl">Annotations:  &lt;none&gt;
</span></span><span class="line"><span class="cl">Status:       Active  <span class="c1"># Active 命名空间正在使用中  Terminating 正在删除命名空间</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ResourceQuota 针对namespace做的资源限制</span>
</span></span><span class="line"><span class="cl"><span class="c1"># LimitRange针对namespace中的每个组件做的资源限制</span>
</span></span><span class="line"><span class="cl">No resource quota.
</span></span><span class="line"><span class="cl">No LimitRange resource.
</span></span></code></pre></div><h5 id="412-创建">4.1.2 创建</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建namespace</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl create ns dev</span>
</span></span><span class="line"><span class="cl">namespace/dev created
</span></span></code></pre></div><h5 id="413-删除">4.1.3 删除</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 删除namespace</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl delete ns dev</span>
</span></span><span class="line"><span class="cl">namespace <span class="s2">&#34;dev&#34;</span> deleted
</span></span></code></pre></div><h5 id="414-配置方式">4.1.4 配置方式</h5>
<p>首先准备一个 yaml 文件：ns-dev.yaml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Namespace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span></code></pre></div><p>然后就可以执行对应的创建和删除命令了：</p>
<p>创建：kubectl create -f ns-dev.yaml</p>
<p>删除：kubectl delete -f ns-dev.yaml</p>
<h4 id="42-pod">4.2 Pod</h4>
<p>Pod 是 kubernetes 集群进行管理的最小单元，程序要运行必须部署在容器中，而容器必须存在于 Pod 中。</p>
<p>Pod 可以认为是容器的封装，一个 Pod 中可以存在一个或者多个容器。</p>
<p><a href="/p/2024122601/upload/image-20200407121501907.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200407121501907.png"
	width="633"
	height="464"
	srcset="/p/2024122601/upload/image-20200407121501907_hu4b6c2b72f6eb47e56733106ea15da30d_9266_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200407121501907_hu4b6c2b72f6eb47e56733106ea15da30d_9266_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200407121501907"
	
>
</a></p>
<p>kubernetes 在集群启动之后，集群中的各个组件也都是以 Pod 方式运行的。可以通过下面命令查看：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl get pod -n kube-system</span>
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">kube-system   coredns-6955765f44-68g6v         1/1     Running   <span class="m">0</span>          2d1h
</span></span><span class="line"><span class="cl">kube-system   coredns-6955765f44-cs5r8         1/1     Running   <span class="m">0</span>          2d1h
</span></span><span class="line"><span class="cl">kube-system   etcd-master                      1/1     Running   <span class="m">0</span>          2d1h
</span></span><span class="line"><span class="cl">kube-system   kube-apiserver-master            1/1     Running   <span class="m">0</span>          2d1h
</span></span><span class="line"><span class="cl">kube-system   kube-controller-manager-master   1/1     Running   <span class="m">0</span>          2d1h
</span></span><span class="line"><span class="cl">kube-system   kube-flannel-ds-amd64-47r25      1/1     Running   <span class="m">0</span>          2d1h
</span></span><span class="line"><span class="cl">kube-system   kube-flannel-ds-amd64-ls5lh      1/1     Running   <span class="m">0</span>          2d1h
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-685tk                 1/1     Running   <span class="m">0</span>          2d1h
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-87spt                 1/1     Running   <span class="m">0</span>          2d1h
</span></span><span class="line"><span class="cl">kube-system   kube-scheduler-master            1/1     Running   <span class="m">0</span>          2d1h
</span></span></code></pre></div><h5 id="421-创建并运行">4.2.1 创建并运行</h5>
<p>kubernetes 没有提供单独运行 Pod 的命令，都是通过 Pod 控制器来实现的</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 命令格式： kubectl run (pod控制器名称) [参数]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --image  指定Pod的镜像</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --port   指定端口</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --namespace  指定namespace</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl run nginx --image=nginx:latest --port=80 --namespace dev</span>
</span></span><span class="line"><span class="cl">deployment.apps/nginx created
</span></span></code></pre></div><h5 id="422-查看-pod-信息">4.2.2 查看 pod 信息</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 查看Pod基本信息</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">NAME    READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">nginx   1/1     Running   <span class="m">0</span>          43s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看Pod的详细信息</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl describe pod nginx -n dev</span>
</span></span><span class="line"><span class="cl">Name:         nginx
</span></span><span class="line"><span class="cl">Namespace:    dev
</span></span><span class="line"><span class="cl">Priority:     <span class="m">0</span>
</span></span><span class="line"><span class="cl">Node:         node1/192.168.5.4
</span></span><span class="line"><span class="cl">Start Time:   Wed, <span class="m">08</span> May <span class="m">2021</span> 09:29:24 +0800
</span></span><span class="line"><span class="cl">Labels:       pod-template-hash<span class="o">=</span>5ff7956ff6
</span></span><span class="line"><span class="cl">              <span class="nv">run</span><span class="o">=</span>nginx
</span></span><span class="line"><span class="cl">Annotations:  &lt;none&gt;
</span></span><span class="line"><span class="cl">Status:       Running
</span></span><span class="line"><span class="cl">IP:           10.244.1.23
</span></span><span class="line"><span class="cl">IPs:
</span></span><span class="line"><span class="cl">  IP:           10.244.1.23
</span></span><span class="line"><span class="cl">Controlled By:  ReplicaSet/nginx
</span></span><span class="line"><span class="cl">Containers:
</span></span><span class="line"><span class="cl">  nginx:
</span></span><span class="line"><span class="cl">    Container ID:   docker:/4c62b8c0648d2512380f4ffa5da2c99d16e05634979973449c98e9b829f6253c
</span></span><span class="line"><span class="cl">    Image:          nginx:latest
</span></span><span class="line"><span class="cl">    Image ID:       docker-pullable:/nginx@sha256:485b610fefec7ff6c463ced9623314a04ed67e3945b9c08d7e53a47f6d108dc7
</span></span><span class="line"><span class="cl">    Port:           80/TCP
</span></span><span class="line"><span class="cl">    Host Port:      0/TCP
</span></span><span class="line"><span class="cl">    State:          Running
</span></span><span class="line"><span class="cl">      Started:      Wed, <span class="m">08</span> May <span class="m">2021</span> 09:30:01 +0800
</span></span><span class="line"><span class="cl">    Ready:          True
</span></span><span class="line"><span class="cl">    Restart Count:  <span class="m">0</span>
</span></span><span class="line"><span class="cl">    Environment:    &lt;none&gt;
</span></span><span class="line"><span class="cl">    Mounts:
</span></span><span class="line"><span class="cl">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-hwvvw <span class="o">(</span>ro<span class="o">)</span>
</span></span><span class="line"><span class="cl">Conditions:
</span></span><span class="line"><span class="cl">  Type              Status
</span></span><span class="line"><span class="cl">  Initialized       True
</span></span><span class="line"><span class="cl">  Ready             True
</span></span><span class="line"><span class="cl">  ContainersReady   True
</span></span><span class="line"><span class="cl">  PodScheduled      True
</span></span><span class="line"><span class="cl">Volumes:
</span></span><span class="line"><span class="cl">  default-token-hwvvw:
</span></span><span class="line"><span class="cl">    Type:        Secret <span class="o">(</span>a volume populated by a Secret<span class="o">)</span>
</span></span><span class="line"><span class="cl">    SecretName:  default-token-hwvvw
</span></span><span class="line"><span class="cl">    Optional:    <span class="nb">false</span>
</span></span><span class="line"><span class="cl">QoS Class:       BestEffort
</span></span><span class="line"><span class="cl">Node-Selectors:  &lt;none&gt;
</span></span><span class="line"><span class="cl">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="k">for</span> 300s
</span></span><span class="line"><span class="cl">                 node.kubernetes.io/unreachable:NoExecute <span class="k">for</span> 300s
</span></span><span class="line"><span class="cl">Events:
</span></span><span class="line"><span class="cl">  Type    Reason     Age        From               Message
</span></span><span class="line"><span class="cl">  ----    ------     ----       ----               -------
</span></span><span class="line"><span class="cl">  Normal  Scheduled  &lt;unknown&gt;  default-scheduler  Successfully assigned dev/nginx-5ff7956ff6-fg2db to node1
</span></span><span class="line"><span class="cl">  Normal  Pulling    4m11s      kubelet, node1     Pulling image <span class="s2">&#34;nginx:latest&#34;</span>
</span></span><span class="line"><span class="cl">  Normal  Pulled     3m36s      kubelet, node1     Successfully pulled image <span class="s2">&#34;nginx:latest&#34;</span>
</span></span><span class="line"><span class="cl">  Normal  Created    3m36s      kubelet, node1     Created container nginx
</span></span><span class="line"><span class="cl">  Normal  Started    3m36s      kubelet, node1     Started container nginx
</span></span></code></pre></div><h5 id="423-访问-pod">4.2.3 访问 Pod</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 获取podIP</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME    READY   STATUS    RESTARTS   AGE    IP             NODE    ...
</span></span><span class="line"><span class="cl">nginx   1/1     Running   <span class="m">0</span>          190s   10.244.1.23   node1   ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#访问POD</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># curl http:/10.244.1.23:80</span>
</span></span><span class="line"><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="cl"> &lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span></span><span class="line"><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="cl"> &lt;p&gt;&lt;em&gt;Thank you <span class="k">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span class="line"><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><h5 id="424-删除指定-pod">4.2.4 删除指定 Pod</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 删除指定Pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl delete pod nginx -n dev</span>
</span></span><span class="line"><span class="cl">pod <span class="s2">&#34;nginx&#34;</span> deleted
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 此时，显示删除Pod成功，但是再查询，发现又新产生了一个</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">NAME    READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">nginx   1/1     Running   <span class="m">0</span>          21s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 这是因为当前Pod是由Pod控制器创建的，控制器会监控Pod状况，一旦发现Pod死亡，会立即重建</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 此时要想删除Pod，必须删除Pod控制器</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 先来查询一下当前namespace下的Pod控制器</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl get deploy -n  dev</span>
</span></span><span class="line"><span class="cl">NAME    READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">nginx   1/1     <span class="m">1</span>            <span class="m">1</span>           9m7s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 接下来，删除此PodPod控制器</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl delete deploy nginx -n dev</span>
</span></span><span class="line"><span class="cl">deployment.apps <span class="s2">&#34;nginx&#34;</span> deleted
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 稍等片刻，再查询Pod，发现Pod被删除了</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">No resources found in dev namespace.
</span></span></code></pre></div><h5 id="425-配置操作">4.2.5 配置操作</h5>
<p>创建一个 pod-nginx.yaml，内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span></code></pre></div><p>然后就可以执行对应的创建和删除命令了：</p>
<p>创建：kubectl create -f pod-nginx.yaml</p>
<p>删除：kubectl delete -f pod-nginx.yaml</p>
<h4 id="43-label">4.3 Label</h4>
<p>Label 是 kubernetes 系统中的一个重要概念。它的作用就是在资源上添加标识，用来对它们进行区分和选择。</p>
<p>Label 的特点：</p>
<ul>
<li>一个 Label 会以 key/value 键值对的形式附加到各种对象上，如 Node、Pod、Service 等等</li>
<li>一个资源对象可以定义任意数量的 Label ，同一个 Label 也可以被添加到任意数量的资源对象上去</li>
<li>Label 通常在资源对象定义时确定，当然也可以在对象创建后动态添加或者删除</li>
</ul>
<p>可以通过 Label 实现资源的多维度分组，以便灵活、方便地进行资源分配、调度、配置、部署等管理工作。</p>
<blockquote>
<p>一些常用的 Label 示例如下：</p>
<ul>
<li>版本标签：&ldquo;version&rdquo;:&ldquo;release&rdquo;, &ldquo;version&rdquo;:&ldquo;stable&rdquo;&hellip;&hellip;</li>
<li>环境标签：&ldquo;environment&rdquo;:&ldquo;dev&rdquo;，&ldquo;environment&rdquo;:&ldquo;test&rdquo;，&ldquo;environment&rdquo;:&ldquo;pro&rdquo;</li>
<li>架构标签：&ldquo;tier&rdquo;:&ldquo;frontend&rdquo;，&ldquo;tier&rdquo;:&ldquo;backend&rdquo;</li>
</ul>
</blockquote>
<p>标签定义完毕之后，还要考虑到标签的选择，这就要使用到 Label Selector，即：</p>
<p>Label 用于给某个资源对象定义标识</p>
<p>Label Selector 用于查询和筛选拥有某些标签的资源对象</p>
<p>当前有两种 Label Selector：</p>
<ul>
<li>
<p>基于等式的 Label Selector</p>
<p>name = slave: 选择所有包含 Label 中 key=&ldquo;name&quot;且 value=&ldquo;slave&quot;的对象</p>
<p>env != production: 选择所有包括 Label 中的 key=&ldquo;env&quot;且 value 不等于&quot;production&quot;的对象</p>
</li>
<li>
<p>基于集合的 Label Selector</p>
<p>name in (master, slave): 选择所有包含 Label 中的 key=&ldquo;name&quot;且 value=&ldquo;master&quot;或&quot;slave&quot;的对象</p>
<p>name not in (frontend): 选择所有包含 Label 中的 key=&ldquo;name&quot;且 value 不等于&quot;frontend&quot;的对象</p>
</li>
</ul>
<p>标签的选择条件可以使用多个，此时将多个 Label Selector 进行组合，使用逗号&rdquo;,&ldquo;进行分隔即可。例如：</p>
<p>name=slave，env!=production</p>
<p>name not in (frontend)，env!=production</p>
<h5 id="431-命令方式">4.3.1 命令方式</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 为pod资源打标签</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl label pod nginx-pod version=1.0 -n dev</span>
</span></span><span class="line"><span class="cl">pod/nginx-pod labeled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 为pod资源更新标签</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl label pod nginx-pod version=2.0 -n dev --overwrite</span>
</span></span><span class="line"><span class="cl">pod/nginx-pod labeled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看标签</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl get pod nginx-pod  -n dev --show-labels</span>
</span></span><span class="line"><span class="cl">NAME        READY   STATUS    RESTARTS   AGE   LABELS
</span></span><span class="line"><span class="cl">nginx-pod   1/1     Running   <span class="m">0</span>          10m   <span class="nv">version</span><span class="o">=</span>2.0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 筛选标签</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl get pod -n dev -l version=2.0  --show-labels</span>
</span></span><span class="line"><span class="cl">NAME        READY   STATUS    RESTARTS   AGE   LABELS
</span></span><span class="line"><span class="cl">nginx-pod   1/1     Running   <span class="m">0</span>          17m   <span class="nv">version</span><span class="o">=</span>2.0
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl get pod -n dev -l version!=2.0 --show-labels</span>
</span></span><span class="line"><span class="cl">No resources found in dev namespace.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#删除标签</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl label pod nginx-pod -n dev tier-</span>
</span></span><span class="line"><span class="cl">pod/nginx unlabeled
</span></span></code></pre></div><h5 id="432-配置方式">4.3.2 配置方式</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3.0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;test&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span></code></pre></div><p>然后就可以执行对应的更新命令了：kubectl apply -f pod-nginx.yaml</p>
<h4 id="44-deployment">4.4 Deployment</h4>
<p>在 kubernetes 中，Pod 是最小的控制单元，但是 kubernetes 很少直接控制 Pod，一般都是通过 Pod 控制器来完成的。Pod 控制器用于 pod 的管理，确保 pod 资源符合预期的状态，当 pod 的资源出现故障时，会尝试进行重启或重建 pod。</p>
<p>在 kubernetes 中 Pod 控制器的种类有很多，本章节只介绍一种：Deployment。</p>
<p><a href="/p/2024122601/upload/image-20200408193950807.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200408193950807.png"
	width="765"
	height="418"
	srcset="/p/2024122601/upload/image-20200408193950807_hu55eaa9ebc72218328245b6fb3b8caed7_21713_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200408193950807_hu55eaa9ebc72218328245b6fb3b8caed7_21713_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200408193950807"
	
>
</a></p>
<h5 id="441-命令操作">4.4.1 命令操作</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 命令格式: kubectl create deployment 名称  [参数]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --image  指定pod的镜像</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --port   指定端口</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --replicas  指定创建pod数量</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --namespace  指定namespace</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl run nginx --image=nginx:latest --port=80 --replicas=3 -n dev</span>
</span></span><span class="line"><span class="cl">deployment.apps/nginx created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看创建的Pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">NAME                     READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">nginx-5ff7956ff6-6k8cb   1/1     Running   <span class="m">0</span>          19s
</span></span><span class="line"><span class="cl">nginx-5ff7956ff6-jxfjt   1/1     Running   <span class="m">0</span>          19s
</span></span><span class="line"><span class="cl">nginx-5ff7956ff6-v6jqw   1/1     Running   <span class="m">0</span>          19s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看deployment的信息</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl get deploy -n dev</span>
</span></span><span class="line"><span class="cl">NAME    READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">nginx   3/3     <span class="m">3</span>            <span class="m">3</span>           2m42s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># UP-TO-DATE：成功升级的副本数量</span>
</span></span><span class="line"><span class="cl"><span class="c1"># AVAILABLE：可用副本的数量</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl get deploy -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME    READY UP-TO-DATE  AVAILABLE   AGE     CONTAINERS   IMAGES              SELECTOR
</span></span><span class="line"><span class="cl">nginx   3/3     <span class="m">3</span>         <span class="m">3</span>           2m51s   nginx        nginx:latest        <span class="nv">run</span><span class="o">=</span>nginx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看deployment的详细信息</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl describe deploy nginx -n dev</span>
</span></span><span class="line"><span class="cl">Name:                   nginx
</span></span><span class="line"><span class="cl">Namespace:              dev
</span></span><span class="line"><span class="cl">CreationTimestamp:      Wed, <span class="m">08</span> May <span class="m">2021</span> 11:14:14 +0800
</span></span><span class="line"><span class="cl">Labels:                 <span class="nv">run</span><span class="o">=</span>nginx
</span></span><span class="line"><span class="cl">Annotations:            deployment.kubernetes.io/revision: <span class="m">1</span>
</span></span><span class="line"><span class="cl">Selector:               <span class="nv">run</span><span class="o">=</span>nginx
</span></span><span class="line"><span class="cl">Replicas:               <span class="m">3</span> desired <span class="p">|</span> <span class="m">3</span> updated <span class="p">|</span> <span class="m">3</span> total <span class="p">|</span> <span class="m">3</span> available <span class="p">|</span> <span class="m">0</span> unavailable
</span></span><span class="line"><span class="cl">StrategyType:           RollingUpdate
</span></span><span class="line"><span class="cl">MinReadySeconds:        <span class="m">0</span>
</span></span><span class="line"><span class="cl">RollingUpdateStrategy:  25% max unavailable, 25% max 违规词汇
</span></span><span class="line"><span class="cl">Pod Template:
</span></span><span class="line"><span class="cl">  Labels:  <span class="nv">run</span><span class="o">=</span>nginx
</span></span><span class="line"><span class="cl">  Containers:
</span></span><span class="line"><span class="cl">   nginx:
</span></span><span class="line"><span class="cl">    Image:        nginx:latest
</span></span><span class="line"><span class="cl">    Port:         80/TCP
</span></span><span class="line"><span class="cl">    Host Port:    0/TCP
</span></span><span class="line"><span class="cl">    Environment:  &lt;none&gt;
</span></span><span class="line"><span class="cl">    Mounts:       &lt;none&gt;
</span></span><span class="line"><span class="cl">  Volumes:        &lt;none&gt;
</span></span><span class="line"><span class="cl">Conditions:
</span></span><span class="line"><span class="cl">  Type           Status  Reason
</span></span><span class="line"><span class="cl">  ----           ------  ------
</span></span><span class="line"><span class="cl">  Available      True    MinimumReplicasAvailable
</span></span><span class="line"><span class="cl">  Progressing    True    NewReplicaSetAvailable
</span></span><span class="line"><span class="cl">OldReplicaSets:  &lt;none&gt;
</span></span><span class="line"><span class="cl">NewReplicaSet:   nginx-5ff7956ff6 <span class="o">(</span>3/3 replicas created<span class="o">)</span>
</span></span><span class="line"><span class="cl">Events:
</span></span><span class="line"><span class="cl">  Type    Reason             Age    From                   Message
</span></span><span class="line"><span class="cl">  ----    ------             ----   ----                   -------
</span></span><span class="line"><span class="cl">  Normal  ScalingReplicaSet  5m43s  deployment-controller  Scaled up replicaset nginx-5ff7956ff6 to <span class="m">3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 删除</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl delete deploy nginx -n dev</span>
</span></span><span class="line"><span class="cl">deployment.apps <span class="s2">&#34;nginx&#34;</span> deleted
</span></span></code></pre></div><h5 id="442-配置操作">4.4.2 配置操作</h5>
<p>创建一个 deploy-nginx.yaml，内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span></code></pre></div><p>然后就可以执行对应的创建和删除命令了：</p>
<p>创建：kubectl create -f deploy-nginx.yaml</p>
<p>删除：kubectl delete -f deploy-nginx.yaml</p>
<h4 id="45-service">4.5 Service</h4>
<p>通过上节课的学习，已经能够利用 Deployment 来创建一组 Pod 来提供具有高可用性的服务。</p>
<p>虽然每个 Pod 都会分配一个单独的 Pod IP，然而却存在如下两问题：</p>
<ul>
<li>Pod IP 会随着 Pod 的重建产生变化</li>
<li>Pod IP 仅仅是集群内可见的虚拟 IP，外部无法访问</li>
</ul>
<p>这样对于访问这个服务带来了难度。因此，kubernetes 设计了 Service 来解决这个问题。</p>
<p>Service 可以看作是一组同类 Pod 对外的访问接口。借助 Service，应用可以方便地实现服务发现和负载均衡。</p>
<p><a href="/p/2024122601/upload/image-20200408194716912.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200408194716912.png"
	width="1073"
	height="497"
	srcset="/p/2024122601/upload/image-20200408194716912_hu232d859215d5eb5856fe94011ddc048b_36041_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200408194716912_hu232d859215d5eb5856fe94011ddc048b_36041_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200408194716912"
	
>
</a></p>
<h5 id="451-创建集群内部可访问的-service">4.5.1 创建集群内部可访问的 Service</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 暴露Service</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl expose deploy nginx --name=svc-nginx1 --type=ClusterIP --port=80 --target-port=80 -n dev</span>
</span></span><span class="line"><span class="cl">service/svc-nginx1 exposed
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看service</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl get svc svc-nginx1 -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE     SELECTOR
</span></span><span class="line"><span class="cl">svc-nginx1   ClusterIP   10.109.179.231   &lt;none&gt;        80/TCP    3m51s   <span class="nv">run</span><span class="o">=</span>nginx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 这里产生了一个CLUSTER-IP，这就是service的IP，在Service的生命周期中，这个地址是不会变动的</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 可以通过这个IP访问当前service对应的POD</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># curl 10.109.179.231:80</span>
</span></span><span class="line"><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="cl">&lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span></span><span class="line"><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="cl">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
</span></span><span class="line"><span class="cl">.......
</span></span><span class="line"><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></div><h5 id="452-创建集群外部也可访问的-service">4.5.2 创建集群外部也可访问的 Service</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 上面创建的Service的type类型为ClusterIP，这个ip地址只用集群内部可访问</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 如果需要创建外部也可以访问的Service，需要修改type为NodePort</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl expose deploy nginx --name=svc-nginx2 --type=NodePort --port=80 --target-port=80 -n dev</span>
</span></span><span class="line"><span class="cl">service/svc-nginx2 exposed
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 此时查看，会发现出现了NodePort类型的Service，而且有一对Port（80:31928/TC）</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl get svc  svc-nginx2  -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>        AGE    SELECTOR
</span></span><span class="line"><span class="cl">svc-nginx2    NodePort    10.100.94.0      &lt;none&gt;        80:31928/TCP   9s     <span class="nv">run</span><span class="o">=</span>nginx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 接下来就可以通过集群外的主机访问 节点IP:31928访问服务了</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 例如在的电脑主机上通过浏览器访问下面的地址</span>
</span></span><span class="line"><span class="cl">http:/192.168.90.100:31928/
</span></span></code></pre></div><h5 id="453-删除-service">4.5.3 删除 Service</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl delete svc svc-nginx-1 -n dev</span>
</span></span><span class="line"><span class="cl">service <span class="s2">&#34;svc-nginx-1&#34;</span> deleted
</span></span></code></pre></div><h5 id="454-配置方式">4.5.4 配置方式</h5>
<p>创建一个 svc-nginx.yaml，内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">svc-nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clusterIP</span><span class="p">:</span><span class="w"> </span><span class="m">10.109.179.231</span><span class="w"> </span><span class="c">#固定svc的内网ip</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span></code></pre></div><p>然后就可以执行对应的创建和删除命令了：</p>
<p>创建：kubectl create -f svc-nginx.yaml</p>
<p>删除：kubectl delete -f svc-nginx.yaml</p>
<blockquote>
<p>小结</p>
<p>至此，已经掌握了 Namespace、Pod、Deployment、Service 资源的基本操作，有了这些操作，就可以在 kubernetes 集群中实现一个服务的简单部署和访问了，但是如果想要更好的使用 kubernetes，就需要深入学习这几种资源的细节和原理。</p>
</blockquote>
<h3 id="5-pod-详解">5. Pod 详解</h3>
<h4 id="51-pod-介绍">5.1 Pod 介绍</h4>
<h5 id="511-pod-结构">5.1.1 Pod 结构</h5>
<p><a href="/p/2024122601/upload/image-20200407121501907-1626781151898.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200407121501907-1626781151898.png"
	width="633"
	height="464"
	srcset="/p/2024122601/upload/image-20200407121501907-1626781151898_hu4b6c2b72f6eb47e56733106ea15da30d_9266_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200407121501907-1626781151898_hu4b6c2b72f6eb47e56733106ea15da30d_9266_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200407121501907"
	
>
</a></p>
<p>每个 Pod 中都可以包含一个或者多个容器，这些容器可以分为两类：</p>
<ul>
<li>
<p>用户程序所在的容器，数量可多可少</p>
</li>
<li>
<p>Pause 容器，这是每个 Pod 都会有的一个根容器，它的作用有两个：</p>
<ul>
<li>
<p>可以以它为依据，评估整个 Pod 的健康状态</p>
</li>
<li>
<p>可以在根容器上设置 Ip 地址，其它容器都此 Ip（Pod IP），以实现 Pod 内部的网路通信</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">这里是Pod内部的通讯，Pod的之间的通讯采用虚拟二层网络技术来实现，我们当前环境用的是Flannel
</span></span></code></pre></div></li>
</ul>
</li>
</ul>
<h5 id="512-pod-定义">5.1.2 Pod 定义</h5>
<p>下面是 Pod 的资源清单：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">apiVersion: v1     <span class="c1">#必选，版本号，例如v1</span>
</span></span><span class="line"><span class="cl">kind: Pod       　 <span class="c1">#必选，资源类型，例如 Pod</span>
</span></span><span class="line"><span class="cl">metadata:       　 <span class="c1">#必选，元数据</span>
</span></span><span class="line"><span class="cl">  name: string     <span class="c1">#必选，Pod名称</span>
</span></span><span class="line"><span class="cl">  namespace: string  <span class="c1">#Pod所属的命名空间,默认为&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">  labels:       　　  <span class="c1">#自定义标签列表</span>
</span></span><span class="line"><span class="cl">    - name: string      　
</span></span><span class="line"><span class="cl">spec:  <span class="c1">#必选，Pod中容器的详细定义</span>
</span></span><span class="line"><span class="cl">  containers:  <span class="c1">#必选，Pod中容器列表</span>
</span></span><span class="line"><span class="cl">  - name: string   <span class="c1">#必选，容器名称</span>
</span></span><span class="line"><span class="cl">    image: string  <span class="c1">#必选，容器的镜像名称</span>
</span></span><span class="line"><span class="cl">    imagePullPolicy: <span class="o">[</span> Always<span class="p">|</span>Never<span class="p">|</span>IfNotPresent <span class="o">]</span>  <span class="c1">#获取镜像的策略</span>
</span></span><span class="line"><span class="cl">    command: <span class="o">[</span>string<span class="o">]</span>   <span class="c1">#容器的启动命令列表，如不指定，使用打包时使用的启动命令</span>
</span></span><span class="line"><span class="cl">    args: <span class="o">[</span>string<span class="o">]</span>      <span class="c1">#容器的启动命令参数列表</span>
</span></span><span class="line"><span class="cl">    workingDir: string  <span class="c1">#容器的工作目录</span>
</span></span><span class="line"><span class="cl">    volumeMounts:       <span class="c1">#挂载到容器内部的存储卷配置</span>
</span></span><span class="line"><span class="cl">    - name: string      <span class="c1">#引用pod定义的共享存储卷的名称，需用volumes[]部分定义的的卷名</span>
</span></span><span class="line"><span class="cl">      mountPath: string <span class="c1">#存储卷在容器内mount的绝对路径，应少于512字符</span>
</span></span><span class="line"><span class="cl">      readOnly: boolean <span class="c1">#是否为只读模式</span>
</span></span><span class="line"><span class="cl">    ports: <span class="c1">#需要暴露的端口库号列表</span>
</span></span><span class="line"><span class="cl">    - name: string        <span class="c1">#端口的名称</span>
</span></span><span class="line"><span class="cl">      containerPort: int  <span class="c1">#容器需要监听的端口号</span>
</span></span><span class="line"><span class="cl">      hostPort: int       <span class="c1">#容器所在主机需要监听的端口号，默认与Container相同</span>
</span></span><span class="line"><span class="cl">      protocol: string    <span class="c1">#端口协议，支持TCP和UDP，默认TCP</span>
</span></span><span class="line"><span class="cl">    env:   <span class="c1">#容器运行前需设置的环境变量列表</span>
</span></span><span class="line"><span class="cl">    - name: string  <span class="c1">#环境变量名称</span>
</span></span><span class="line"><span class="cl">      value: string <span class="c1">#环境变量的值</span>
</span></span><span class="line"><span class="cl">    resources: <span class="c1">#资源限制和请求的设置</span>
</span></span><span class="line"><span class="cl">      limits:  <span class="c1">#资源限制的设置</span>
</span></span><span class="line"><span class="cl">        cpu: string     <span class="c1">#Cpu的限制，单位为core数，将用于docker run --cpu-shares参数</span>
</span></span><span class="line"><span class="cl">        memory: string  <span class="c1">#内存限制，单位可以为Mib/Gib，将用于docker run --memory参数</span>
</span></span><span class="line"><span class="cl">      requests: <span class="c1">#资源请求的设置</span>
</span></span><span class="line"><span class="cl">        cpu: string    <span class="c1">#Cpu请求，容器启动的初始可用数量</span>
</span></span><span class="line"><span class="cl">        memory: string <span class="c1">#内存请求,容器启动的初始可用数量</span>
</span></span><span class="line"><span class="cl">    lifecycle: <span class="c1">#生命周期钩子</span>
</span></span><span class="line"><span class="cl">        postStart: <span class="c1">#容器启动后立即执行此钩子,如果执行失败,会根据重启策略进行重启</span>
</span></span><span class="line"><span class="cl">        preStop: <span class="c1">#容器终止前执行此钩子,无论结果如何,容器都会终止</span>
</span></span><span class="line"><span class="cl">    livenessProbe:  <span class="c1">#对Pod内各容器健康检查的设置，当探测无响应几次后将自动重启该容器</span>
</span></span><span class="line"><span class="cl">      exec:       　 <span class="c1">#对Pod容器内检查方式设置为exec方式</span>
</span></span><span class="line"><span class="cl">        command: <span class="o">[</span>string<span class="o">]</span>  <span class="c1">#exec方式需要制定的命令或脚本</span>
</span></span><span class="line"><span class="cl">      httpGet:       <span class="c1">#对Pod内个容器健康检查方法设置为HttpGet，需要制定Path、port</span>
</span></span><span class="line"><span class="cl">        path: string
</span></span><span class="line"><span class="cl">        port: number
</span></span><span class="line"><span class="cl">        host: string
</span></span><span class="line"><span class="cl">        scheme: string
</span></span><span class="line"><span class="cl">        HttpHeaders:
</span></span><span class="line"><span class="cl">        - name: string
</span></span><span class="line"><span class="cl">          value: string
</span></span><span class="line"><span class="cl">      tcpSocket:     <span class="c1">#对Pod内个容器健康检查方式设置为tcpSocket方式</span>
</span></span><span class="line"><span class="cl">         port: number
</span></span><span class="line"><span class="cl">       initialDelaySeconds: <span class="m">0</span>       <span class="c1">#容器启动完成后首次探测的时间，单位为秒</span>
</span></span><span class="line"><span class="cl">       timeoutSeconds: <span class="m">0</span>    　　    <span class="c1">#对容器健康检查探测等待响应的超时时间，单位秒，默认1秒</span>
</span></span><span class="line"><span class="cl">       periodSeconds: <span class="m">0</span>     　　    <span class="c1">#对容器监控检查的定期探测时间设置，单位秒，默认10秒一次</span>
</span></span><span class="line"><span class="cl">       successThreshold: <span class="m">0</span>
</span></span><span class="line"><span class="cl">       failureThreshold: <span class="m">0</span>
</span></span><span class="line"><span class="cl">       securityContext:
</span></span><span class="line"><span class="cl">         privileged: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">  restartPolicy: <span class="o">[</span>Always <span class="p">|</span> Never <span class="p">|</span> OnFailure<span class="o">]</span>  <span class="c1">#Pod的重启策略</span>
</span></span><span class="line"><span class="cl">  nodeName: &lt;string&gt; <span class="c1">#设置NodeName表示将该Pod调度到指定到名称的node节点上</span>
</span></span><span class="line"><span class="cl">  nodeSelector: obeject <span class="c1">#设置NodeSelector表示将该Pod调度到包含这个label的node上</span>
</span></span><span class="line"><span class="cl">  imagePullSecrets: <span class="c1">#Pull镜像时使用的secret名称，以key：secretkey格式指定</span>
</span></span><span class="line"><span class="cl">  - name: string
</span></span><span class="line"><span class="cl">  hostNetwork: <span class="nb">false</span>   <span class="c1">#是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络</span>
</span></span><span class="line"><span class="cl">  volumes:   <span class="c1">#在该pod上定义共享存储卷列表</span>
</span></span><span class="line"><span class="cl">  - name: string    <span class="c1">#共享存储卷名称 （volumes类型有很多种）</span>
</span></span><span class="line"><span class="cl">    emptyDir: <span class="o">{}</span>       <span class="c1">#类型为emtyDir的存储卷，与Pod同生命周期的一个临时目录。为空值</span>
</span></span><span class="line"><span class="cl">    hostPath: string   <span class="c1">#类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录</span>
</span></span><span class="line"><span class="cl">      path: string      　　        <span class="c1">#Pod所在宿主机的目录，将被用于同期中mount的目录</span>
</span></span><span class="line"><span class="cl">    secret:       　　　<span class="c1">#类型为secret的存储卷，挂载集群与定义的secret对象到容器内部</span>
</span></span><span class="line"><span class="cl">      scretname: string
</span></span><span class="line"><span class="cl">      items:
</span></span><span class="line"><span class="cl">      - key: string
</span></span><span class="line"><span class="cl">        path: string
</span></span><span class="line"><span class="cl">    configMap:         <span class="c1">#类型为configMap的存储卷，挂载预定义的configMap对象到容器内部</span>
</span></span><span class="line"><span class="cl">      name: string
</span></span><span class="line"><span class="cl">      items:
</span></span><span class="line"><span class="cl">      - key: string
</span></span><span class="line"><span class="cl">        path: string
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1">#小提示：</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   在这里，可通过一个命令来查看每种资源的可配置项</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   kubectl explain 资源类型         查看某种资源可以配置的一级属性</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   kubectl explain 资源类型.属性     查看属性的子属性</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl explain pod</span>
</span></span><span class="line"><span class="cl">KIND:     Pod
</span></span><span class="line"><span class="cl">VERSION:  v1
</span></span><span class="line"><span class="cl">FIELDS:
</span></span><span class="line"><span class="cl">   apiVersion   &lt;string&gt;
</span></span><span class="line"><span class="cl">   kind &lt;string&gt;
</span></span><span class="line"><span class="cl">   metadata     &lt;Object&gt;
</span></span><span class="line"><span class="cl">   spec &lt;Object&gt;
</span></span><span class="line"><span class="cl">   status       &lt;Object&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl explain pod.metadata</span>
</span></span><span class="line"><span class="cl">KIND:     Pod
</span></span><span class="line"><span class="cl">VERSION:  v1
</span></span><span class="line"><span class="cl">RESOURCE: metadata &lt;Object&gt;
</span></span><span class="line"><span class="cl">FIELDS:
</span></span><span class="line"><span class="cl">   annotations  &lt;map<span class="o">[</span>string<span class="o">]</span>string&gt;
</span></span><span class="line"><span class="cl">   clusterName  &lt;string&gt;
</span></span><span class="line"><span class="cl">   creationTimestamp    &lt;string&gt;
</span></span><span class="line"><span class="cl">   deletionGracePeriodSeconds   &lt;integer&gt;
</span></span><span class="line"><span class="cl">   deletionTimestamp    &lt;string&gt;
</span></span><span class="line"><span class="cl">   finalizers   &lt;<span class="o">[]</span>string&gt;
</span></span><span class="line"><span class="cl">   generateName &lt;string&gt;
</span></span><span class="line"><span class="cl">   generation   &lt;integer&gt;
</span></span><span class="line"><span class="cl">   labels       &lt;map<span class="o">[</span>string<span class="o">]</span>string&gt;
</span></span><span class="line"><span class="cl">   managedFields        &lt;<span class="o">[]</span>Object&gt;
</span></span><span class="line"><span class="cl">   name &lt;string&gt;
</span></span><span class="line"><span class="cl">   namespace    &lt;string&gt;
</span></span><span class="line"><span class="cl">   ownerReferences      &lt;<span class="o">[]</span>Object&gt;
</span></span><span class="line"><span class="cl">   resourceVersion      &lt;string&gt;
</span></span><span class="line"><span class="cl">   selfLink     &lt;string&gt;
</span></span><span class="line"><span class="cl">   uid  &lt;string&gt;
</span></span></code></pre></div><p>在 kubernetes 中基本所有资源的一级属性都是一样的，主要包含 5 部分：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">- apiVersion &lt;string&gt; 版本，由kubernetes内部定义，版本号必须可以用 kubectl api-versions 查询到
</span></span><span class="line"><span class="cl">- kind &lt;string&gt; 类型，由kubernetes内部定义，版本号必须可以用 kubectl api-resources 查询到
</span></span><span class="line"><span class="cl">- metadata &lt;Object&gt; 元数据，主要是资源标识和说明，常用的有name、namespace、labels等
</span></span><span class="line"><span class="cl">- spec &lt;Object&gt; 描述，这是配置中最重要的一部分，里面是对各种资源配置的详细描述
</span></span><span class="line"><span class="cl">- status &lt;Object&gt; 状态信息，里面的内容不需要定义，由kubernetes自动生成
</span></span></code></pre></div><p>在上面的属性中，spec 是接下来研究的重点，继续看下它的常见子属性:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">- containers &lt;[]Object&gt; 容器列表，用于定义容器的详细信息
</span></span><span class="line"><span class="cl">- nodeName &lt;String&gt; 根据nodeName的值将pod调度到指定的Node节点上
</span></span><span class="line"><span class="cl">- nodeSelector &lt;map[]&gt; 根据NodeSelector中定义的信息选择将该Pod调度到包含这些label的Node 上
</span></span><span class="line"><span class="cl">- hostNetwork &lt;boolean&gt; 是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络
</span></span><span class="line"><span class="cl">- volumes &lt;[]Object&gt; 存储卷，用于定义Pod上面挂在的存储信息
</span></span><span class="line"><span class="cl">- restartPolicy &lt;string&gt; 重启策略，表示Pod在遇到故障的时候的处理策略
</span></span></code></pre></div><h4 id="52-pod-配置">5.2 Pod 配置</h4>
<p>本小节主要来研究<code>pod.spec.containers</code>属性，这也是 pod 配置中最为关键的一项配置。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl explain pod.spec.containers</span>
</span></span><span class="line"><span class="cl">KIND:     Pod
</span></span><span class="line"><span class="cl">VERSION:  v1
</span></span><span class="line"><span class="cl">RESOURCE: containers &lt;<span class="o">[]</span>Object&gt;   <span class="c1"># 数组，代表可以有多个容器</span>
</span></span><span class="line"><span class="cl">FIELDS:
</span></span><span class="line"><span class="cl">   name  &lt;string&gt;     <span class="c1"># 容器名称</span>
</span></span><span class="line"><span class="cl">   image &lt;string&gt;     <span class="c1"># 容器需要的镜像地址</span>
</span></span><span class="line"><span class="cl">   imagePullPolicy  &lt;string&gt; <span class="c1"># 镜像拉取策略</span>
</span></span><span class="line"><span class="cl">   <span class="nb">command</span>  &lt;<span class="o">[]</span>string&gt; <span class="c1"># 容器的启动命令列表，如不指定，使用打包时使用的启动命令</span>
</span></span><span class="line"><span class="cl">   args     &lt;<span class="o">[]</span>string&gt; <span class="c1"># 容器的启动命令需要的参数列表</span>
</span></span><span class="line"><span class="cl">   env      &lt;<span class="o">[]</span>Object&gt; <span class="c1"># 容器环境变量的配置</span>
</span></span><span class="line"><span class="cl">   ports    &lt;<span class="o">[]</span>Object&gt;     <span class="c1"># 容器需要暴露的端口号列表</span>
</span></span><span class="line"><span class="cl">   resources &lt;Object&gt;      <span class="c1"># 资源限制和资源请求的设置</span>
</span></span></code></pre></div><h5 id="521-基本配置">5.2.1 基本配置</h5>
<p>创建 pod-base.yaml 文件，内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-base</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l">heima</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.30</span><span class="w">
</span></span></span></code></pre></div><p><a href="/p/2024122601/upload/image-20210617223823675-1626781695411.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20210617223823675-1626781695411.png"
	width="429"
	height="66"
	srcset="/p/2024122601/upload/image-20210617223823675-1626781695411_hu004a406dd2c1b522df52cf3113122869_14073_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20210617223823675-1626781695411_hu004a406dd2c1b522df52cf3113122869_14073_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210617223823675"
	
>
</a></p>
<p>上面定义了一个比较简单 Pod 的配置，里面有两个容器：</p>
<ul>
<li>nginx：用 1.17.1 版本的 nginx 镜像创建，（nginx 是一个轻量级 web 容器）</li>
<li>busybox：用 1.30 版本的 busybox 镜像创建，（busybox 是一个小巧的 linux 命令集合）</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建Pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 pod<span class="o">]</span><span class="c1"># kubectl apply -f pod-base.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-base created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看Pod状况</span>
</span></span><span class="line"><span class="cl"><span class="c1"># READY 1/2 : 表示当前Pod中有2个容器，其中1个准备就绪，1个未就绪</span>
</span></span><span class="line"><span class="cl"><span class="c1"># RESTARTS  : 重启次数，因为有1个容器故障了，Pod一直在重启试图恢复它</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 pod<span class="o">]</span><span class="c1"># kubectl get pod -n dev</span>
</span></span><span class="line"><span class="cl">NAME       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod-base   1/2     Running   <span class="m">4</span>          95s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 可以通过describe查看内部的详情</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 此时已经运行起来了一个基本的Pod，虽然它暂时有问题</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 pod<span class="o">]</span><span class="c1"># kubectl describe pod pod-base -n dev</span>
</span></span></code></pre></div><h5 id="522-镜像拉取">5.2.2 镜像拉取</h5>
<p>创建 pod-imagepullpolicy.yaml 文件，内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-imagepullpolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span><span class="w"> </span><span class="c"># 用于设置镜像拉取策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.30</span><span class="w">
</span></span></span></code></pre></div><p><a href="/p/2024122601/upload/image-20210617223923659.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20210617223923659.png"
	width="495"
	height="79"
	srcset="/p/2024122601/upload/image-20210617223923659_hu11376629a4b7af5af946b2339f38a229_17613_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20210617223923659_hu11376629a4b7af5af946b2339f38a229_17613_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210617223923659"
	
>
</a></p>
<p>imagePullPolicy，用于设置镜像拉取策略，kubernetes 支持配置三种拉取策略：</p>
<ul>
<li>Always：总是从远程仓库拉取镜像（一直远程下载）</li>
<li>IfNotPresent：本地有则使用本地镜像，本地没有则从远程仓库拉取镜像（本地有就本地 本地没远程下载）</li>
<li>Never：只使用本地镜像，从不去远程仓库拉取，本地没有就报错 （一直使用本地）</li>
</ul>
<blockquote>
<p>默认值说明：</p>
<p>如果镜像 tag 为具体版本号， 默认策略是：IfNotPresent</p>
<p>如果镜像 tag 为：latest（最终版本） ，默认策略是 always</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建Pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 pod<span class="o">]</span><span class="c1"># kubectl create -f pod-imagepullpolicy.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-imagepullpolicy created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看Pod详情</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 此时明显可以看到nginx镜像有一步Pulling image &#34;nginx:1.17.1&#34;的过程</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 pod<span class="o">]</span><span class="c1"># kubectl describe pod pod-imagepullpolicy -n dev</span>
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">Events:
</span></span><span class="line"><span class="cl">  Type     Reason     Age               From               Message
</span></span><span class="line"><span class="cl">  ----     ------     ----              ----               -------
</span></span><span class="line"><span class="cl">  Normal   Scheduled  &lt;unknown&gt;         default-scheduler  Successfully assigned dev/pod-imagePullPolicy to node1
</span></span><span class="line"><span class="cl">  Normal   Pulling    32s               kubelet, node1     Pulling image <span class="s2">&#34;nginx:1.17.1&#34;</span>
</span></span><span class="line"><span class="cl">  Normal   Pulled     26s               kubelet, node1     Successfully pulled image <span class="s2">&#34;nginx:1.17.1&#34;</span>
</span></span><span class="line"><span class="cl">  Normal   Created    26s               kubelet, node1     Created container nginx
</span></span><span class="line"><span class="cl">  Normal   Started    25s               kubelet, node1     Started container nginx
</span></span><span class="line"><span class="cl">  Normal   Pulled     7s <span class="o">(</span>x3 over 25s<span class="o">)</span>  kubelet, node1     Container image <span class="s2">&#34;busybox:1.30&#34;</span> already present on machine
</span></span><span class="line"><span class="cl">  Normal   Created    7s <span class="o">(</span>x3 over 25s<span class="o">)</span>  kubelet, node1     Created container busybox
</span></span><span class="line"><span class="cl">  Normal   Started    7s <span class="o">(</span>x3 over 25s<span class="o">)</span>  kubelet, node1     Started container busybox
</span></span></code></pre></div><h5 id="523-启动命令">5.2.3 启动命令</h5>
<p>在前面的案例中，一直有一个问题没有解决，就是的 busybox 容器一直没有成功运行，那么到底是什么原因导致这个容器的故障呢？</p>
<p>原来 busybox 并不是一个程序，而是类似于一个工具类的集合，kubernetes 集群启动管理后，它会自动关闭。解决方法就是让其一直在运行，这就用到了 command 配置。</p>
<p>创建 pod-command.yaml 文件，内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="s2">&#34;touch /tmp/hello.txt;while true;do /bin/echo $(date +%T) &gt;&gt; /tmp/hello.txt; sleep 3; done;&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><p><a href="/p/2024122601/upload/image-20210617224457945.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20210617224457945.png"
	width="497"
	height="97"
	srcset="/p/2024122601/upload/image-20210617224457945_hu86802950c7ee450a604d7bb74101fbed_19917_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20210617224457945_hu86802950c7ee450a604d7bb74101fbed_19917_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20210617224457945"
	
>
</a></p>
<p>command，用于在 pod 中的容器初始化完毕之后运行一个命令。</p>
<blockquote>
<p>稍微解释下上面命令的意思：</p>
<p>&ldquo;/bin/sh&rdquo;,&quot;-c&rdquo;, 使用 sh 执行命令</p>
<p>touch /tmp/hello.txt; 创建一个/tmp/hello.txt 文件</p>
<p>while true;do /bin/echo $(date +%T) &raquo; /tmp/hello.txt; sleep 3; done; 每隔 3 秒向文件中写入当前时间</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建Pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 pod<span class="o">]</span><span class="c1"># kubectl create  -f pod-command.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-command created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看Pod状态</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 此时发现两个pod都正常运行了</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 pod<span class="o">]</span><span class="c1"># kubectl get pods pod-command -n dev</span>
</span></span><span class="line"><span class="cl">NAME          READY   STATUS   RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod-command   2/2     Runing   <span class="m">0</span>          2s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 进入pod中的busybox容器，查看文件内容</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 补充一个命令: kubectl exec  pod名称 -n 命名空间 -it -c 容器名称 /bin/sh  在容器内部执行命令</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 使用这个命令就可以进入某个容器的内部，然后进行相关操作了</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 比如，可以查看txt文件的内容</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 pod<span class="o">]</span><span class="c1"># kubectl exec pod-command -n dev -it -c busybox /bin/sh</span>
</span></span><span class="line"><span class="cl">/ <span class="c1"># tail -f /tmp/hello.txt</span>
</span></span><span class="line"><span class="cl">14:44:19
</span></span><span class="line"><span class="cl">14:44:22
</span></span><span class="line"><span class="cl">14:44:25
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">特别说明：
</span></span><span class="line"><span class="cl">    通过上面发现command已经可以完成启动命令和传递参数的功能，为什么这里还要提供一个args选项，用于传递参数呢?这其实跟docker有点关系，kubernetes中的command、args两项其实是实现覆盖Dockerfile中ENTRYPOINT的功能。
</span></span><span class="line"><span class="cl"> 1 如果command和args均没有写，那么用Dockerfile的配置。
</span></span><span class="line"><span class="cl"> 2 如果command写了，但args没有写，那么Dockerfile默认的配置会被忽略，执行输入的command
</span></span><span class="line"><span class="cl"> 3 如果command没写，但args写了，那么Dockerfile中配置的ENTRYPOINT的命令会被执行，使用当前args的参数
</span></span><span class="line"><span class="cl"> 4 如果command和args都写了，那么Dockerfile的配置被忽略，执行command并追加上args参数
</span></span></code></pre></div><h5 id="524-环境变量">5.2.4 环境变量</h5>
<p>创建 pod-env.yaml 文件，内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-env</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">[</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;while true;do /bin/echo $(date +%T);sleep 60; done;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="c"># 设置环境变量列表</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;username&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;admin&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;password&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;123456&#34;</span><span class="w">
</span></span></span></code></pre></div><p>env，环境变量，用于在 pod 中的容器设置环境变量。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建Pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pod-env.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-env created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 进入容器，输出环境变量</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl exec pod-env -n dev -c busybox -it /bin/sh</span>
</span></span><span class="line"><span class="cl">/ <span class="c1"># echo $username</span>
</span></span><span class="line"><span class="cl">admin
</span></span><span class="line"><span class="cl">/ <span class="c1"># echo $password</span>
</span></span><span class="line"><span class="cl"><span class="m">123456</span>
</span></span></code></pre></div><p>这种方式不是很推荐，推荐将这些配置单独存储在配置文件中，这种方式将在后面介绍。</p>
<h5 id="525-端口设置">5.2.5 端口设置</h5>
<p>本小节来介绍容器的端口设置，也就是 containers 的 ports 选项。</p>
<p>首先看下 ports 支持的子选项：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl explain pod.spec.containers.ports</span>
</span></span><span class="line"><span class="cl">KIND:     Pod
</span></span><span class="line"><span class="cl">VERSION:  v1
</span></span><span class="line"><span class="cl">RESOURCE: ports &lt;<span class="o">[]</span>Object&gt;
</span></span><span class="line"><span class="cl">FIELDS:
</span></span><span class="line"><span class="cl">   name         &lt;string&gt;  <span class="c1"># 端口名称，如果指定，必须保证name在pod中是唯一的</span>
</span></span><span class="line"><span class="cl">   containerPort&lt;integer&gt; <span class="c1"># 容器要监听的端口(0&lt;x&lt;65536)</span>
</span></span><span class="line"><span class="cl">   hostPort     &lt;integer&gt; <span class="c1"># 容器要在主机上公开的端口，如果设置，主机上只能运行容器的一个副本(一般省略)</span>
</span></span><span class="line"><span class="cl">   hostIP       &lt;string&gt;  <span class="c1"># 要将外部端口绑定到的主机IP(一般省略)</span>
</span></span><span class="line"><span class="cl">   protocol     &lt;string&gt;  <span class="c1"># 端口协议。必须是UDP、TCP或SCTP。默认为“TCP”。</span>
</span></span></code></pre></div><p>接下来，编写一个测试案例，创建 pod-ports.yaml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-ports</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w"> </span><span class="c"># 设置容器暴露的端口列表</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建Pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pod-ports.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-ports created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 在下面可以明显看到配置信息</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pod pod-ports -n dev -o yaml</span>
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - image: nginx:1.17.1
</span></span><span class="line"><span class="cl">    imagePullPolicy: IfNotPresent
</span></span><span class="line"><span class="cl">    name: nginx
</span></span><span class="line"><span class="cl">    ports:
</span></span><span class="line"><span class="cl">    - containerPort: <span class="m">80</span>
</span></span><span class="line"><span class="cl">      name: nginx-port
</span></span><span class="line"><span class="cl">      protocol: TCP
</span></span><span class="line"><span class="cl">......
</span></span></code></pre></div><p>访问容器中的程序需要使用的是<code>Podip:containerPort</code></p>
<h5 id="526-资源配额">5.2.6 资源配额</h5>
<p>容器中的程序要运行，肯定是要占用一定资源的，比如 cpu 和内存等，如果不对某个容器的资源做限制，那么它就可能吃掉大量资源，导致其它容器无法运行。针对这种情况，kubernetes 提供了对内存和 cpu 的资源进行配额的机制，这种机制主要通过 resources 选项实现，他有两个子选项：</p>
<ul>
<li>limits：用于限制运行时容器的最大占用资源，当容器占用资源超过 limits 时会被终止，并进行重启</li>
<li>requests ：用于设置容器需要的最小资源，如果环境资源不够，容器将无法启动</li>
</ul>
<p>可以通过上面两个选项设置资源的上下限。</p>
<p>接下来，编写一个测试案例，创建 pod-resources.yaml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-resources</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="c"># 资源配额</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">limits</span><span class="p">:</span><span class="w"> </span><span class="c"># 限制资源（上限）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2&#34;</span><span class="w"> </span><span class="c"># CPU限制，单位是core数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10Gi&#34;</span><span class="w"> </span><span class="c"># 内存限制</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">requests</span><span class="p">:</span><span class="w"> </span><span class="c"># 请求资源（下限）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w"> </span><span class="c"># CPU限制，单位是core数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10Mi&#34;</span><span class="w"> </span><span class="c"># 内存限制</span><span class="w">
</span></span></span></code></pre></div><p>在这对 cpu 和 memory 的单位做一个说明：</p>
<ul>
<li>cpu：core 数，可以为整数或小数</li>
<li>memory： 内存大小，可以使用 Gi、Mi、G、M 等形式</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 运行Pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create  -f pod-resources.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-resources created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看发现pod运行正常</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pod pod-resources -n dev</span>
</span></span><span class="line"><span class="cl">NAME            READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod-resources   1/1     Running   <span class="m">0</span>          39s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 接下来，停止Pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl delete  -f pod-resources.yaml</span>
</span></span><span class="line"><span class="cl">pod <span class="s2">&#34;pod-resources&#34;</span> deleted
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 编辑pod，修改resources.requests.memory的值为10Gi</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># vim pod-resources.yaml</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 再次启动pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create  -f pod-resources.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-resources created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看Pod状态，发现Pod启动失败</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pod pod-resources -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME            READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod-resources   0/1     Pending   <span class="m">0</span>          20s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod详情会发现，如下提示</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl describe pod pod-resources -n dev</span>
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">Warning  FailedScheduling  35s   default-scheduler  0/3 nodes are available: <span class="m">1</span> node<span class="o">(</span>s<span class="o">)</span> had taint <span class="o">{</span>node-role.kubernetes.io/master: <span class="o">}</span>, that the pod didn<span class="err">&#39;</span>t tolerate, <span class="m">2</span> Insufficient memory.<span class="o">(</span>内存不足<span class="o">)</span>
</span></span></code></pre></div><h4 id="53-pod-生命周期">5.3 Pod 生命周期</h4>
<p>我们一般将 pod 对象从创建至终的这段时间范围称为 pod 的生命周期，它主要包含下面的过程：</p>
<ul>
<li>pod 创建过程</li>
<li>运行初始化容器（init container）过程</li>
<li>运行主容器（main container）
<ul>
<li>容器启动后钩子（post start）、容器终止前钩子（pre stop）</li>
<li>容器的存活性探测（liveness probe）、就绪性探测（readiness probe）</li>
</ul>
</li>
<li>pod 终止过程</li>
</ul>
<p><a href="/p/2024122601/upload/image-20200412111402706-1626782188724.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200412111402706-1626782188724.png"
	width="1053"
	height="548"
	srcset="/p/2024122601/upload/image-20200412111402706-1626782188724_hudf4ec02e0a6c4c2c7e4db7f14c352e15_16372_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200412111402706-1626782188724_hudf4ec02e0a6c4c2c7e4db7f14c352e15_16372_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200412111402706"
	
>
</a></p>
<p>在整个生命周期中，Pod 会出现 5 种状态（相位），分别如下：</p>
<ul>
<li>挂起（Pending）：apiserver 已经创建了 pod 资源对象，但它尚未被调度完成或者仍处于下载镜像的过程中</li>
<li>运行中（Running）：pod 已经被调度至某节点，并且所有容器都已经被 kubelet 创建完成</li>
<li>成功（Succeeded）：pod 中的所有容器都已经成功终止并且不会被重启</li>
<li>失败（Failed）：所有容器都已经终止，但至少有一个容器终止失败，即容器返回了非 0 值的退出状态</li>
<li>未知（Unknown）：apiserver 无法正常获取到 pod 对象的状态信息，通常由网络通信失败所导致</li>
</ul>
<h5 id="531-创建和终止">5.3.1 创建和终止</h5>
<p>pod 的创建过程</p>
<ol>
<li>
<p>用户通过 kubectl 或其他 api 客户端提交需要创建的 pod 信息给 apiServer</p>
</li>
<li>
<p>apiServer 开始生成 pod 对象的信息，并将信息存入 etcd，然后返回确认信息至客户端</p>
</li>
<li>
<p>apiServer 开始反映 etcd 中的 pod 对象的变化，其它组件使用 watch 机制来跟踪检查 apiServer 上的变动</p>
</li>
<li>
<p>scheduler 发现有新的 pod 对象要创建，开始为 Pod 分配主机并将结果信息更新至 apiServer</p>
</li>
<li>
<p>node 节点上的 kubelet 发现有 pod 调度过来，尝试调用 docker 启动容器，并将结果回送至 apiServer</p>
</li>
<li>
<p>apiServer 将接收到的 pod 状态信息存入 etcd 中</p>
<p><a href="/p/2024122601/upload/image-20200406184656917-1626782168787.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200406184656917-1626782168787.png"
	width="1436"
	height="745"
	srcset="/p/2024122601/upload/image-20200406184656917-1626782168787_hua134daed280c19d7bf688226539459b0_29159_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200406184656917-1626782168787_hua134daed280c19d7bf688226539459b0_29159_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200406184656917"
	
>
</a></p>
</li>
</ol>
<p>pod 的终止过程</p>
<ol>
<li>用户向 apiServer 发送删除 pod 对象的命令</li>
<li>apiServcer 中的 pod 对象信息会随着时间的推移而更新，在宽限期内（默认 30s），pod 被视为 dead</li>
<li>将 pod 标记为 terminating 状态</li>
<li>kubelet 在监控到 pod 对象转为 terminating 状态的同时启动 pod 关闭过程</li>
<li>端点控制器监控到 pod 对象的关闭行为时将其从所有匹配到此端点的 service 资源的端点列表中移除</li>
<li>如果当前 pod 对象定义了 preStop 钩子处理器，则在其标记为 terminating 后即会以同步的方式启动执行</li>
<li>pod 对象中的容器进程收到停止信号</li>
<li>宽限期结束后，若 pod 中还存在仍在运行的进程，那么 pod 对象会收到立即终止的信号</li>
<li>kubelet 请求 apiServer 将此 pod 资源的宽限期设置为 0 从而完成删除操作，此时 pod 对于用户已不可见</li>
</ol>
<h5 id="532-初始化容器">5.3.2 初始化容器</h5>
<p>初始化容器是在 pod 的主容器启动之前要运行的容器，主要是做一些主容器的前置工作，它具有两大特征：</p>
<ol>
<li>初始化容器必须运行完成直至结束，若某初始化容器运行失败，那么 kubernetes 需要重启它直到成功完成</li>
<li>初始化容器必须按照定义的顺序执行，当且仅当前一个成功之后，后面的一个才能运行</li>
</ol>
<p>初始化容器有很多的应用场景，下面列出的是最常见的几个：</p>
<ul>
<li>提供主容器镜像中不具备的工具程序或自定义代码</li>
<li>初始化容器要先于应用容器串行启动并运行完成，因此可用于延后应用容器的启动直至其依赖的条件得到满足</li>
</ul>
<p>接下来做一个案例，模拟下面这个需求：</p>
<p>假设要以主容器来运行 nginx，但是要求在运行 nginx 之前先要能够连接上 mysql 和 redis 所在服务器</p>
<p>为了简化测试，事先规定好 mysql<code>(192.168.90.14)</code>和 redis<code>(192.168.90.15)</code>服务器的地址</p>
<p>创建 pod-initcontainer.yaml，内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-initcontainer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">main-container</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">initContainers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-mysql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="s2">&#34;sh&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="s2">&#34;until ping 192.168.90.14 -c 1 ; do echo waiting for mysql...; sleep 2; done;&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-redis</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="s2">&#34;sh&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="s2">&#34;until ping 192.168.90.15 -c 1 ; do echo waiting for reids...; sleep 2; done;&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pod-initcontainer.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-initcontainer created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod状态</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 发现pod卡在启动第一个初始化容器过程中，后面的容器不会运行</span>
</span></span><span class="line"><span class="cl">root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl describe pod  pod-initcontainer -n dev</span>
</span></span><span class="line"><span class="cl">........
</span></span><span class="line"><span class="cl">Events:
</span></span><span class="line"><span class="cl">  Type    Reason     Age   From               Message
</span></span><span class="line"><span class="cl">  ----    ------     ----  ----               -------
</span></span><span class="line"><span class="cl">  Normal  Scheduled  49s   default-scheduler  Successfully assigned dev/pod-initcontainer to node1
</span></span><span class="line"><span class="cl">  Normal  Pulled     48s   kubelet, node1     Container image <span class="s2">&#34;busybox:1.30&#34;</span> already present on machine
</span></span><span class="line"><span class="cl">  Normal  Created    48s   kubelet, node1     Created container test-mysql
</span></span><span class="line"><span class="cl">  Normal  Started    48s   kubelet, node1     Started container test-mysql
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 动态查看pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods pod-initcontainer -n dev -w</span>
</span></span><span class="line"><span class="cl">NAME                             READY   STATUS     RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod-initcontainer                0/1     Init:0/2   <span class="m">0</span>          15s
</span></span><span class="line"><span class="cl">pod-initcontainer                0/1     Init:1/2   <span class="m">0</span>          52s
</span></span><span class="line"><span class="cl">pod-initcontainer                0/1     Init:1/2   <span class="m">0</span>          53s
</span></span><span class="line"><span class="cl">pod-initcontainer                0/1     PodInitializing   <span class="m">0</span>          89s
</span></span><span class="line"><span class="cl">pod-initcontainer                1/1     Running           <span class="m">0</span>          90s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 接下来新开一个shell，为当前服务器新增两个ip，观察pod的变化</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># ifconfig ens33:1 192.168.90.14 netmask 255.255.255.0 up</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># ifconfig ens33:2 192.168.90.15 netmask 255.255.255.0 up</span>
</span></span></code></pre></div><h5 id="533-钩子函数">5.3.3 钩子函数</h5>
<p>钩子函数能够感知自身生命周期中的事件，并在相应的时刻到来时运行用户指定的程序代码。</p>
<p>kubernetes 在主容器的启动之后和停止之前提供了两个钩子函数：</p>
<ul>
<li>post start：容器创建之后执行，如果失败了会重启容器</li>
<li>pre stop ：容器终止之前执行，执行完成之后容器将成功终止，在其完成之前会阻塞删除容器的操作</li>
</ul>
<p>钩子处理器支持使用下面三种方式定义动作：</p>
<ul>
<li>
<p>Exec 命令：在容器内执行一次命令</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">……</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">lifecycle</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">postStart</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">cat</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">/tmp/healthy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">……</span><span class="w">
</span></span></span></code></pre></div></li>
<li>
<p>TCPSocket：在当前容器尝试访问指定的 socket</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">……</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">lifecycle</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">postStart</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tcpSocket</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">……</span><span class="w">
</span></span></span></code></pre></div></li>
<li>
<p>HTTPGet：在当前容器中向某 url 发起 http 请求</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">……</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">lifecycle</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">postStart</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w"> </span><span class="c">#URI地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="c">#端口号</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.5.3</span><span class="w"> </span><span class="c">#主机地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP</span><span class="w"> </span><span class="c">#支持的协议，http或者https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">……</span><span class="w">
</span></span></span></code></pre></div></li>
</ul>
<p>接下来，以 exec 方式为例，演示下钩子函数的使用，创建 pod-hook-exec.yaml 文件，内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-hook-exec</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">main-container</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">lifecycle</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">postStart</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">exec</span><span class="p">:</span><span class="w"> </span><span class="c"># 在容器启动的时候执行一个命令，修改掉nginx的默认首页内容</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="s2">&#34;echo postStart... &gt; /usr/share/nginx/html/index.html&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">preStop</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">exec</span><span class="p">:</span><span class="w"> </span><span class="c"># 在容器停止之前停止nginx服务</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;/usr/sbin/nginx&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-s&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;quit&#34;</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pod-hook-exec.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-hook-exec created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods  pod-hook-exec -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME           READY   STATUS     RESTARTS   AGE    IP            NODE
</span></span><span class="line"><span class="cl">pod-hook-exec  1/1     Running    <span class="m">0</span>          29s    10.244.2.48   node2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 访问pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># curl 10.244.2.48</span>
</span></span><span class="line"><span class="cl">postStart...
</span></span></code></pre></div><h5 id="534-容器探测">5.3.4 容器探测</h5>
<p>容器探测用于检测容器中的应用实例是否正常工作，是保障业务可用性的一种传统机制。如果经过探测，实例的状态不符合预期，那么 kubernetes 就会把该问题实例&rdquo; 摘除 &ldquo;，不承担业务流量。kubernetes 提供了两种探针来实现容器探测，分别是：</p>
<ul>
<li>liveness probes：存活性探针，用于检测应用实例当前是否处于正常运行状态，如果不是，k8s 会重启容器</li>
<li>readiness probes：就绪性探针，用于检测应用实例当前是否可以接收请求，如果不能，k8s 不会转发流量</li>
</ul>
<blockquote>
<p>livenessProbe 决定是否重启容器，readinessProbe 决定是否将请求转发给容器。</p>
</blockquote>
<p>上面两种探针目前均支持三种探测方式：</p>
<ul>
<li>
<p>Exec 命令：在容器内执行一次命令，如果命令执行的退出码为 0，则认为程序正常，否则不正常</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">……</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">cat</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">/tmp/healthy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">……</span><span class="w">
</span></span></span></code></pre></div></li>
<li>
<p>TCPSocket：将会尝试访问一个用户容器的端口，如果能够建立这条连接，则认为程序正常，否则不正常</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">……</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tcpSocket</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">……</span><span class="w">
</span></span></span></code></pre></div></li>
<li>
<p>HTTPGet：调用容器内 Web 应用的 URL，如果返回的状态码在 200 和 399 之间，则认为程序正常，否则不正常</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">……</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w"> </span><span class="c">#URI地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="c">#端口号</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="w"> </span><span class="c">#主机地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP</span><span class="w"> </span><span class="c">#支持的协议，http或者https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">……</span><span class="w">
</span></span></span></code></pre></div></li>
</ul>
<p>下面以 liveness probes 为例，做几个演示：</p>
<p>方式一：Exec</p>
<p>创建 pod-liveness-exec.yaml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-liveness-exec</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;/bin/cat&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;/tmp/hello.txt&#34;</span><span class="p">]</span><span class="w"> </span><span class="c"># 执行一个查看文件的命令</span><span class="w">
</span></span></span></code></pre></div><p>创建 pod，观察效果</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建Pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pod-liveness-exec.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-liveness-exec created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看Pod详情</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl describe pods pod-liveness-exec -n dev</span>
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">  Normal   Created    20s <span class="o">(</span>x2 over 50s<span class="o">)</span>  kubelet, node1     Created container nginx
</span></span><span class="line"><span class="cl">  Normal   Started    20s <span class="o">(</span>x2 over 50s<span class="o">)</span>  kubelet, node1     Started container nginx
</span></span><span class="line"><span class="cl">  Normal   Killing    20s                kubelet, node1     Container nginx failed liveness probe, will be restarted
</span></span><span class="line"><span class="cl">  Warning  Unhealthy  0s <span class="o">(</span>x5 over 40s<span class="o">)</span>   kubelet, node1     Liveness probe failed: cat: can<span class="s1">&#39;t open &#39;</span>/tmp/hello11.txt<span class="err">&#39;</span>: No such file or directory
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 观察上面的信息就会发现nginx容器启动之后就进行了健康检查</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 检查失败之后，容器被kill掉，然后尝试进行重启（这是重启策略的作用，后面讲解）</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 稍等一会之后，再观察pod信息，就可以看到RESTARTS不再是0，而是一直增长</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods pod-liveness-exec -n dev</span>
</span></span><span class="line"><span class="cl">NAME                READY   STATUS             RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod-liveness-exec   0/1     CrashLoopBackOff   <span class="m">2</span>          3m19s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 当然接下来，可以修改成一个存在的文件，比如/tmp/hello.txt，再试，结果就正常了......</span>
</span></span></code></pre></div><p>方式二：TCPSocket</p>
<p>创建 pod-liveness-tcpsocket.yaml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-liveness-tcpsocket</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tcpSocket</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w"> </span><span class="c"># 尝试访问8080端口</span><span class="w">
</span></span></span></code></pre></div><p>创建 pod，观察效果</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建Pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pod-liveness-tcpsocket.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-liveness-tcpsocket created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看Pod详情</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl describe pods pod-liveness-tcpsocket -n dev</span>
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">  Normal   Scheduled  31s                            default-scheduler  Successfully assigned dev/pod-liveness-tcpsocket to node2
</span></span><span class="line"><span class="cl">  Normal   Pulled     &lt;invalid&gt;                      kubelet, node2     Container image <span class="s2">&#34;nginx:1.17.1&#34;</span> already present on machine
</span></span><span class="line"><span class="cl">  Normal   Created    &lt;invalid&gt;                      kubelet, node2     Created container nginx
</span></span><span class="line"><span class="cl">  Normal   Started    &lt;invalid&gt;                      kubelet, node2     Started container nginx
</span></span><span class="line"><span class="cl">  Warning  Unhealthy  &lt;invalid&gt; <span class="o">(</span>x2 over &lt;invalid&gt;<span class="o">)</span>  kubelet, node2     Liveness probe failed: dial tcp 10.244.2.44:8080: connect: connection refused
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 观察上面的信息，发现尝试访问8080端口,但是失败了</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 稍等一会之后，再观察pod信息，就可以看到RESTARTS不再是0，而是一直增长</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods pod-liveness-tcpsocket  -n dev</span>
</span></span><span class="line"><span class="cl">NAME                     READY   STATUS             RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod-liveness-tcpsocket   0/1     CrashLoopBackOff   <span class="m">2</span>          3m19s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 当然接下来，可以修改成一个可以访问的端口，比如80，再试，结果就正常了......</span>
</span></span></code></pre></div><p>方式三：HTTPGet</p>
<p>创建 pod-liveness-httpget.yaml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-liveness-httpget</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">httpGet</span><span class="p">:</span><span class="w"> </span><span class="c"># 其实就是访问http:/127.0.0.1:80/hello</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP</span><span class="w"> </span><span class="c">#支持的协议，http或者https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="c">#端口号</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/hello</span><span class="w"> </span><span class="c">#URI地址</span><span class="w">
</span></span></span></code></pre></div><p>创建 pod，观察效果</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建Pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pod-liveness-httpget.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-liveness-httpget created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看Pod详情</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl describe pod pod-liveness-httpget -n dev</span>
</span></span><span class="line"><span class="cl">.......
</span></span><span class="line"><span class="cl">  Normal   Pulled     6s <span class="o">(</span>x3 over 64s<span class="o">)</span>  kubelet, node1     Container image <span class="s2">&#34;nginx:1.17.1&#34;</span> already present on machine
</span></span><span class="line"><span class="cl">  Normal   Created    6s <span class="o">(</span>x3 over 64s<span class="o">)</span>  kubelet, node1     Created container nginx
</span></span><span class="line"><span class="cl">  Normal   Started    6s <span class="o">(</span>x3 over 63s<span class="o">)</span>  kubelet, node1     Started container nginx
</span></span><span class="line"><span class="cl">  Warning  Unhealthy  6s <span class="o">(</span>x6 over 56s<span class="o">)</span>  kubelet, node1     Liveness probe failed: HTTP probe failed with statuscode: <span class="m">404</span>
</span></span><span class="line"><span class="cl">  Normal   Killing    6s <span class="o">(</span>x2 over 36s<span class="o">)</span>  kubelet, node1     Container nginx failed liveness probe, will be restarted
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 观察上面信息，尝试访问路径，但是未找到,出现404错误</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 稍等一会之后，再观察pod信息，就可以看到RESTARTS不再是0，而是一直增长</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pod pod-liveness-httpget -n dev</span>
</span></span><span class="line"><span class="cl">NAME                   READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod-liveness-httpget   1/1     Running   <span class="m">5</span>          3m17s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 当然接下来，可以修改成一个可以访问的路径path，比如/，再试，结果就正常了......</span>
</span></span></code></pre></div><p>至此，已经使用 liveness Probe 演示了三种探测方式，但是查看 livenessProbe 的子属性，会发现除了这三种方式，还有一些其他的配置，在这里一并解释下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl explain pod.spec.containers.livenessProbe</span>
</span></span><span class="line"><span class="cl">FIELDS:
</span></span><span class="line"><span class="cl">   <span class="nb">exec</span> &lt;Object&gt;
</span></span><span class="line"><span class="cl">   tcpSocket    &lt;Object&gt;
</span></span><span class="line"><span class="cl">   httpGet      &lt;Object&gt;
</span></span><span class="line"><span class="cl">   initialDelaySeconds  &lt;integer&gt;  <span class="c1"># 容器启动后等待多少秒执行第一次探测</span>
</span></span><span class="line"><span class="cl">   timeoutSeconds       &lt;integer&gt;  <span class="c1"># 探测超时时间。默认1秒，最小1秒</span>
</span></span><span class="line"><span class="cl">   periodSeconds        &lt;integer&gt;  <span class="c1"># 执行探测的频率。默认是10秒，最小1秒</span>
</span></span><span class="line"><span class="cl">   failureThreshold     &lt;integer&gt;  <span class="c1"># 连续探测失败多少次才被认定为失败。默认是3。最小值是1</span>
</span></span><span class="line"><span class="cl">   successThreshold     &lt;integer&gt;  <span class="c1"># 连续探测成功多少次才被认定为成功。默认是1</span>
</span></span></code></pre></div><p>下面稍微配置两个，演示下效果即可：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="p">[</span><span class="l">root@k8s-master01 ~]# more pod-liveness-httpget.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-liveness-httpget</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="c"># 容器启动后30s开始探测</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="c"># 探测超时时间为5s</span><span class="w">
</span></span></span></code></pre></div><h5 id="535-重启策略">5.3.5 重启策略</h5>
<p>在上一节中，一旦容器探测出现了问题，kubernetes 就会对容器所在的 Pod 进行重启，其实这是由 pod 的重启策略决定的，pod 的重启策略有 3 种，分别如下：</p>
<ul>
<li>Always ：容器失效时，自动重启该容器，这也是默认值。</li>
<li>OnFailure ： 容器终止运行且退出码不为 0 时重启</li>
<li>Never ： 不论状态为何，都不重启该容器</li>
</ul>
<p>重启策略适用于 pod 对象中的所有容器，首次需要重启的容器，将在其需要时立即进行重启，随后再次需要重启的操作将由 kubelet 延迟一段时间后进行，且反复的重启操作的延迟时长以此为 10s、20s、40s、80s、160s 和 300s，300s 是最大延迟时长。</p>
<p>创建 pod-restartpolicy.yaml：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-restartpolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/hello</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span><span class="w"> </span><span class="c"># 设置重启策略为Never</span><span class="w">
</span></span></span></code></pre></div><p>运行 Pod 测试</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建Pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pod-restartpolicy.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-restartpolicy created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看Pod详情，发现nginx容器失败</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl  describe pods pod-restartpolicy  -n dev</span>
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">  Warning  Unhealthy  15s <span class="o">(</span>x3 over 35s<span class="o">)</span>  kubelet, node1     Liveness probe failed: HTTP probe failed with statuscode: <span class="m">404</span>
</span></span><span class="line"><span class="cl">  Normal   Killing    15s                kubelet, node1     Container nginx failed liveness probe
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 多等一会，再观察pod的重启次数，发现一直是0，并未重启</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl  get pods pod-restartpolicy -n dev</span>
</span></span><span class="line"><span class="cl">NAME                   READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod-restartpolicy      0/1     Running   <span class="m">0</span>          5min42s
</span></span></code></pre></div><h4 id="54-pod-调度">5.4 Pod 调度</h4>
<p>在默认情况下，一个 Pod 在哪个 Node 节点上运行，是由 Scheduler 组件采用相应的算法计算出来的，这个过程是不受人工控制的。但是在实际使用中，这并不满足的需求，因为很多情况下，我们想控制某些 Pod 到达某些节点上，那么应该怎么做呢？这就要求了解 kubernetes 对 Pod 的调度规则，kubernetes 提供了四大类调度方式：</p>
<ul>
<li>自动调度：运行在哪个节点上完全由 Scheduler 经过一系列的算法计算得出</li>
<li>定向调度：NodeName、NodeSelector</li>
<li>亲和性调度：NodeAffinity、PodAffinity、PodAntiAffinity</li>
<li>污点（容忍）调度：Taints、Toleration</li>
</ul>
<h5 id="541-定向调度">5.4.1 定向调度</h5>
<p>定向调度，指的是利用在 pod 上声明 nodeName 或者 nodeSelector，以此将 Pod 调度到期望的 node 节点上。注意，这里的调度是强制的，这就意味着即使要调度的目标 Node 不存在，也会向上面进行调度，只不过 pod 运行失败而已。</p>
<p>NodeName</p>
<p>NodeName 用于强制约束将 Pod 调度到指定的 Name 的 Node 节点上。这种方式，其实是直接跳过 Scheduler 的调度逻辑，直接将 Pod 调度到指定名称的节点。</p>
<p>接下来，实验一下：创建一个 pod-nodename.yaml 文件</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-nodename</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodeName</span><span class="p">:</span><span class="w"> </span><span class="l">node1</span><span class="w"> </span><span class="c"># 指定调度到node1节点上</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1">#创建Pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pod-nodename.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-nodename created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#查看Pod调度到NODE属性，确实是调度到了node1节点上</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods pod-nodename -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME           READY   STATUS    RESTARTS   AGE   IP            NODE      ......
</span></span><span class="line"><span class="cl">pod-nodename   1/1     Running   <span class="m">0</span>          56s   10.244.1.87   node1     ......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 接下来，删除pod，修改nodeName的值为node3（并没有node3节点）</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl delete -f pod-nodename.yaml</span>
</span></span><span class="line"><span class="cl">pod <span class="s2">&#34;pod-nodename&#34;</span> deleted
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># vim pod-nodename.yaml</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pod-nodename.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-nodename created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#再次查看，发现已经向Node3节点调度，但是由于不存在node3节点，所以pod无法正常运行</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods pod-nodename -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME           READY   STATUS    RESTARTS   AGE   IP       NODE    ......
</span></span><span class="line"><span class="cl">pod-nodename   0/1     Pending   <span class="m">0</span>          6s    &lt;none&gt;   node3   ......
</span></span></code></pre></div><p>NodeSelector</p>
<p>NodeSelector 用于将 pod 调度到添加了指定标签的 node 节点上。它是通过 kubernetes 的 label-selector 机制实现的，也就是说，在 pod 创建之前，会由 scheduler 使用 MatchNodeSelector 调度策略进行 label 匹配，找出目标 node，然后将 pod 调度到目标节点，该匹配规则是强制约束。</p>
<p>接下来，实验一下：</p>
<p>1 首先分别为 node 节点添加标签</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl label nodes node1 nodeenv=pro</span>
</span></span><span class="line"><span class="cl">node/node2 labeled
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl label nodes node2 nodeenv=test</span>
</span></span><span class="line"><span class="cl">node/node2 labeled
</span></span></code></pre></div><p>2 创建一个 pod-nodeselector.yaml 文件，并使用它创建 Pod</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-nodeselector</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nodeenv</span><span class="p">:</span><span class="w"> </span><span class="l">pro</span><span class="w"> </span><span class="c"># 指定调度到具有nodeenv=pro标签的节点上</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1">#创建Pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pod-nodeselector.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-nodeselector created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#查看Pod调度到NODE属性，确实是调度到了node1节点上</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods pod-nodeselector -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME               READY   STATUS    RESTARTS   AGE     IP          NODE    ......
</span></span><span class="line"><span class="cl">pod-nodeselector   1/1     Running   <span class="m">0</span>          47s   10.244.1.87   node1   ......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 接下来，删除pod，修改nodeSelector的值为nodeenv: xxxx（不存在打有此标签的节点）</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl delete -f pod-nodeselector.yaml</span>
</span></span><span class="line"><span class="cl">pod <span class="s2">&#34;pod-nodeselector&#34;</span> deleted
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># vim pod-nodeselector.yaml</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pod-nodeselector.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-nodeselector created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#再次查看，发现pod无法正常运行,Node的值为none</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME               READY   STATUS    RESTARTS   AGE     IP       NODE
</span></span><span class="line"><span class="cl">pod-nodeselector   0/1     Pending   <span class="m">0</span>          2m20s   &lt;none&gt;   &lt;none&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看详情,发现node selector匹配失败的提示</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl describe pods pod-nodeselector -n dev</span>
</span></span><span class="line"><span class="cl">.......
</span></span><span class="line"><span class="cl">Events:
</span></span><span class="line"><span class="cl">  Type     Reason            Age        From               Message
</span></span><span class="line"><span class="cl">  ----     ------            ----       ----               -------
</span></span><span class="line"><span class="cl">  Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/3 nodes are available: <span class="m">3</span> node<span class="o">(</span>s<span class="o">)</span> didn<span class="err">&#39;</span>t match node selector.
</span></span></code></pre></div><h5 id="542-亲和性调度">5.4.2 亲和性调度</h5>
<p>上一节，介绍了两种定向调度的方式，使用起来非常方便，但是也有一定的问题，那就是如果没有满足条件的 Node，那么 Pod 将不会被运行，即使在集群中还有可用 Node 列表也不行，这就限制了它的使用场景。</p>
<p>基于上面的问题，kubernetes 还提供了一种亲和性调度（Affinity）。它在 NodeSelector 的基础之上的进行了扩展，可以通过配置的形式，实现优先选择满足条件的 Node 进行调度，如果没有，也可以调度到不满足条件的节点上，使调度更加灵活。</p>
<p>Affinity 主要分为三类：</p>
<ul>
<li>nodeAffinity(node 亲和性）: 以 node 为目标，解决 pod 可以调度到哪些 node 的问题</li>
<li>podAffinity(pod 亲和性) : 以 pod 为目标，解决 pod 可以和哪些已存在的 pod 部署在同一个拓扑域中的问题</li>
<li>podAntiAffinity(pod 反亲和性) : 以 pod 为目标，解决 pod 不能和哪些已存在 pod 部署在同一个拓扑域中的问题</li>
</ul>
<blockquote>
<p>关于亲和性(反亲和性)使用场景的说明：</p>
<p>亲和性：如果两个应用频繁交互，那就有必要利用亲和性让两个应用的尽可能的靠近，这样可以减少因网络通信而带来的性能损耗。</p>
<p>反亲和性：当应用的采用多副本部署时，有必要采用反亲和性让各个应用实例打散分布在各个 node 上，这样可以提高服务的高可用性。</p>
</blockquote>
<p>NodeAffinity</p>
<p>首先来看一下<code>NodeAffinity</code>的可配置项：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">pod.spec.affinity.nodeAffinity
</span></span><span class="line"><span class="cl">requiredDuringSchedulingIgnoredDuringExecution Node 节点必须满足指定的所有规则才可以，相当于硬限制
</span></span><span class="line"><span class="cl">nodeSelectorTerms 节点选择列表
</span></span><span class="line"><span class="cl">matchFields 按节点字段列出的节点选择器要求列表
</span></span><span class="line"><span class="cl">matchExpressions 按节点标签列出的节点选择器要求列表(推荐)
</span></span><span class="line"><span class="cl">key 键
</span></span><span class="line"><span class="cl">values 值
</span></span><span class="line"><span class="cl">operat or 关系符 支持 Exists, DoesNotExist, In, NotIn, Gt, Lt
</span></span><span class="line"><span class="cl">preferredDuringSchedulingIgnoredDuringExecution 优先调度到满足指定的规则的 Node，相当于软限制 (倾向)
</span></span><span class="line"><span class="cl">preference 一个节点选择器项，与相应的权重相关联
</span></span><span class="line"><span class="cl">matchFields 按节点字段列出的节点选择器要求列表
</span></span><span class="line"><span class="cl">matchExpressions 按节点标签列出的节点选择器要求列表(推荐)
</span></span><span class="line"><span class="cl">key 键
</span></span><span class="line"><span class="cl">values 值
</span></span><span class="line"><span class="cl">operator 关系符 支持 In, NotIn, Exists, DoesNotExist, Gt, Lt
</span></span><span class="line"><span class="cl">weight 倾向权重，在范围 1-100。
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">关系符的使用说明:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">- matchExpressions:
</span></span><span class="line"><span class="cl">  - key: nodeenv              <span class="c1"># 匹配存在标签的key为nodeenv的节点</span>
</span></span><span class="line"><span class="cl">    operator: Exists
</span></span><span class="line"><span class="cl">  - key: nodeenv              <span class="c1"># 匹配标签的key为nodeenv,且value是&#34;xxx&#34;或&#34;yyy&#34;的节点</span>
</span></span><span class="line"><span class="cl">    operator: In
</span></span><span class="line"><span class="cl">    values: <span class="o">[</span><span class="s2">&#34;xxx&#34;</span>,<span class="s2">&#34;yyy&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">  - key: nodeenv              <span class="c1"># 匹配标签的key为nodeenv,且value大于&#34;xxx&#34;的节点</span>
</span></span><span class="line"><span class="cl">    operator: Gt
</span></span><span class="line"><span class="cl">    values: <span class="s2">&#34;xxx&#34;</span>
</span></span></code></pre></div><p>接下来首先演示一下<code>requiredDuringSchedulingIgnoredDuringExecution</code> ,</p>
<p>创建 pod-nodeaffinity-required.yaml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-nodeaffinity-required</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">affinity</span><span class="p">:</span><span class="w"> </span><span class="c">#亲和性设置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nodeAffinity</span><span class="p">:</span><span class="w"> </span><span class="c">#设置node亲和性</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w"> </span><span class="c"># 硬限制</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">matchExpressions</span><span class="p">:</span><span class="w"> </span><span class="c"># 匹配env的值在[&#34;xxx&#34;,&#34;yyy&#34;]中的标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">nodeenv</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;xxx&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;yyy&#34;</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pod-nodeaffinity-required.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-nodeaffinity-required created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod状态 （运行失败）</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods pod-nodeaffinity-required -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME                        READY   STATUS    RESTARTS   AGE   IP       NODE    ......
</span></span><span class="line"><span class="cl">pod-nodeaffinity-required   0/1     Pending   <span class="m">0</span>          16s   &lt;none&gt;   &lt;none&gt;  ......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看Pod的详情</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 发现调度失败，提示node选择失败</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl describe pod pod-nodeaffinity-required -n dev</span>
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">  Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/3 nodes are available: <span class="m">3</span> node<span class="o">(</span>s<span class="o">)</span> didn<span class="s1">&#39;t match node selector.
</span></span></span><span class="line"><span class="cl"><span class="s1">  Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/3 nodes are available: 3 node(s) didn&#39;</span>t match node selector.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#接下来，停止pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl delete -f pod-nodeaffinity-required.yaml</span>
</span></span><span class="line"><span class="cl">pod <span class="s2">&#34;pod-nodeaffinity-required&#34;</span> deleted
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修改文件，将values: [&#34;xxx&#34;,&#34;yyy&#34;]------&gt; [&#34;pro&#34;,&#34;yyy&#34;]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># vim pod-nodeaffinity-required.yaml</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 再次启动</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pod-nodeaffinity-required.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-nodeaffinity-required created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 此时查看，发现调度成功，已经将pod调度到了node1上</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods pod-nodeaffinity-required -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME                        READY   STATUS    RESTARTS   AGE   IP            NODE  ......
</span></span><span class="line"><span class="cl">pod-nodeaffinity-required   1/1     Running   <span class="m">0</span>          11s   10.244.1.89   node1 ......
</span></span></code></pre></div><p>接下来再演示一下<code>requiredDuringSchedulingIgnoredDuringExecution</code> ,</p>
<p>创建 pod-nodeaffinity-preferred.yaml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-nodeaffinity-preferred</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">affinity</span><span class="p">:</span><span class="w"> </span><span class="c">#亲和性设置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nodeAffinity</span><span class="p">:</span><span class="w"> </span><span class="c">#设置node亲和性</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">preferredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w"> </span><span class="c"># 软限制</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">preference</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"> </span><span class="c"># 匹配env的值在[&#34;xxx&#34;,&#34;yyy&#34;]中的标签(当前环境没有)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">nodeenv</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;xxx&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;yyy&#34;</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pod-nodeaffinity-preferred.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-nodeaffinity-preferred created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod状态 （运行成功）</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pod pod-nodeaffinity-preferred -n dev</span>
</span></span><span class="line"><span class="cl">NAME                         READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod-nodeaffinity-preferred   1/1     Running   <span class="m">0</span>          40s
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">NodeAffinity规则设置的注意事项：
</span></span><span class="line"><span class="cl">    1 如果同时定义了nodeSelector和nodeAffinity，那么必须两个条件都得到满足，Pod才能运行在指定的Node上
</span></span><span class="line"><span class="cl">    2 如果nodeAffinity指定了多个nodeSelectorTerms，那么只需要其中一个能够匹配成功即可
</span></span><span class="line"><span class="cl">    3 如果一个nodeSelectorTerms中有多个matchExpressions ，则一个节点必须满足所有的才能匹配成功
</span></span><span class="line"><span class="cl">    4 如果一个pod所在的Node在Pod运行期间其标签发生了改变，不再符合该Pod的节点亲和性需求，则系统将忽略此变化
</span></span></code></pre></div><p>PodAffinity</p>
<p>PodAffinity 主要实现以运行的 Pod 为参照，实现让新创建的 Pod 跟参照 pod 在一个区域的功能。</p>
<p>首先来看一下<code>PodAffinity</code>的可配置项：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">pod.spec.affinity.podAffinity
</span></span><span class="line"><span class="cl">requiredDuringSchedulingIgnoredDuringExecution 硬限制
</span></span><span class="line"><span class="cl">namespaces 指定参照 pod 的 namespace
</span></span><span class="line"><span class="cl">topologyKey 指定调度作用域
</span></span><span class="line"><span class="cl">labelSelector 标签选择器
</span></span><span class="line"><span class="cl">matchExpressions 按节点标签列出的节点选择器要求列表(推荐)
</span></span><span class="line"><span class="cl">key 键
</span></span><span class="line"><span class="cl">values 值
</span></span><span class="line"><span class="cl">operator 关系符 支持 In, NotIn, Exists, DoesNotExist.
</span></span><span class="line"><span class="cl">matchLabels 指多个 matchExpressions 映射的内容
</span></span><span class="line"><span class="cl">preferredDuringSchedulingIgnoredDuringExecution 软限制
</span></span><span class="line"><span class="cl">podAffinityTerm 选项
</span></span><span class="line"><span class="cl">namespaces  
</span></span><span class="line"><span class="cl"> topologyKey
</span></span><span class="line"><span class="cl">labelSelector
</span></span><span class="line"><span class="cl">matchExpressions  
</span></span><span class="line"><span class="cl"> key 键
</span></span><span class="line"><span class="cl">values 值
</span></span><span class="line"><span class="cl">operator
</span></span><span class="line"><span class="cl">matchLabels
</span></span><span class="line"><span class="cl">weight 倾向权重，在范围 1-100
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">topologyKey 用于指定调度时作用域,例如:
</span></span><span class="line"><span class="cl">如果指定为 kubernetes.io/hostname，那就是以 Node 节点为区分范围
</span></span><span class="line"><span class="cl">如果指定为 beta.kubernetes.io/os,则以 Node 节点的操作系统类型来区分
</span></span></code></pre></div><p>接下来，演示下<code>requiredDuringSchedulingIgnoredDuringExecution</code>,</p>
<p>1）首先创建一个参照 Pod，pod-podaffinity-target.yaml：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-podaffinity-target</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">podenv</span><span class="p">:</span><span class="w"> </span><span class="l">pro</span><span class="w"> </span><span class="c">#设置标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodeName</span><span class="p">:</span><span class="w"> </span><span class="l">node1</span><span class="w"> </span><span class="c"># 将目标pod名确指定到node1上</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 启动目标pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pod-podaffinity-target.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-podaffinity-target created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod状况</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods  pod-podaffinity-target -n dev</span>
</span></span><span class="line"><span class="cl">NAME                     READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod-podaffinity-target   1/1     Running   <span class="m">0</span>          4s
</span></span></code></pre></div><p>2）创建 pod-podaffinity-required.yaml，内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-podaffinity-required</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">affinity</span><span class="p">:</span><span class="w"> </span><span class="c">#亲和性设置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">podAffinity</span><span class="p">:</span><span class="w"> </span><span class="c">#设置pod亲和性</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w"> </span><span class="c"># 硬限制</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">labelSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"> </span><span class="c"># 匹配env的值在[&#34;xxx&#34;,&#34;yyy&#34;]中的标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">podenv</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;xxx&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;yyy&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">topologyKey</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/hostname</span><span class="w">
</span></span></span></code></pre></div><p>上面配置表达的意思是：新 Pod 必须要与拥有标签 nodeenv=xxx 或者 nodeenv=yyy 的 pod 在同一 Node 上，显然现在没有这样 pod，接下来，运行测试一下。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 启动pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pod-podaffinity-required.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-podaffinity-required created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod状态，发现未运行</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods pod-podaffinity-required -n dev</span>
</span></span><span class="line"><span class="cl">NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod-podaffinity-required   0/1     Pending   <span class="m">0</span>          9s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看详细信息</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl describe pods pod-podaffinity-required  -n dev</span>
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">Events:
</span></span><span class="line"><span class="cl">  Type     Reason            Age        From               Message
</span></span><span class="line"><span class="cl">  ----     ------            ----       ----               -------
</span></span><span class="line"><span class="cl">  Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/3 nodes are available: <span class="m">2</span> node<span class="o">(</span>s<span class="o">)</span> didn<span class="s1">&#39;t match pod affinity rules, 1 node(s) had taints that the pod didn&#39;</span>t tolerate.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 接下来修改  values: [&#34;xxx&#34;,&#34;yyy&#34;]-----&gt;values:[&#34;pro&#34;,&#34;yyy&#34;]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 意思是：新Pod必须要与拥有标签nodeenv=xxx或者nodeenv=yyy的pod在同一Node上</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># vim pod-podaffinity-required.yaml</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 然后重新创建pod，查看效果</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl delete -f  pod-podaffinity-required.yaml</span>
</span></span><span class="line"><span class="cl">pod <span class="s2">&#34;pod-podaffinity-required&#34;</span> de leted
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pod-podaffinity-required.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-podaffinity-required created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 发现此时Pod运行正常</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods pod-podaffinity-required -n dev</span>
</span></span><span class="line"><span class="cl">NAME                       READY   STATUS    RESTARTS   AGE   LABELS
</span></span><span class="line"><span class="cl">pod-podaffinity-required   1/1     Running   <span class="m">0</span>          6s    &lt;none&gt;
</span></span></code></pre></div><p>关于<code>PodAffinity</code>的 <code>preferredDuringSchedulingIgnoredDuringExecution</code>，这里不再演示。</p>
<p>PodAntiAffinity</p>
<p>PodAntiAffinity 主要实现以运行的 Pod 为参照，让新创建的 Pod 跟参照 pod 不在一个区域中的功能。</p>
<p>它的配置方式和选项跟 PodAffinty 是一样的，这里不再做详细解释，直接做一个测试案例。</p>
<p>1）继续使用上个案例中目标 pod</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev -o wide --show-labels</span>
</span></span><span class="line"><span class="cl">NAME                     READY   STATUS    RESTARTS   AGE     IP            NODE    LABELS
</span></span><span class="line"><span class="cl">pod-podaffinity-required 1/1     Running   <span class="m">0</span>          3m29s   10.244.1.38   node1   &lt;none&gt;
</span></span><span class="line"><span class="cl">pod-podaffinity-target   1/1     Running   <span class="m">0</span>          9m25s   10.244.1.37   node1   <span class="nv">podenv</span><span class="o">=</span>pro
</span></span></code></pre></div><p>2）创建 pod-podantiaffinity-required.yaml，内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-podantiaffinity-required</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">affinity</span><span class="p">:</span><span class="w"> </span><span class="c">#亲和性设置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">podAntiAffinity</span><span class="p">:</span><span class="w"> </span><span class="c">#设置pod亲和性</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w"> </span><span class="c"># 硬限制</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">labelSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"> </span><span class="c"># 匹配podenv的值在[&#34;pro&#34;]中的标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">podenv</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;pro&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">topologyKey</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/hostname</span><span class="w">
</span></span></span></code></pre></div><p>上面配置表达的意思是：新 Pod 必须要与拥有标签 nodeenv=pro 的 pod 不在同一 Node 上，运行测试一下。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pod-podantiaffinity-required.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-podantiaffinity-required created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 发现调度到了node2上</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods pod-podantiaffinity-required -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME                           READY   STATUS    RESTARTS   AGE   IP            NODE   ..
</span></span><span class="line"><span class="cl">pod-podantiaffinity-required   1/1     Running   <span class="m">0</span>          30s   10.244.1.96   node2  ..
</span></span></code></pre></div><h5 id="543-污点和容忍">5.4.3 污点和容忍</h5>
<p>污点（Taints）</p>
<p>前面的调度方式都是站在 Pod 的角度上，通过在 Pod 上添加属性，来确定 Pod 是否要调度到指定的 Node 上，其实我们也可以站在 Node 的角度上，通过在 Node 上添加污点属性，来决定是否允许 Pod 调度过来。</p>
<p>Node 被设置上污点之后就和 Pod 之间存在了一种相斥的关系，进而拒绝 Pod 调度进来，甚至可以将已经存在的 Pod 驱逐出去。</p>
<p>污点的格式为：<code>key=value:effect</code>, key 和 value 是污点的标签，effect 描述污点的作用，支持如下三个选项：</p>
<ul>
<li>PreferNoSchedule：kubernetes 将尽量避免把 Pod 调度到具有该污点的 Node 上，除非没有其他节点可调度</li>
<li>NoSchedule：kubernetes 将不会把 Pod 调度到具有该污点的 Node 上，但不会影响当前 Node 上已存在的 Pod</li>
<li>NoExecute：kubernetes 将不会把 Pod 调度到具有该污点的 Node 上，同时也会将 Node 上已存在的 Pod 驱离</li>
</ul>
<p><a href="/p/2024122601/upload/image-20200605021831545.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200605021831545.png"
	width="692"
	height="147"
	srcset="/p/2024122601/upload/image-20200605021831545_hu5a51efc007aeda269b15057621b16a88_9925_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200605021831545_hu5a51efc007aeda269b15057621b16a88_9925_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200605021606508"
	
>
</a></p>
<p>使用 kubectl 设置和去除污点的命令示例如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 设置污点</span>
</span></span><span class="line"><span class="cl">kubectl taint nodes node1 <span class="nv">key</span><span class="o">=</span>value:effect
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 去除污点</span>
</span></span><span class="line"><span class="cl">kubectl taint nodes node1 key:effect-
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 去除所有污点</span>
</span></span><span class="line"><span class="cl">kubectl taint nodes node1 key-
</span></span></code></pre></div><p>接下来，演示下污点的效果：</p>
<ol>
<li>准备节点 node1（为了演示效果更加明显，暂时停止 node2 节点）</li>
<li>为 node1 节点设置一个污点: <code>tag=heima:PreferNoSchedule</code>；然后创建 pod1( pod1 可以 )</li>
<li>修改为 node1 节点设置一个污点: <code>tag=heima:NoSchedule</code>；然后创建 pod2( pod1 正常 pod2 失败 )</li>
<li>修改为 node1 节点设置一个污点: <code>tag=heima:NoExecute</code>；然后创建 pod3 ( 3 个 pod 都失败 )</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 为node1设置污点(PreferNoSchedule)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl taint nodes node1 tag=heima:PreferNoSchedule</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建pod1</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl run taint1 --image=nginx:1.17.1 -n dev</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME                      READY   STATUS    RESTARTS   AGE     IP           NODE
</span></span><span class="line"><span class="cl">taint1-7665f7fd85-574h4   1/1     Running   <span class="m">0</span>          2m24s   10.244.1.59   node1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 为node1设置污点(取消PreferNoSchedule，设置NoSchedule)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl taint nodes node1 tag:PreferNoSchedule-</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl taint nodes node1 tag=heima:NoSchedule</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建pod2</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl run taint2 --image=nginx:1.17.1 -n dev</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods taint2 -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME                      READY   STATUS    RESTARTS   AGE     IP            NODE
</span></span><span class="line"><span class="cl">taint1-7665f7fd85-574h4   1/1     Running   <span class="m">0</span>          2m24s   10.244.1.59   node1
</span></span><span class="line"><span class="cl">taint2-544694789-6zmlf    0/1     Pending   <span class="m">0</span>          21s     &lt;none&gt;        &lt;none&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 为node1设置污点(取消NoSchedule，设置NoExecute)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl taint nodes node1 tag:NoSchedule-</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl taint nodes node1 tag=heima:NoExecute</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建pod3</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl run taint3 --image=nginx:1.17.1 -n dev</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME                      READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED
</span></span><span class="line"><span class="cl">taint1-7665f7fd85-htkmp   0/1     Pending   <span class="m">0</span>          35s   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;
</span></span><span class="line"><span class="cl">taint2-544694789-bn7wb    0/1     Pending   <span class="m">0</span>          35s   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;
</span></span><span class="line"><span class="cl">taint3-6d78dbd749-tktkq   0/1     Pending   <span class="m">0</span>          6s    &lt;none&gt;   &lt;none&gt;   &lt;none&gt;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">小提示：
</span></span><span class="line"><span class="cl">    使用kubeadm搭建的集群，默认就会给master节点添加一个污点标记,所以pod就不会调度到master节点上.
</span></span></code></pre></div><p>容忍（Toleration）</p>
<p>上面介绍了污点的作用，我们可以在 node 上添加污点用于拒绝 pod 调度上来，但是如果就是想将一个 pod 调度到一个有污点的 node 上去，这时候应该怎么做呢？这就要使用到容忍。</p>
<p><a href="/p/2024122601/upload/image-20200514095913741.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200514095913741.png"
	width="1019"
	height="336"
	srcset="/p/2024122601/upload/image-20200514095913741_huade5136b4005fdc54ce214c34feba929_16124_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200514095913741_huade5136b4005fdc54ce214c34feba929_16124_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200514095913741"
	
>
</a></p>
<blockquote>
<p>污点就是拒绝，容忍就是忽略，Node 通过污点拒绝 pod 调度上去，Pod 通过容忍忽略拒绝</p>
</blockquote>
<p>下面先通过一个案例看下效果：</p>
<ol>
<li>上一小节，已经在 node1 节点上打上了<code>NoExecute</code>的污点，此时 pod 是调度不上去的</li>
<li>本小节，可以通过给 pod 添加容忍，然后将其调度上去</li>
</ol>
<p>创建 pod-toleration.yaml,内容如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-toleration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tolerations</span><span class="p">:</span><span class="w"> </span><span class="c"># 添加容忍</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;tag&#34;</span><span class="w"> </span><span class="c"># 要容忍的污点的key</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Equal&#34;</span><span class="w"> </span><span class="c"># 操作符</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;heima&#34;</span><span class="w"> </span><span class="c"># 容忍的污点的value</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;NoExecute&#34;</span><span class="w"> </span><span class="c"># 添加容忍的规则，这里必须和标记的污点规则相同</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 添加容忍之前的pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME             READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED
</span></span><span class="line"><span class="cl">pod-toleration   0/1     Pending   <span class="m">0</span>          3s    &lt;none&gt;   &lt;none&gt;   &lt;none&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 添加容忍之后的pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME             READY   STATUS    RESTARTS   AGE   IP            NODE    NOMINATED
</span></span><span class="line"><span class="cl">pod-toleration   1/1     Running   <span class="m">0</span>          3s    10.244.1.62   node1   &lt;none&gt;
</span></span></code></pre></div><p>下面看一下容忍的详细配置:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl explain pod.spec.tolerations</span>
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">FIELDS:
</span></span><span class="line"><span class="cl">   key       <span class="c1"># 对应着要容忍的污点的键，空意味着匹配所有的键</span>
</span></span><span class="line"><span class="cl">   value     <span class="c1"># 对应着要容忍的污点的值</span>
</span></span><span class="line"><span class="cl">   operator  <span class="c1"># key-value的运算符，支持Equal和Exists（默认）</span>
</span></span><span class="line"><span class="cl">   effect    <span class="c1"># 对应污点的effect，空意味着匹配所有影响</span>
</span></span><span class="line"><span class="cl">   tolerationSeconds   <span class="c1"># 容忍时间, 当effect为NoExecute时生效，表示pod在Node上的停留时间</span>
</span></span></code></pre></div><h3 id="6-pod-控制器详解">6. Pod 控制器详解</h3>
<h4 id="61-pod-控制器介绍">6.1 Pod 控制器介绍</h4>
<p>Pod 是 kubernetes 的最小管理单元，在 kubernetes 中，按照 pod 的创建方式可以将其分为两类：</p>
<ul>
<li>自主式 pod：kubernetes 直接创建出来的 Pod，这种 pod 删除后就没有了，也不会重建</li>
<li>控制器创建的 pod：kubernetes 通过控制器创建的 pod，这种 pod 删除了之后还会自动重建</li>
</ul>
<blockquote>
<p><code>什么是Pod控制器</code></p>
<p>Pod 控制器是管理 pod 的中间层，使用 Pod 控制器之后，只需要告诉 Pod 控制器，想要多少个什么样的 Pod 就可以了，它会创建出满足条件的 Pod 并确保每一个 Pod 资源处于用户期望的目标状态。如果 Pod 资源在运行中出现故障，它会基于指定策略重新编排 Pod。</p>
</blockquote>
<p>在 kubernetes 中，有很多类型的 pod 控制器，每种都有自己的适合的场景，常见的有下面这些：</p>
<ul>
<li>ReplicationController：比较原始的 pod 控制器，已经被废弃，由 ReplicaSet 替代</li>
<li>ReplicaSet：保证副本数量一直维持在期望值，并支持 pod 数量扩缩容，镜像版本升级</li>
<li>Deployment：通过控制 ReplicaSet 来控制 Pod，并支持滚动升级、回退版本</li>
<li>Horizontal Pod Autoscaler：可以根据集群负载自动水平调整 Pod 的数量，实现削峰填谷</li>
<li>DaemonSet：在集群中的指定 Node 上运行且仅运行一个副本，一般用于守护进程类的任务</li>
<li>Job：它创建出来的 pod 只要完成任务就立即退出，不需要重启或重建，用于执行一次性任务</li>
<li>Cronjob：它创建的 Pod 负责周期性任务控制，不需要持续后台运行</li>
<li>StatefulSet：管理有状态应用</li>
</ul>
<h4 id="62-replicasetrs">6.2 ReplicaSet(RS)</h4>
<p>ReplicaSet 的主要作用是保证一定数量的 pod 正常运行，它会持续监听这些 Pod 的运行状态，一旦 Pod 发生故障，就会重启或重建。同时它还支持对 pod 数量的扩缩容和镜像版本的升降级。</p>
<p><a href="/p/2024122601/upload/image-20200612005334159.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200612005334159.png"
	width="600"
	height="185"
	srcset="/p/2024122601/upload/image-20200612005334159_hufe45370f8ae481feef822ee9af6b53ad_4419_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200612005334159_hufe45370f8ae481feef822ee9af6b53ad_4419_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<p>ReplicaSet 的资源清单文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w"> </span><span class="c"># 版本号</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ReplicaSet</span><span class="w"> </span><span class="c"># 类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># 元数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="c"># rs名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="c"># 所属命名空间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c">#标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">controller</span><span class="p">:</span><span class="w"> </span><span class="l">rs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># 详情描述</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 副本数量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="c"># 选择器，通过它指定该控制器管理哪些pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w"> </span><span class="c"># Labels匹配规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"> </span><span class="c"># Expressions匹配规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- {<span class="w"> </span><span class="nt">key: app, operator: In, values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">nginx-pod] }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="c"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><p>在这里面，需要新了解的配置项就是<code>spec</code>下面几个选项：</p>
<ul>
<li>
<p>replicas：指定副本数量，其实就是当前 rs 创建出来的 pod 的数量，默认为 1</p>
</li>
<li>
<p>selector：选择器，它的作用是建立 pod 控制器和 pod 之间的关联关系，采用的 Label Selector 机制</p>
<p>在 pod 模板上定义 label，在控制器上定义选择器，就可以表明当前控制器能管理哪些 pod 了</p>
</li>
<li>
<p>template：模板，就是当前控制器创建 pod 所使用的模板板，里面其实就是前一章学过的 pod 的定义</p>
</li>
</ul>
<p>创建 ReplicaSet</p>
<p>创建 pc-replicaset.yaml 文件，内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ReplicaSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pc-replicaset</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建rs</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pc-replicaset.yaml</span>
</span></span><span class="line"><span class="cl">replicaset.apps/pc-replicaset created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看rs</span>
</span></span><span class="line"><span class="cl"><span class="c1"># DESIRED:期望副本数量</span>
</span></span><span class="line"><span class="cl"><span class="c1"># CURRENT:当前副本数量</span>
</span></span><span class="line"><span class="cl"><span class="c1"># READY:已经准备好提供服务的副本数量</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get rs pc-replicaset -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME          DESIRED   CURRENT READY AGE   CONTAINERS   IMAGES             SELECTOR
</span></span><span class="line"><span class="cl">pc-replicaset <span class="m">3</span>         <span class="m">3</span>       <span class="m">3</span>     22s   nginx        nginx:1.17.1       <span class="nv">app</span><span class="o">=</span>nginx-pod
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看当前控制器创建出来的pod</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 这里发现控制器创建出来的pod的名称是在控制器名称后面拼接了-xxxxx随机码</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pod -n dev</span>
</span></span><span class="line"><span class="cl">NAME                          READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-replicaset-6vmvt   1/1     Running   <span class="m">0</span>          54s
</span></span><span class="line"><span class="cl">pc-replicaset-fmb8f   1/1     Running   <span class="m">0</span>          54s
</span></span><span class="line"><span class="cl">pc-replicaset-snrk2   1/1     Running   <span class="m">0</span>          54s
</span></span></code></pre></div><p>扩缩容</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 编辑rs的副本数量，修改spec:replicas: 6即可</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl edit rs pc-replicaset -n dev</span>
</span></span><span class="line"><span class="cl">replicaset.apps/pc-replicaset edited
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">NAME                          READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-replicaset-6vmvt   1/1     Running   <span class="m">0</span>          114m
</span></span><span class="line"><span class="cl">pc-replicaset-cftnp   1/1     Running   <span class="m">0</span>          10s
</span></span><span class="line"><span class="cl">pc-replicaset-fjlm6   1/1     Running   <span class="m">0</span>          10s
</span></span><span class="line"><span class="cl">pc-replicaset-fmb8f   1/1     Running   <span class="m">0</span>          114m
</span></span><span class="line"><span class="cl">pc-replicaset-s2whj   1/1     Running   <span class="m">0</span>          10s
</span></span><span class="line"><span class="cl">pc-replicaset-snrk2   1/1     Running   <span class="m">0</span>          114m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 当然也可以直接使用命令实现</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 使用scale命令实现扩缩容， 后面--replicas=n直接指定目标数量即可</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl scale rs pc-replicaset --replicas=2 -n dev</span>
</span></span><span class="line"><span class="cl">replicaset.apps/pc-replicaset scaled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 命令运行完毕，立即查看，发现已经有4个开始准备退出了</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">NAME                       READY   STATUS        RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-replicaset-6vmvt   0/1     Terminating   <span class="m">0</span>          118m
</span></span><span class="line"><span class="cl">pc-replicaset-cftnp   0/1     Terminating   <span class="m">0</span>          4m17s
</span></span><span class="line"><span class="cl">pc-replicaset-fjlm6   0/1     Terminating   <span class="m">0</span>          4m17s
</span></span><span class="line"><span class="cl">pc-replicaset-fmb8f   1/1     Running       <span class="m">0</span>          118m
</span></span><span class="line"><span class="cl">pc-replicaset-s2whj   0/1     Terminating   <span class="m">0</span>          4m17s
</span></span><span class="line"><span class="cl">pc-replicaset-snrk2   1/1     Running       <span class="m">0</span>          118m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#稍等片刻，就只剩下2个了</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-replicaset-fmb8f   1/1     Running   <span class="m">0</span>          119m
</span></span><span class="line"><span class="cl">pc-replicaset-snrk2   1/1     Running   <span class="m">0</span>          119m
</span></span></code></pre></div><p>镜像升级</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 编辑rs的容器镜像 - image: nginx:1.17.2</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl edit rs pc-replicaset -n dev</span>
</span></span><span class="line"><span class="cl">replicaset.apps/pc-replicaset edited
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 再次查看，发现镜像版本已经变更了</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get rs -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME                DESIRED  CURRENT   READY   AGE    CONTAINERS   IMAGES        ...
</span></span><span class="line"><span class="cl">pc-replicaset       <span class="m">2</span>        <span class="m">2</span>         <span class="m">2</span>       140m   nginx         nginx:1.17.2  ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 同样的道理，也可以使用命令完成这个工作</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kubectl set image rs rs名称 容器=镜像版本 -n namespace</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl set image rs pc-replicaset nginx=nginx:1.17.1  -n dev</span>
</span></span><span class="line"><span class="cl">replicaset.apps/pc-replicaset image updated
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 再次查看，发现镜像版本已经变更了</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get rs -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME                 DESIRED  CURRENT   READY   AGE    CONTAINERS   IMAGES            ...
</span></span><span class="line"><span class="cl">pc-replicaset        <span class="m">2</span>        <span class="m">2</span>         <span class="m">2</span>       145m   nginx        nginx:1.17.1 ...
</span></span></code></pre></div><p>删除 ReplicaSet</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 使用kubectl delete命令会删除此RS以及它管理的Pod</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 在kubernetes删除RS前，会将RS的replicasclear调整为0，等待所有的Pod被删除后，在执行RS对象的删除</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl delete rs pc-replicaset -n dev</span>
</span></span><span class="line"><span class="cl">replicaset.apps <span class="s2">&#34;pc-replicaset&#34;</span> deleted
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pod -n dev -o wide</span>
</span></span><span class="line"><span class="cl">No resources found in dev namespace.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 如果希望仅仅删除RS对象（保留Pod），可以使用kubectl delete命令时添加--cascade=false选项（不推荐）。</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl delete rs pc-replicaset -n dev --cascade=false</span>
</span></span><span class="line"><span class="cl">replicaset.apps <span class="s2">&#34;pc-replicaset&#34;</span> deleted
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">NAME                  READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-replicaset-cl82j   1/1     Running   <span class="m">0</span>          75s
</span></span><span class="line"><span class="cl">pc-replicaset-dslhb   1/1     Running   <span class="m">0</span>          75s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 也可以使用yaml直接删除(推荐)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl delete -f pc-replicaset.yaml</span>
</span></span><span class="line"><span class="cl">replicaset.apps <span class="s2">&#34;pc-replicaset&#34;</span> deleted
</span></span></code></pre></div><h4 id="63-deploymentdeploy">6.3 Deployment(Deploy)</h4>
<p>为了更好的解决服务编排的问题，kubernetes 在 V1.2 版本开始，引入了 Deployment 控制器。值得一提的是，这种控制器并不直接管理 pod，而是通过管理 ReplicaSet 来简介管理 Pod，即：Deployment 管理 ReplicaSet，ReplicaSet 管理 Pod。所以 Deployment 比 ReplicaSet 功能更加强大。</p>
<p><a href="/p/2024122601/upload/image-20200612005524778.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200612005524778.png"
	width="608"
	height="206"
	srcset="/p/2024122601/upload/image-20200612005524778_hud43071761019297f6d1f1cb8c1d0e82d_5031_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200612005524778_hud43071761019297f6d1f1cb8c1d0e82d_5031_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<p>Deployment 主要功能有下面几个：</p>
<ul>
<li>支持 ReplicaSet 的所有功能</li>
<li>支持发布的停止、继续</li>
<li>支持滚动升级和回滚版本</li>
</ul>
<p>Deployment 的资源清单文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w"> </span><span class="c"># 版本号</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w"> </span><span class="c"># 类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># 元数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="c"># rs名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="c"># 所属命名空间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c">#标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">controller</span><span class="p">:</span><span class="w"> </span><span class="l">deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># 详情描述</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 副本数量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 保留历史版本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">paused</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c"># 暂停部署，默认是false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">progressDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">600</span><span class="w"> </span><span class="c"># 部署超时时间（s），默认是600</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w"> </span><span class="c"># 策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w"> </span><span class="c"># 滚动更新策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w"> </span><span class="c"># 滚动更新</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">max违规词汇</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="l">%</span><span class="w"> </span><span class="c"># 最大额外可以存在的副本数，可以为百分比，也可以为整数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="l">%</span><span class="w"> </span><span class="c"># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="c"># 选择器，通过它指定该控制器管理哪些pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w"> </span><span class="c"># Labels匹配规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"> </span><span class="c"># Expressions匹配规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- {<span class="w"> </span><span class="nt">key: app, operator: In, values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">nginx-pod] }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="c"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><h5 id="631-创建-deployment">6.3.1 创建 deployment</h5>
<p>创建 pc-deployment.yaml，内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pc-deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建deployment</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pc-deployment.yaml --record=true</span>
</span></span><span class="line"><span class="cl">deployment.apps/pc-deployment created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看deployment</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UP-TO-DATE 最新版本的pod的数量</span>
</span></span><span class="line"><span class="cl"><span class="c1"># AVAILABLE  当前可用的pod的数量</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get deploy pc-deployment -n dev</span>
</span></span><span class="line"><span class="cl">NAME            READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">pc-deployment   3/3     <span class="m">3</span>            <span class="m">3</span>           15s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看rs</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 发现rs的名称是在原来deployment的名字后面添加了一个10位数的随机串</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get rs -n dev</span>
</span></span><span class="line"><span class="cl">NAME                       DESIRED   CURRENT   READY   AGE
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78   <span class="m">3</span>         <span class="m">3</span>         <span class="m">3</span>       23s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-d2c8n   1/1     Running   <span class="m">0</span>          107s
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-smpvp   1/1     Running   <span class="m">0</span>          107s
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-wvjd8   1/1     Running   <span class="m">0</span>          107s
</span></span></code></pre></div><h5 id="632-扩缩容">6.3.2 扩缩容</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 变更副本数量为5个</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl scale deploy pc-deployment --replicas=5  -n dev</span>
</span></span><span class="line"><span class="cl">deployment.apps/pc-deployment scaled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看deployment</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get deploy pc-deployment -n dev</span>
</span></span><span class="line"><span class="cl">NAME            READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">pc-deployment   5/5     <span class="m">5</span>            <span class="m">5</span>           2m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1">#  kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-d2c8n   1/1     Running   <span class="m">0</span>          4m19s
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-jxmdq   1/1     Running   <span class="m">0</span>          94s
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-mktqv   1/1     Running   <span class="m">0</span>          93s
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-smpvp   1/1     Running   <span class="m">0</span>          4m19s
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-wvjd8   1/1     Running   <span class="m">0</span>          4m19s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 编辑deployment的副本数量，修改spec:replicas: 4即可</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl edit deploy pc-deployment -n dev</span>
</span></span><span class="line"><span class="cl">deployment.apps/pc-deployment edited
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-d2c8n   1/1     Running   <span class="m">0</span>          5m23s
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-jxmdq   1/1     Running   <span class="m">0</span>          2m38s
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-smpvp   1/1     Running   <span class="m">0</span>          5m23s
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-wvjd8   1/1     Running   <span class="m">0</span>          5m23s
</span></span></code></pre></div><p>镜像更新</p>
<p>deployment 支持两种更新策略:<code>重建更新</code>和<code>滚动更新</code>,可以通过<code>strategy</code>指定策略类型,支持两个属性:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">strategy：指定新的 Pod 替换旧的 Pod 的策略， 支持两个属性：
</span></span><span class="line"><span class="cl">type：指定策略类型，支持两种策略
</span></span><span class="line"><span class="cl">Recreate：在创建出新的 Pod 之前会先杀掉所有已存在的 Pod
</span></span><span class="line"><span class="cl">RollingUpdate：滚动更新，就是杀死一部分，就启动一部分，在更新过程中，存在两个版本 Pod
</span></span><span class="line"><span class="cl">rollingUpdate：当 type 为 RollingUpdate 时生效，用于为 RollingUpdate 设置参数，支持两个属性：
</span></span><span class="line"><span class="cl">maxUnavailable：用来指定在升级过程中不可用 Pod 的最大数量，默认为 25%。
</span></span><span class="line"><span class="cl">max 违规词汇： 用来指定在升级过程中可以超过期望的 Pod 的最大数量，默认为 25%。
</span></span></code></pre></div><p>重建更新</p>
<ol>
<li>编辑 pc-deployment.yaml,在 spec 节点下添加更新策略</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w"> </span><span class="c"># 策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Recreate</span><span class="w"> </span><span class="c"># 重建更新</span><span class="w">
</span></span></span></code></pre></div><p>创建 deploy 进行验证</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 变更镜像</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl set image deployment pc-deployment nginx=nginx:1.17.2 -n dev</span>
</span></span><span class="line"><span class="cl">deployment.apps/pc-deployment image updated
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 观察升级过程</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1">#  kubectl get pods -n dev -w</span>
</span></span><span class="line"><span class="cl">NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-deployment-5d89bdfbf9-65qcw   1/1     Running   <span class="m">0</span>          31s
</span></span><span class="line"><span class="cl">pc-deployment-5d89bdfbf9-w5nzv   1/1     Running   <span class="m">0</span>          31s
</span></span><span class="line"><span class="cl">pc-deployment-5d89bdfbf9-xpt7w   1/1     Running   <span class="m">0</span>          31s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pc-deployment-5d89bdfbf9-xpt7w   1/1     Terminating   <span class="m">0</span>          41s
</span></span><span class="line"><span class="cl">pc-deployment-5d89bdfbf9-65qcw   1/1     Terminating   <span class="m">0</span>          41s
</span></span><span class="line"><span class="cl">pc-deployment-5d89bdfbf9-w5nzv   1/1     Terminating   <span class="m">0</span>          41s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pc-deployment-675d469f8b-grn8z   0/1     Pending       <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-deployment-675d469f8b-hbl4v   0/1     Pending       <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-deployment-675d469f8b-67nz2   0/1     Pending       <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pc-deployment-675d469f8b-grn8z   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-deployment-675d469f8b-hbl4v   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-deployment-675d469f8b-67nz2   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pc-deployment-675d469f8b-grn8z   1/1     Running             <span class="m">0</span>          1s
</span></span><span class="line"><span class="cl">pc-deployment-675d469f8b-67nz2   1/1     Running             <span class="m">0</span>          1s
</span></span><span class="line"><span class="cl">pc-deployment-675d469f8b-hbl4v   1/1     Running             <span class="m">0</span>          2s
</span></span></code></pre></div><p>滚动更新</p>
<ol>
<li>编辑 pc-deployment.yaml,在 spec 节点下添加更新策略</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w"> </span><span class="c"># 策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w"> </span><span class="c"># 滚动更新策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">max违规词汇</span><span class="p">:</span><span class="w"> </span><span class="m">25</span><span class="l">%</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">25</span><span class="l">%</span><span class="w">
</span></span></span></code></pre></div><p>创建 deploy 进行验证</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 变更镜像</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl set image deployment pc-deployment nginx=nginx:1.17.3 -n dev</span>
</span></span><span class="line"><span class="cl">deployment.apps/pc-deployment image updated
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 观察升级过程</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev -w</span>
</span></span><span class="line"><span class="cl">NAME                           READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-deployment-c848d767-8rbzt   1/1     Running   <span class="m">0</span>          31m
</span></span><span class="line"><span class="cl">pc-deployment-c848d767-h4p68   1/1     Running   <span class="m">0</span>          31m
</span></span><span class="line"><span class="cl">pc-deployment-c848d767-hlmz4   1/1     Running   <span class="m">0</span>          31m
</span></span><span class="line"><span class="cl">pc-deployment-c848d767-rrqcn   1/1     Running   <span class="m">0</span>          31m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pc-deployment-966bf7f44-226rx   0/1     Pending             <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-deployment-966bf7f44-226rx   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-deployment-966bf7f44-226rx   1/1     Running             <span class="m">0</span>          1s
</span></span><span class="line"><span class="cl">pc-deployment-c848d767-h4p68    0/1     Terminating         <span class="m">0</span>          34m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pc-deployment-966bf7f44-cnd44   0/1     Pending             <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-deployment-966bf7f44-cnd44   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-deployment-966bf7f44-cnd44   1/1     Running             <span class="m">0</span>          2s
</span></span><span class="line"><span class="cl">pc-deployment-c848d767-hlmz4    0/1     Terminating         <span class="m">0</span>          34m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pc-deployment-966bf7f44-px48p   0/1     Pending             <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-deployment-966bf7f44-px48p   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-deployment-966bf7f44-px48p   1/1     Running             <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-deployment-c848d767-8rbzt    0/1     Terminating         <span class="m">0</span>          34m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pc-deployment-966bf7f44-dkmqp   0/1     Pending             <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-deployment-966bf7f44-dkmqp   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-deployment-966bf7f44-dkmqp   1/1     Running             <span class="m">0</span>          2s
</span></span><span class="line"><span class="cl">pc-deployment-c848d767-rrqcn    0/1     Terminating         <span class="m">0</span>          34m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 至此，新版本的pod创建完毕，就版本的pod销毁完毕</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 中间过程是滚动进行的，也就是边销毁边创建</span>
</span></span></code></pre></div><p>滚动更新的过程：</p>
<p><a href="/p/2024122601/upload/image-20200416140251491.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200416140251491.png"
	width="1118"
	height="527"
	srcset="/p/2024122601/upload/image-20200416140251491_hub44c56d9c257816e6ad47c6c128b3f34_39494_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200416140251491_hub44c56d9c257816e6ad47c6c128b3f34_39494_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<p>镜像更新中 rs 的变化</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 查看rs,发现原来的rs的依旧存在，只是pod数量变为了0，而后又新产生了一个rs，pod数量为4</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 其实这就是deployment能够进行版本回退的奥妙所在，后面会详细解释</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get rs -n dev</span>
</span></span><span class="line"><span class="cl">NAME                       DESIRED   CURRENT   READY   AGE
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78   <span class="m">0</span>         <span class="m">0</span>         <span class="m">0</span>       7m37s
</span></span><span class="line"><span class="cl">pc-deployment-6696798b11   <span class="m">0</span>         <span class="m">0</span>         <span class="m">0</span>       5m37s
</span></span><span class="line"><span class="cl">pc-deployment-c848d76789   <span class="m">4</span>         <span class="m">4</span>         <span class="m">4</span>       72s
</span></span></code></pre></div><h5 id="633-版本回退">6.3.3 版本回退</h5>
<p>deployment 支持版本升级过程中的暂停、继续功能以及版本回退等诸多功能，下面具体来看.</p>
<p>kubectl rollout： 版本升级相关功能，支持下面的选项：</p>
<ul>
<li>status 显示当前升级状态</li>
<li>history 显示 升级历史记录</li>
<li>pause 暂停版本升级过程</li>
<li>resume 继续已经暂停的版本升级过程</li>
<li>restart 重启版本升级过程</li>
<li>undo 回滚到上一级版本（可以使用&ndash;to-revision 回滚到指定版本）</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 查看当前升级版本的状态</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl rollout status deploy pc-deployment -n dev</span>
</span></span><span class="line"><span class="cl">deployment <span class="s2">&#34;pc-deployment&#34;</span> successfully rolled out
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看升级历史记录</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl rollout history deploy pc-deployment -n dev</span>
</span></span><span class="line"><span class="cl">deployment.apps/pc-deployment
</span></span><span class="line"><span class="cl">REVISION  CHANGE-CAUSE
</span></span><span class="line"><span class="cl"><span class="m">1</span>         kubectl create --filename<span class="o">=</span>pc-deployment.yaml --record<span class="o">=</span><span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span>         kubectl create --filename<span class="o">=</span>pc-deployment.yaml --record<span class="o">=</span><span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span>         kubectl create --filename<span class="o">=</span>pc-deployment.yaml --record<span class="o">=</span><span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 可以发现有三次版本记录，说明完成过两次升级</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 版本回滚</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 这里直接使用--to-revision=1回滚到了1版本， 如果省略这个选项，就是回退到上个版本，就是2版本</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl rollout undo deployment pc-deployment --to-revision=1 -n dev</span>
</span></span><span class="line"><span class="cl">deployment.apps/pc-deployment rolled back
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看发现，通过nginx镜像版本可以发现到了第一版</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get deploy -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME            READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES
</span></span><span class="line"><span class="cl">pc-deployment   4/4     <span class="m">4</span>            <span class="m">4</span>           74m   nginx        nginx:1.17.1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看rs，发现第一个rs中有4个pod运行，后面两个版本的rs中pod为运行</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 其实deployment之所以可是实现版本的回滚，就是通过记录下历史rs来实现的，</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 一旦想回滚到哪个版本，只需要将当前版本pod数量降为0，然后将回滚版本的pod提升为目标数量就可以了</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get rs -n dev</span>
</span></span><span class="line"><span class="cl">NAME                       DESIRED   CURRENT   READY   AGE
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78   <span class="m">4</span>         <span class="m">4</span>         <span class="m">4</span>       78m
</span></span><span class="line"><span class="cl">pc-deployment-966bf7f44    <span class="m">0</span>         <span class="m">0</span>         <span class="m">0</span>       37m
</span></span><span class="line"><span class="cl">pc-deployment-c848d767     <span class="m">0</span>         <span class="m">0</span>         <span class="m">0</span>       71m
</span></span></code></pre></div><h5 id="634-金丝雀发布">6.3.4 金丝雀发布</h5>
<p>Deployment 控制器支持控制更新过程中的控制，如“暂停(pause)”或“继续(resume)”更新操作。</p>
<p>比如有一批新的 Pod 资源创建完成后立即暂停更新过程，此时，仅存在一部分新版本的应用，主体部分还是旧的版本。然后，再筛选一小部分的用户请求路由到新版本的 Pod 应用，继续观察能否稳定地按期望的方式运行。确定没问题之后再继续完成余下的 Pod 资源滚动更新，否则立即回滚更新操作。这就是所谓的金丝雀发布。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 更新deployment的版本，并配置暂停deployment</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1">#  kubectl set image deploy pc-deployment nginx=nginx:1.17.4 -n dev &amp;&amp; kubectl rollout pause deployment pc-deployment  -n dev</span>
</span></span><span class="line"><span class="cl">deployment.apps/pc-deployment image updated
</span></span><span class="line"><span class="cl">deployment.apps/pc-deployment paused
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#观察更新状态</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl rollout status deploy pc-deployment -n dev　</span>
</span></span><span class="line"><span class="cl">Waiting <span class="k">for</span> deployment <span class="s2">&#34;pc-deployment&#34;</span> rollout to finish: <span class="m">2</span> out of <span class="m">4</span> new replicas have been updated...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 监控更新的过程，可以看到已经新增了一个资源，但是并未按照预期的状态去删除一个旧的资源，就是因为使用了pause暂停命令</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get rs -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME                       DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES
</span></span><span class="line"><span class="cl">pc-deployment-5d89bdfbf9   <span class="m">3</span>         <span class="m">3</span>         <span class="m">3</span>       19m     nginx        nginx:1.17.1
</span></span><span class="line"><span class="cl">pc-deployment-675d469f8b   <span class="m">0</span>         <span class="m">0</span>         <span class="m">0</span>       14m     nginx        nginx:1.17.2
</span></span><span class="line"><span class="cl">pc-deployment-6c9f56fcfb   <span class="m">2</span>         <span class="m">2</span>         <span class="m">2</span>       3m16s   nginx        nginx:1.17.4
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-deployment-5d89bdfbf9-rj8sq   1/1     Running   <span class="m">0</span>          7m33s
</span></span><span class="line"><span class="cl">pc-deployment-5d89bdfbf9-ttwgg   1/1     Running   <span class="m">0</span>          7m35s
</span></span><span class="line"><span class="cl">pc-deployment-5d89bdfbf9-v4wvc   1/1     Running   <span class="m">0</span>          7m34s
</span></span><span class="line"><span class="cl">pc-deployment-6c9f56fcfb-996rt   1/1     Running   <span class="m">0</span>          3m31s
</span></span><span class="line"><span class="cl">pc-deployment-6c9f56fcfb-j2gtj   1/1     Running   <span class="m">0</span>          3m31s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 确保更新的pod没问题了，继续更新</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl rollout resume deploy pc-deployment -n dev</span>
</span></span><span class="line"><span class="cl">deployment.apps/pc-deployment resumed
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看最后的更新情况</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get rs -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME                       DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES
</span></span><span class="line"><span class="cl">pc-deployment-5d89bdfbf9   <span class="m">0</span>         <span class="m">0</span>         <span class="m">0</span>       21m     nginx        nginx:1.17.1
</span></span><span class="line"><span class="cl">pc-deployment-675d469f8b   <span class="m">0</span>         <span class="m">0</span>         <span class="m">0</span>       16m     nginx        nginx:1.17.2
</span></span><span class="line"><span class="cl">pc-deployment-6c9f56fcfb   <span class="m">4</span>         <span class="m">4</span>         <span class="m">4</span>       5m11s   nginx        nginx:1.17.4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-deployment-6c9f56fcfb-7bfwh   1/1     Running   <span class="m">0</span>          37s
</span></span><span class="line"><span class="cl">pc-deployment-6c9f56fcfb-996rt   1/1     Running   <span class="m">0</span>          5m27s
</span></span><span class="line"><span class="cl">pc-deployment-6c9f56fcfb-j2gtj   1/1     Running   <span class="m">0</span>          5m27s
</span></span><span class="line"><span class="cl">pc-deployment-6c9f56fcfb-rf84v   1/1     Running   <span class="m">0</span>          37s
</span></span></code></pre></div><p>删除 Deployment</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 删除deployment，其下的rs和pod也将被删除</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl delete -f pc-deployment.yaml</span>
</span></span><span class="line"><span class="cl">deployment.apps <span class="s2">&#34;pc-deployment&#34;</span> deleted
</span></span></code></pre></div><h4 id="64-horizontal-pod-autoscalerhpa">6.4 Horizontal Pod Autoscaler(HPA)</h4>
<p>在前面的课程中，我们已经可以实现通过手工执行<code>kubectl scale</code>命令实现 Pod 扩容或缩容，但是这显然不符合 Kubernetes 的定位目标&ndash;自动化、智能化。 Kubernetes 期望可以实现通过监测 Pod 的使用情况，实现 pod 数量的自动调整，于是就产生了 Horizontal Pod Autoscaler（HPA）这种控制器。</p>
<p>HPA 可以获取每个 Pod 利用率，然后和 HPA 中定义的指标进行对比，同时计算出需要伸缩的具体值，最后实现 Pod 的数量的调整。其实 HPA 与之前的 Deployment 一样，也属于一种 Kubernetes 资源对象，它通过追踪分析 RC 控制的所有目标 Pod 的负载变化情况，来确定是否需要针对性地调整目标 Pod 的副本数，这是 HPA 的实现原理。</p>
<p><a href="/p/2024122601/upload/image-20200608155858271.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200608155858271.png"
	width="622"
	height="374"
	srcset="/p/2024122601/upload/image-20200608155858271_hu10ca9ab70838dc6de21c532deae1248f_13860_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200608155858271_hu10ca9ab70838dc6de21c532deae1248f_13860_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<p>接下来，我们来做一个实验</p>
<h5 id="641-安装-metrics-server">6.4.1 安装 metrics-server</h5>
<p>metrics-server 可以用来收集集群中的资源使用情况</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 安装git</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># yum install git -y</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 获取metrics-server, 注意使用的版本</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># git clone -b v0.3.6 https:/github.com/kubernetes-incubator/metrics-server</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 修改deployment, 注意修改的是镜像和初始化参数</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># cd /root/metrics-server/deploy/1.8+/</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 1.8+<span class="o">]</span><span class="c1"># vim metrics-server-deployment.yaml</span>
</span></span><span class="line"><span class="cl">按图中添加下面选项
</span></span><span class="line"><span class="cl">hostNetwork: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">image: registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.6
</span></span><span class="line"><span class="cl">args:
</span></span><span class="line"><span class="cl">- --kubelet-insecure-tls
</span></span><span class="line"><span class="cl">- --kubelet-preferred-address-types<span class="o">=</span>InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP
</span></span></code></pre></div><p><a href="/p/2024122601/upload/image-20200608163326496.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200608163326496.png"
	width="1458"
	height="418"
	srcset="/p/2024122601/upload/image-20200608163326496_hu06102fbd36b6cc6922830d89d5093372_18406_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200608163326496_hu06102fbd36b6cc6922830d89d5093372_18406_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200608163326496"
	
>
</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 安装metrics-server</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 1.8+<span class="o">]</span><span class="c1"># kubectl apply -f ./</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod运行情况</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 1.8+<span class="o">]</span><span class="c1"># kubectl get pod -n kube-system</span>
</span></span><span class="line"><span class="cl">metrics-server-6b976979db-2xwbj   1/1     Running   <span class="m">0</span>          90s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 使用kubectl top node 查看资源使用情况</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 1.8+<span class="o">]</span><span class="c1"># kubectl top node</span>
</span></span><span class="line"><span class="cl">NAME           CPU<span class="o">(</span>cores<span class="o">)</span>   CPU%   MEMORY<span class="o">(</span>bytes<span class="o">)</span>   MEMORY%
</span></span><span class="line"><span class="cl">k8s-master01   289m         14%    1582Mi          54%
</span></span><span class="line"><span class="cl">k8s-node01     81m          4%     1195Mi          40%
</span></span><span class="line"><span class="cl">k8s-node02     72m          3%     1211Mi          41%
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 1.8+<span class="o">]</span><span class="c1"># kubectl top pod -n kube-system</span>
</span></span><span class="line"><span class="cl">NAME                              CPU<span class="o">(</span>cores<span class="o">)</span>   MEMORY<span class="o">(</span>bytes<span class="o">)</span>
</span></span><span class="line"><span class="cl">coredns-6955765f44-7ptsb          3m           9Mi
</span></span><span class="line"><span class="cl">coredns-6955765f44-vcwr5          3m           8Mi
</span></span><span class="line"><span class="cl">etcd-master                       14m          145Mi
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="c1"># 至此,metrics-server安装完成</span>
</span></span></code></pre></div><h5 id="642-准备-deployment-和-servie">6.4.2 准备 deployment 和 servie</h5>
<p>创建 pc-hpa-pod.yaml 文件，内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w"> </span><span class="c"># 策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w"> </span><span class="c"># 滚动更新策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="c"># 资源配额</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">limits</span><span class="p">:</span><span class="w"> </span><span class="c"># 限制资源（上限）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w"> </span><span class="c"># CPU限制，单位是core数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">requests</span><span class="p">:</span><span class="w"> </span><span class="c"># 请求资源（下限）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;100m&#34;</span><span class="w"> </span><span class="c"># CPU限制，单位是core数</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建deployment</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 1.8+<span class="o">]</span><span class="c1"># kubectl run nginx --image=nginx:1.17.1 --requests=cpu=100m -n dev</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 创建service</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 1.8+<span class="o">]</span><span class="c1"># kubectl expose deployment nginx --type=NodePort --port=80 -n dev</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 查看</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 1.8+<span class="o">]</span><span class="c1"># kubectl get deployment,pod,svc -n dev</span>
</span></span><span class="line"><span class="cl">NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">deployment.apps/nginx   1/1     <span class="m">1</span>            <span class="m">1</span>           47s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                         READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod/nginx-7df9756ccc-bh8dr   1/1     Running   <span class="m">0</span>          47s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>        AGE
</span></span><span class="line"><span class="cl">service/nginx   NodePort   10.101.18.29   &lt;none&gt;        80:31830/TCP   35s
</span></span></code></pre></div><h5 id="643-部署-hpa">6.4.3 部署 HPA</h5>
<p>创建 pc-hpa.yaml 文件，内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">autoscaling/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">HorizontalPodAutoscaler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pc-hpa</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">minReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c">#最小pod数量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">maxReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="c">#最大pod数量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">targetCPUUtilizationPercentage</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># CPU使用率指标</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">scaleTargetRef</span><span class="p">:</span><span class="w"> </span><span class="c"># 指定要控制的nginx信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建hpa</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 1.8+<span class="o">]</span><span class="c1"># kubectl create -f pc-hpa.yaml</span>
</span></span><span class="line"><span class="cl">horizontalpodautoscaler.autoscaling/pc-hpa created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看hpa</span>
</span></span><span class="line"><span class="cl">    <span class="o">[</span>root@k8s-master01 1.8+<span class="o">]</span><span class="c1"># kubectl get hpa -n dev</span>
</span></span><span class="line"><span class="cl">NAME     REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
</span></span><span class="line"><span class="cl">pc-hpa   Deployment/nginx   0%/3%     <span class="m">1</span>         <span class="m">10</span>        <span class="m">1</span>          62s
</span></span></code></pre></div><h5 id="644-测试">6.4.4 测试</h5>
<p>使用压测工具对 service 地址<code>192.168.5.4:31830</code>进行压测，然后通过控制台查看 hpa 和 pod 的变化</p>
<p>hpa 变化</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get hpa -n dev -w</span>
</span></span><span class="line"><span class="cl">NAME   REFERENCE      TARGETS  MINPODS  MAXPODS  REPLICAS  AGE
</span></span><span class="line"><span class="cl">pc-hpa  Deployment/nginx  0%/3%   <span class="m">1</span>     <span class="m">10</span>     <span class="m">1</span>      4m11s
</span></span><span class="line"><span class="cl">pc-hpa  Deployment/nginx  0%/3%   <span class="m">1</span>     <span class="m">10</span>     <span class="m">1</span>      5m19s
</span></span><span class="line"><span class="cl">pc-hpa  Deployment/nginx  22%/3%   <span class="m">1</span>     <span class="m">10</span>     <span class="m">1</span>      6m50s
</span></span><span class="line"><span class="cl">pc-hpa  Deployment/nginx  22%/3%   <span class="m">1</span>     <span class="m">10</span>     <span class="m">4</span>      7m5s
</span></span><span class="line"><span class="cl">pc-hpa  Deployment/nginx  22%/3%   <span class="m">1</span>     <span class="m">10</span>     <span class="m">8</span>      7m21s
</span></span><span class="line"><span class="cl">pc-hpa  Deployment/nginx  6%/3%   <span class="m">1</span>     <span class="m">10</span>     <span class="m">8</span>      7m51s
</span></span><span class="line"><span class="cl">pc-hpa  Deployment/nginx  0%/3%   <span class="m">1</span>     <span class="m">10</span>     <span class="m">8</span>      9m6s
</span></span><span class="line"><span class="cl">pc-hpa  Deployment/nginx  0%/3%   <span class="m">1</span>     <span class="m">10</span>     <span class="m">8</span>      13m
</span></span><span class="line"><span class="cl">pc-hpa  Deployment/nginx  0%/3%   <span class="m">1</span>     <span class="m">10</span>     <span class="m">1</span>      14m
</span></span></code></pre></div><p>deployment 变化</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get deployment -n dev -w</span>
</span></span><span class="line"><span class="cl">NAME    READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">nginx   1/1     <span class="m">1</span>            <span class="m">1</span>           11m
</span></span><span class="line"><span class="cl">nginx   1/4     <span class="m">1</span>            <span class="m">1</span>           13m
</span></span><span class="line"><span class="cl">nginx   1/4     <span class="m">1</span>            <span class="m">1</span>           13m
</span></span><span class="line"><span class="cl">nginx   1/4     <span class="m">1</span>            <span class="m">1</span>           13m
</span></span><span class="line"><span class="cl">nginx   1/4     <span class="m">4</span>            <span class="m">1</span>           13m
</span></span><span class="line"><span class="cl">nginx   1/8     <span class="m">4</span>            <span class="m">1</span>           14m
</span></span><span class="line"><span class="cl">nginx   1/8     <span class="m">4</span>            <span class="m">1</span>           14m
</span></span><span class="line"><span class="cl">nginx   1/8     <span class="m">4</span>            <span class="m">1</span>           14m
</span></span><span class="line"><span class="cl">nginx   1/8     <span class="m">8</span>            <span class="m">1</span>           14m
</span></span><span class="line"><span class="cl">nginx   2/8     <span class="m">8</span>            <span class="m">2</span>           14m
</span></span><span class="line"><span class="cl">nginx   3/8     <span class="m">8</span>            <span class="m">3</span>           14m
</span></span><span class="line"><span class="cl">nginx   4/8     <span class="m">8</span>            <span class="m">4</span>           14m
</span></span><span class="line"><span class="cl">nginx   5/8     <span class="m">8</span>            <span class="m">5</span>           14m
</span></span><span class="line"><span class="cl">nginx   6/8     <span class="m">8</span>            <span class="m">6</span>           14m
</span></span><span class="line"><span class="cl">nginx   7/8     <span class="m">8</span>            <span class="m">7</span>           14m
</span></span><span class="line"><span class="cl">nginx   8/8     <span class="m">8</span>            <span class="m">8</span>           15m
</span></span><span class="line"><span class="cl">nginx   8/1     <span class="m">8</span>            <span class="m">8</span>           20m
</span></span><span class="line"><span class="cl">nginx   8/1     <span class="m">8</span>            <span class="m">8</span>           20m
</span></span><span class="line"><span class="cl">nginx   1/1     <span class="m">1</span>            <span class="m">1</span>           20m
</span></span></code></pre></div><p>pod 变化</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev -w</span>
</span></span><span class="line"><span class="cl">NAME                     READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-bh8dr   1/1     Running   <span class="m">0</span>          11m
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-cpgrv   0/1     Pending   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-8zhwk   0/1     Pending   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-rr9bn   0/1     Pending   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-cpgrv   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-8zhwk   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-rr9bn   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-m9gsj   0/1     Pending             <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-g56qb   0/1     Pending             <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-sl9c6   0/1     Pending             <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-fgst7   0/1     Pending             <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-g56qb   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-m9gsj   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-sl9c6   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-fgst7   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-8zhwk   1/1     Running             <span class="m">0</span>          19s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-rr9bn   1/1     Running             <span class="m">0</span>          30s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-m9gsj   1/1     Running             <span class="m">0</span>          21s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-cpgrv   1/1     Running             <span class="m">0</span>          47s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-sl9c6   1/1     Running             <span class="m">0</span>          33s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-g56qb   1/1     Running             <span class="m">0</span>          48s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-fgst7   1/1     Running             <span class="m">0</span>          66s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-fgst7   1/1     Terminating         <span class="m">0</span>          6m50s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-8zhwk   1/1     Terminating         <span class="m">0</span>          7m5s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-cpgrv   1/1     Terminating         <span class="m">0</span>          7m5s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-g56qb   1/1     Terminating         <span class="m">0</span>          6m50s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-rr9bn   1/1     Terminating         <span class="m">0</span>          7m5s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-m9gsj   1/1     Terminating         <span class="m">0</span>          6m50s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-sl9c6   1/1     Terminating         <span class="m">0</span>          6m50s
</span></span></code></pre></div><h4 id="65-daemonsetds">6.5 DaemonSet(DS)</h4>
<p>DaemonSet 类型的控制器可以保证在集群中的每一台（或指定）节点上都运行一个副本。一般适用于日志收集、节点监控等场景。也就是说，如果一个 Pod 提供的功能是节点级别的（每个节点都需要且只需要一个），那么这类 Pod 就适合使用 DaemonSet 类型的控制器创建。</p>
<p><a href="/p/2024122601/upload/image-20200612010223537.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200612010223537.png"
	width="685"
	height="267"
	srcset="/p/2024122601/upload/image-20200612010223537_hufa7a0c19b9e01976f5ab79bf05e1cd37_7911_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200612010223537_hufa7a0c19b9e01976f5ab79bf05e1cd37_7911_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<p>DaemonSet 控制器的特点：</p>
<ul>
<li>每当向集群中添加一个节点时，指定的 Pod 副本也将添加到该节点上</li>
<li>当节点从集群中移除时，Pod 也就被垃圾回收了</li>
</ul>
<p>下面先来看下 DaemonSet 的资源清单文件</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w"> </span><span class="c"># 版本号</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">DaemonSet</span><span class="w"> </span><span class="c"># 类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># 元数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="c"># rs名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="c"># 所属命名空间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c">#标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">controller</span><span class="p">:</span><span class="w"> </span><span class="l">daemonset</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># 详情描述</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 保留历史版本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">updateStrategy</span><span class="p">:</span><span class="w"> </span><span class="c"># 更新策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w"> </span><span class="c"># 滚动更新策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w"> </span><span class="c"># 滚动更新</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c"># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="c"># 选择器，通过它指定该控制器管理哪些pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w"> </span><span class="c"># Labels匹配规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"> </span><span class="c"># Expressions匹配规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- {<span class="w"> </span><span class="nt">key: app, operator: In, values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">nginx-pod] }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="c"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><p>创建 pc-daemonset.yaml，内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">DaemonSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pc-daemonset</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建daemonset</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f  pc-daemonset.yaml</span>
</span></span><span class="line"><span class="cl">daemonset.apps/pc-daemonset created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看daemonset</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1">#  kubectl get ds -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME        DESIRED  CURRENT  READY  UP-TO-DATE  AVAILABLE   AGE   CONTAINERS   IMAGES
</span></span><span class="line"><span class="cl">pc-daemonset   <span class="m">2</span>        <span class="m">2</span>        <span class="m">2</span>      <span class="m">2</span>           <span class="m">2</span>        24s   nginx        nginx:1.17.1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod,发现在每个Node上都运行一个pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1">#  kubectl get pods -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME                 READY   STATUS    RESTARTS   AGE   IP            NODE
</span></span><span class="line"><span class="cl">pc-daemonset-9bck8   1/1     Running   <span class="m">0</span>          37s   10.244.1.43   node1
</span></span><span class="line"><span class="cl">pc-daemonset-k224w   1/1     Running   <span class="m">0</span>          37s   10.244.2.74   node2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 删除daemonset</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl delete -f pc-daemonset.yaml</span>
</span></span><span class="line"><span class="cl">daemonset.apps <span class="s2">&#34;pc-daemonset&#34;</span> deleted
</span></span></code></pre></div><h4 id="66-job">6.6 Job</h4>
<p>Job，主要用于负责批量处理(一次要处理指定数量任务)短暂的一次性(每个任务仅运行一次就结束)任务。Job 特点如下：</p>
<ul>
<li>当 Job 创建的 pod 执行成功结束时，Job 将记录成功结束的 pod 数量</li>
<li>当成功结束的 pod 达到指定的数量时，Job 将完成执行</li>
</ul>
<p><a href="/p/2024122601/upload/image-20200618213054113.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200618213054113.png"
	width="801"
	height="254"
	srcset="/p/2024122601/upload/image-20200618213054113_hu99de0aa1256468db2904a165736410ed_11189_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200618213054113_hu99de0aa1256468db2904a165736410ed_11189_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<p>Job 的资源清单文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">batch/v1</span><span class="w"> </span><span class="c"># 版本号</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Job</span><span class="w"> </span><span class="c"># 类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># 元数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="c"># rs名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="c"># 所属命名空间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c">#标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">controller</span><span class="p">:</span><span class="w"> </span><span class="l">job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># 详情描述</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">completions: 1 # 指定job需要成功运行Pods的次数。默认值</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">parallelism: 1 # 指定job在任一时刻应该并发运行Pods的数量。默认值</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">activeDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="c"># 指定job可运行的时间期限，超过时间还未结束，系统将会尝试进行终止。</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">backoffLimit</span><span class="p">:</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="c"># 指定job失败后进行重试的次数。默认是6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">manualSelector</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># 是否可以使用selector选择器选择pod，默认是false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="c"># 选择器，通过它指定该控制器管理哪些pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w"> </span><span class="c"># Labels匹配规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">counter-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"> </span><span class="c"># Expressions匹配规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- {<span class="w"> </span><span class="nt">key: app, operator: In, values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">counter-pod] }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="c"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">counter-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span><span class="w"> </span><span class="c"># 重启策略只能设置为Never或者OnFailure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">counter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="s2">&#34;bin/sh&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="s2">&#34;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 2;done&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">关于重启策略设置的说明：
</span></span><span class="line"><span class="cl">如果指定为 OnFailure，则 job 会在 pod 出现故障时重启容器，而不是创建 pod，failed 次数不变
</span></span><span class="line"><span class="cl">如果指定为 Never，则 job 会在 pod 出现故障时创建新的 pod，并且故障 pod 不会消失，也不会重启，failed 次数加 1
</span></span><span class="line"><span class="cl">如果指定为 Always 的话，就意味着一直重启，意味着 job 任务会重复去执行了，当然不对，所以不能设置为 Always
</span></span></code></pre></div><p>创建 pc-job.yaml，内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">batch/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pc-job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">manualSelector</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">counter-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">counter-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">counter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="s2">&#34;bin/sh&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="s2">&#34;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建job</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pc-job.yaml</span>
</span></span><span class="line"><span class="cl">job.batch/pc-job created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看job</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get job -n dev -o wide  -w</span>
</span></span><span class="line"><span class="cl">NAME     COMPLETIONS   DURATION   AGE   CONTAINERS   IMAGES         SELECTOR
</span></span><span class="line"><span class="cl">pc-job   0/1           21s        21s   counter      busybox:1.30   <span class="nv">app</span><span class="o">=</span>counter-pod
</span></span><span class="line"><span class="cl">pc-job   1/1           31s        79s   counter      busybox:1.30   <span class="nv">app</span><span class="o">=</span>counter-pod
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 通过观察pod状态可以看到，pod在运行完毕任务后，就会变成Completed状态</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev -w</span>
</span></span><span class="line"><span class="cl">NAME           READY   STATUS     RESTARTS      AGE
</span></span><span class="line"><span class="cl">pc-job-rxg96   1/1     Running     <span class="m">0</span>            29s
</span></span><span class="line"><span class="cl">pc-job-rxg96   0/1     Completed   <span class="m">0</span>            33s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 接下来，调整下pod运行的总数量和并行数量 即：在spec下设置下面两个选项</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  completions: 6 # 指定job需要成功运行Pods的次数为6</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  parallelism: 3 # 指定job并发运行Pods的数量为3</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  然后重新运行job，观察效果，此时会发现，job会每次运行3个pod，总共执行了6个pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev -w</span>
</span></span><span class="line"><span class="cl">NAME           READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-job-684ft   1/1     Running   <span class="m">0</span>          5s
</span></span><span class="line"><span class="cl">pc-job-jhj49   1/1     Running   <span class="m">0</span>          5s
</span></span><span class="line"><span class="cl">pc-job-pfcvh   1/1     Running   <span class="m">0</span>          5s
</span></span><span class="line"><span class="cl">pc-job-684ft   0/1     Completed   <span class="m">0</span>          11s
</span></span><span class="line"><span class="cl">pc-job-v7rhr   0/1     Pending     <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-job-v7rhr   0/1     Pending     <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-job-v7rhr   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-job-jhj49   0/1     Completed           <span class="m">0</span>          11s
</span></span><span class="line"><span class="cl">pc-job-fhwf7   0/1     Pending             <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-job-fhwf7   0/1     Pending             <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-job-pfcvh   0/1     Completed           <span class="m">0</span>          11s
</span></span><span class="line"><span class="cl">pc-job-5vg2j   0/1     Pending             <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-job-fhwf7   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-job-5vg2j   0/1     Pending             <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-job-5vg2j   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-job-fhwf7   1/1     Running             <span class="m">0</span>          2s
</span></span><span class="line"><span class="cl">pc-job-v7rhr   1/1     Running             <span class="m">0</span>          2s
</span></span><span class="line"><span class="cl">pc-job-5vg2j   1/1     Running             <span class="m">0</span>          3s
</span></span><span class="line"><span class="cl">pc-job-fhwf7   0/1     Completed           <span class="m">0</span>          12s
</span></span><span class="line"><span class="cl">pc-job-v7rhr   0/1     Completed           <span class="m">0</span>          12s
</span></span><span class="line"><span class="cl">pc-job-5vg2j   0/1     Completed           <span class="m">0</span>          12s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 删除job</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl delete -f pc-job.yaml</span>
</span></span><span class="line"><span class="cl">job.batch <span class="s2">&#34;pc-job&#34;</span> deleted
</span></span></code></pre></div><h4 id="67-cronjobcj">6.7 CronJob(CJ)</h4>
<p>CronJob 控制器以 Job 控制器资源为其管控对象，并借助它管理 pod 资源对象，Job 控制器定义的作业任务在其控制器资源创建之后便会立即执行，但 CronJob 可以以类似于 Linux 操作系统的周期性任务作业计划的方式控制其运行时间点及重复运行的方式。也就是说，CronJob 可以在特定的时间点(反复的)去运行 job 任务。</p>
<p><a href="/p/2024122601/upload/image-20200618213149531.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200618213149531.png"
	width="830"
	height="301"
	srcset="/p/2024122601/upload/image-20200618213149531_hu2f5f25479ba3147b9c7ac8f754a6eda9_11309_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200618213149531_hu2f5f25479ba3147b9c7ac8f754a6eda9_11309_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<p>CronJob 的资源清单文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">batch/v1beta1</span><span class="w"> </span><span class="c"># 版本号</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CronJob</span><span class="w"> </span><span class="c"># 类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># 元数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="c"># rs名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="c"># 所属命名空间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c">#标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">controller</span><span class="p">:</span><span class="w"> </span><span class="l">cronjob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># 详情描述</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">schedule</span><span class="p">:</span><span class="w"> </span><span class="c"># cron格式的作业调度运行时间点,用于控制任务在什么时间执行</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">concurrencyPolicy</span><span class="p">:</span><span class="w"> </span><span class="c"># 并发执行策略，用于定义前一次作业运行尚未完成时是否以及如何运行后一次的作业</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">failedJobHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="c"># 为失败的任务执行保留的历史记录数，默认为1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">successfulJobHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="c"># 为成功的任务执行保留的历史记录数，默认为3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">startingDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="c"># 启动作业错误的超时时长</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobTemplate</span><span class="p">:</span><span class="w"> </span><span class="c"># job控制器模板，用于为cronjob控制器生成job对象;下面其实就是job的定义</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">completions</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">parallelism</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">activeDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">backoffLimit</span><span class="p">:</span><span class="w"> </span><span class="m">6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">manualSelector</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">counter-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"> </span><span class="l">规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- {<span class="nt">key: app, operator: In, values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">counter-pod]}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">counter-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">counter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;bin/sh&#34;</span><span class="p">,</span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="s2">&#34;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 20;done&#34;</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">需要重点解释的几个选项：
</span></span><span class="line"><span class="cl">schedule: cron 表达式，用于指定任务的执行时间
</span></span><span class="line"><span class="cl"><span class="ge">_/1 _</span> \* \* \*
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">分钟</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">小时</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">日</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">月份</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">星期</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    分钟 值从 0 到 59.
</span></span><span class="line"><span class="cl">    小时 值从 0 到 23.
</span></span><span class="line"><span class="cl">    日 值从 1 到 31.
</span></span><span class="line"><span class="cl">    月 值从 1 到 12.
</span></span><span class="line"><span class="cl">    星期 值从 0 到 6, 0 代表星期日
</span></span><span class="line"><span class="cl">    多个时间可以用逗号隔开； 范围可以用连字符给出；*可以作为通配符； /表示每...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">concurrencyPolicy:
</span></span><span class="line"><span class="cl">Allow: 允许 Jobs 并发运行(默认)
</span></span><span class="line"><span class="cl">Forbid: 禁止并发运行，如果上一次运行尚未完成，则跳过下一次运行
</span></span><span class="line"><span class="cl">Replace: 替换，取消当前正在运行的作业并用新作业替换它
</span></span></code></pre></div><p>创建 pc-cronjob.yaml，内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">batch/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CronJob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pc-cronjob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">controller</span><span class="p">:</span><span class="w"> </span><span class="l">cronjob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">schedule</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;*/1 * * * *&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobTemplate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">counter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="s2">&#34;bin/sh&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="s2">&#34;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建cronjob</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pc-cronjob.yaml</span>
</span></span><span class="line"><span class="cl">cronjob.batch/pc-cronjob created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看cronjob</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get cronjobs -n dev</span>
</span></span><span class="line"><span class="cl">NAME         SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
</span></span><span class="line"><span class="cl">pc-cronjob   */1 * * * *   False     <span class="m">0</span>        &lt;none&gt;          6s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看job</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get jobs -n dev</span>
</span></span><span class="line"><span class="cl">NAME                    COMPLETIONS   DURATION   AGE
</span></span><span class="line"><span class="cl">pc-cronjob-1592587800   1/1           28s        3m26s
</span></span><span class="line"><span class="cl">pc-cronjob-1592587860   1/1           28s        2m26s
</span></span><span class="line"><span class="cl">pc-cronjob-1592587920   1/1           28s        86s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">pc-cronjob-1592587800-x4tsm   0/1     Completed   <span class="m">0</span>          2m24s
</span></span><span class="line"><span class="cl">pc-cronjob-1592587860-r5gv4   0/1     Completed   <span class="m">0</span>          84s
</span></span><span class="line"><span class="cl">pc-cronjob-1592587920-9dxxq   1/1     Running     <span class="m">0</span>          24s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 删除cronjob</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl  delete -f pc-cronjob.yaml</span>
</span></span><span class="line"><span class="cl">cronjob.batch <span class="s2">&#34;pc-cronjob&#34;</span> deleted
</span></span></code></pre></div><h3 id="7-service-详解">7. Service 详解</h3>
<h4 id="71-service-介绍">7.1 Service 介绍</h4>
<p>在 kubernetes 中，pod 是应用程序的载体，我们可以通过 pod 的 ip 来访问应用程序，但是 pod 的 ip 地址不是固定的，这也就意味着不方便直接采用 pod 的 ip 对服务进行访问。</p>
<p>为了解决这个问题，kubernetes 提供了 Service 资源，Service 会对提供同一个服务的多个 pod 进行聚合，并且提供一个统一的入口地址。通过访问 Service 的入口地址就能访问到后面的 pod 服务。</p>
<p><a href="/p/2024122601/upload/image-20200408194716912-1626783758946.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200408194716912-1626783758946.png"
	width="1073"
	height="497"
	srcset="/p/2024122601/upload/image-20200408194716912-1626783758946_hu232d859215d5eb5856fe94011ddc048b_36041_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200408194716912-1626783758946_hu232d859215d5eb5856fe94011ddc048b_36041_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<p>Service 在很多情况下只是一个概念，真正起作用的其实是 kube-proxy 服务进程，每个 Node 节点上都运行着一个 kube-proxy 服务进程。当创建 Service 的时候会通过 api-server 向 etcd 写入创建的 service 的信息，而 kube-proxy 会基于监听的机制发现这种 Service 的变动，然后它会将最新的 Service 信息转换成对应的访问规则。</p>
<p><a href="/p/2024122601/upload/image-20200509121254425.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200509121254425.png"
	width="1048"
	height="350"
	srcset="/p/2024122601/upload/image-20200509121254425_huce6e766e5ed25bfb1bb757d6fe19f00b_15139_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200509121254425_huce6e766e5ed25bfb1bb757d6fe19f00b_15139_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl"># 10.97.97.97:80 是service提供的访问入口
</span></span><span class="line"><span class="cl"># 当访问这个入口的时候，可以发现后面有三个pod的服务在等待调用，
</span></span><span class="line"><span class="cl"># kube-proxy会基于rr（轮询）的策略，将请求分发到其中一个pod上去
</span></span><span class="line"><span class="cl"># 这个规则会同时在集群内的所有节点上都生成，所以在任何一个节点上，都可以访问。
</span></span><span class="line"><span class="cl">[root@node1 ~]# ipvsadm -Ln
</span></span><span class="line"><span class="cl">IP Virtual Server version 1.2.1 (size=4096)
</span></span><span class="line"><span class="cl">Prot LocalAddress:Port Scheduler Flags
</span></span><span class="line"><span class="cl">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
</span></span><span class="line"><span class="cl">TCP  10.97.97.97:80 rr
</span></span><span class="line"><span class="cl">  -&gt; 10.244.1.39:80               Masq    1      0          0
</span></span><span class="line"><span class="cl">  -&gt; 10.244.1.40:80               Masq    1      0          0
</span></span><span class="line"><span class="cl">  -&gt; 10.244.2.33:80               Masq    1      0          0
</span></span></code></pre></div><p>kube-proxy 目前支持三种工作模式:</p>
<h5 id="711-userspace-模式">7.1.1 userspace 模式</h5>
<p>userspace 模式下，kube-proxy 会为每一个 Service 创建一个监听端口，发向 Cluster IP 的请求被 Iptables 规则重定向到 kube-proxy 监听的端口上，kube-proxy 根据 LB 算法选择一个提供服务的 Pod 并和其建立链接，以将请求转发到 Pod 上。 该模式下，kube-proxy 充当了一个四层负责均衡器的角色。由于 kube-proxy 运行在 userspace 中，在进行转发处理时会增加内核和用户空间之间的数据拷贝，虽然比较稳定，但是效率比较低。</p>
<p><a href="/p/2024122601/upload/image-20200509151424280.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200509151424280.png"
	width="851"
	height="524"
	srcset="/p/2024122601/upload/image-20200509151424280_hu61ee3affb0e733a7b7d90e3d050aebf4_80209_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200509151424280_hu61ee3affb0e733a7b7d90e3d050aebf4_80209_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<h5 id="712-iptables-模式">7.1.2 iptables 模式</h5>
<p>iptables 模式下，kube-proxy 为 service 后端的每个 Pod 创建对应的 iptables 规则，直接将发向 Cluster IP 的请求重定向到一个 Pod IP。 该模式下 kube-proxy 不承担四层负责均衡器的角色，只负责创建 iptables 规则。该模式的优点是较 userspace 模式效率更高，但不能提供灵活的 LB 策略，当后端 Pod 不可用时也无法进行重试。</p>
<p><a href="/p/2024122601/upload/image-20200509152947714.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200509152947714.png"
	width="837"
	height="642"
	srcset="/p/2024122601/upload/image-20200509152947714_hufa57fddeeb937bc45e0744d29f10fde1_84078_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200509152947714_hufa57fddeeb937bc45e0744d29f10fde1_84078_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<h5 id="713-ipvs-模式">7.1.3 ipvs 模式</h5>
<p>ipvs 模式和 iptables 类似，kube-proxy 监控 Pod 的变化并创建相应的 ipvs 规则。ipvs 相对 iptables 转发效率更高。除此以外，ipvs 支持更多的 LB 算法。</p>
<p><a href="/p/2024122601/upload/image-20200509153731363.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200509153731363.png"
	width="820"
	height="633"
	srcset="/p/2024122601/upload/image-20200509153731363_hudab5b972439d8e914502fa58992ab6d6_71740_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200509153731363_hudab5b972439d8e914502fa58992ab6d6_71740_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 此模式必须安装ipvs内核模块，否则会降级为iptables</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 开启ipvs</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl edit cm kube-proxy -n kube-system</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 修改mode: &#34;ipvs&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl delete pod -l k8s-app=kube-proxy -n kube-system</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@node1 ~<span class="o">]</span><span class="c1"># ipvsadm -Ln</span>
</span></span><span class="line"><span class="cl">IP Virtual Server version 1.2.1 <span class="o">(</span><span class="nv">size</span><span class="o">=</span>4096<span class="o">)</span>
</span></span><span class="line"><span class="cl">Prot LocalAddress:Port Scheduler Flags
</span></span><span class="line"><span class="cl">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
</span></span><span class="line"><span class="cl">TCP  10.97.97.97:80 rr
</span></span><span class="line"><span class="cl">  -&gt; 10.244.1.39:80               Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">  -&gt; 10.244.1.40:80               Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">  -&gt; 10.244.2.33:80               Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span></code></pre></div><h4 id="72-service-类型">7.2 Service 类型</h4>
<p>Service 的资源清单文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w"> </span><span class="c"># 资源类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w"> </span><span class="c"># 资源版本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># 元数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">service</span><span class="w"> </span><span class="c"># 资源名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w"> </span><span class="c"># 命名空间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># 描述</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="c"># 标签选择器，用于确定当前service代理哪些pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="c"># Service类型，指定service的访问方式</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clusterIP</span><span class="p">:</span><span class="w"> </span><span class="c"># 虚拟服务的ip地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sessionAffinity</span><span class="p">:</span><span class="w"> </span><span class="c"># session亲和性，支持ClientIP、None两个选项</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w"> </span><span class="c"># 端口信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">3017</span><span class="w"> </span><span class="c"># service端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">5003</span><span class="w"> </span><span class="c"># pod端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">31122</span><span class="w"> </span><span class="c"># 主机端口</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>ClusterIP：默认值，它是 Kubernetes 系统自动分配的虚拟 IP，只能在集群内部访问</li>
<li>NodePort：将 Service 通过指定的 Node 上的端口暴露给外部，通过此方法，就可以在集群外部访问服务</li>
<li>LoadBalancer：使用外接负载均衡器完成到服务的负载分发，注意此模式需要外部云环境支持</li>
<li>ExternalName： 把集群外部的服务引入集群内部，直接使用</li>
</ul>
<h4 id="73-service-使用">7.3 Service 使用</h4>
<h5 id="731-实验环境准备">7.3.1 实验环境准备</h5>
<p>在使用 service 之前，首先利用 Deployment 创建出 3 个 pod，注意要为 pod 设置<code>app=nginx-pod</code>的标签</p>
<p>创建 deployment.yaml，内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pc-deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f deployment.yaml</span>
</span></span><span class="line"><span class="cl">deployment.apps/pc-deployment created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod详情</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev -o wide --show-labels</span>
</span></span><span class="line"><span class="cl">NAME                             READY   STATUS     IP            NODE     LABELS
</span></span><span class="line"><span class="cl">pc-deployment-66cb59b984-8p84h   1/1     Running    10.244.1.39   node1    <span class="nv">app</span><span class="o">=</span>nginx-pod
</span></span><span class="line"><span class="cl">pc-deployment-66cb59b984-vx8vx   1/1     Running    10.244.2.33   node2    <span class="nv">app</span><span class="o">=</span>nginx-pod
</span></span><span class="line"><span class="cl">pc-deployment-66cb59b984-wnncx   1/1     Running    10.244.1.40   node1    <span class="nv">app</span><span class="o">=</span>nginx-pod
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 为了方便后面的测试，修改下三台nginx的index.html页面（三台修改的IP地址不一致）</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kubectl exec -it pc-deployment-66cb59b984-8p84h -n dev /bin/sh</span>
</span></span><span class="line"><span class="cl"><span class="c1"># echo &#34;10.244.1.39&#34; &gt; /usr/share/nginx/html/index.html</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#修改完毕之后，访问测试</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># curl 10.244.1.39</span>
</span></span><span class="line"><span class="cl">10.244.1.39
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># curl 10.244.2.33</span>
</span></span><span class="line"><span class="cl">10.244.2.33
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># curl 10.244.1.40</span>
</span></span><span class="line"><span class="cl">10.244.1.40
</span></span></code></pre></div><h5 id="732-clusterip-类型的-service">7.3.2 ClusterIP 类型的 Service</h5>
<p>创建 service-clusterip.yaml 文件</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">service-clusterip</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clusterIP</span><span class="p">:</span><span class="w"> </span><span class="m">10.97.97.97</span><span class="w"> </span><span class="c"># service的ip地址，如果不写，默认会生成一个</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="c"># Service端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="c"># pod端口</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建service</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f service-clusterip.yaml</span>
</span></span><span class="line"><span class="cl">service/service-clusterip created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看service</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get svc -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME                TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE   SELECTOR
</span></span><span class="line"><span class="cl">service-clusterip   ClusterIP   10.97.97.97   &lt;none&gt;        80/TCP    13s   <span class="nv">app</span><span class="o">=</span>nginx-pod
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看service的详细信息</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 在这里有一个Endpoints列表，里面就是当前service可以负载到的服务入口</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl describe svc service-clusterip -n dev</span>
</span></span><span class="line"><span class="cl">Name:              service-clusterip
</span></span><span class="line"><span class="cl">Namespace:         dev
</span></span><span class="line"><span class="cl">Labels:            &lt;none&gt;
</span></span><span class="line"><span class="cl">Annotations:       &lt;none&gt;
</span></span><span class="line"><span class="cl">Selector:          <span class="nv">app</span><span class="o">=</span>nginx-pod
</span></span><span class="line"><span class="cl">Type:              ClusterIP
</span></span><span class="line"><span class="cl">IP:                10.97.97.97
</span></span><span class="line"><span class="cl">Port:              &lt;unset&gt;  80/TCP
</span></span><span class="line"><span class="cl">TargetPort:        80/TCP
</span></span><span class="line"><span class="cl">Endpoints:         10.244.1.39:80,10.244.1.40:80,10.244.2.33:80
</span></span><span class="line"><span class="cl">Session Affinity:  None
</span></span><span class="line"><span class="cl">Events:            &lt;none&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看ipvs的映射规则</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># ipvsadm -Ln</span>
</span></span><span class="line"><span class="cl">TCP  10.97.97.97:80 rr
</span></span><span class="line"><span class="cl">  -&gt; 10.244.1.39:80               Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">  -&gt; 10.244.1.40:80               Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">  -&gt; 10.244.2.33:80               Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 访问10.97.97.97:80观察效果</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># curl 10.97.97.97:80</span>
</span></span><span class="line"><span class="cl">10.244.2.33
</span></span></code></pre></div><h5 id="733-endpoint">7.3.3 Endpoint</h5>
<p>Endpoint 是 kubernetes 中的一个资源对象，存储在 etcd 中，用来记录一个 service 对应的所有 pod 的访问地址，它是根据 service 配置文件中 selector 描述产生的。</p>
<p>一个 Service 由一组 Pod 组成，这些 Pod 通过 Endpoints 暴露出来，Endpoints 是实现实际服务的端点集合。换句话说，service 和 pod 之间的联系是通过 endpoints 实现的。</p>
<p><a href="/p/2024122601/upload/image-20200509191917069.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200509191917069.png"
	width="1087"
	height="432"
	srcset="/p/2024122601/upload/image-20200509191917069_hufbee989e87eb2fbe9a85eeea13111a4b_27041_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200509191917069_hufbee989e87eb2fbe9a85eeea13111a4b_27041_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200509191917069"
	
>
</a></p>
<p>负载分发策略</p>
<p>对 Service 的访问被分发到了后端的 Pod 上去，目前 kubernetes 提供了两种负载分发策略：</p>
<ul>
<li>
<p>如果不定义，默认使用 kube-proxy 的策略，比如随机、轮询</p>
</li>
<li>
<p>基于客户端地址的会话保持模式，即来自同一个客户端发起的所有请求都会转发到固定的一个 Pod 上</p>
<p>此模式可以使在 spec 中添加<code>sessionAffinity:ClientIP</code>选项</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 查看ipvs的映射规则【rr 轮询】</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># ipvsadm -Ln</span>
</span></span><span class="line"><span class="cl">TCP  10.97.97.97:80 rr
</span></span><span class="line"><span class="cl">  -&gt; 10.244.1.39:80               Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">  -&gt; 10.244.1.40:80               Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">  -&gt; 10.244.2.33:80               Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 循环访问测试</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># while true;do curl 10.97.97.97:80; sleep 5; done;</span>
</span></span><span class="line"><span class="cl">10.244.1.40
</span></span><span class="line"><span class="cl">10.244.1.39
</span></span><span class="line"><span class="cl">10.244.2.33
</span></span><span class="line"><span class="cl">10.244.1.40
</span></span><span class="line"><span class="cl">10.244.1.39
</span></span><span class="line"><span class="cl">10.244.2.33
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修改分发策略----sessionAffinity:ClientIP</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看ipvs规则【persistent 代表持久】</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># ipvsadm -Ln</span>
</span></span><span class="line"><span class="cl">TCP  10.97.97.97:80 rr persistent <span class="m">10800</span>
</span></span><span class="line"><span class="cl">  -&gt; 10.244.1.39:80               Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">  -&gt; 10.244.1.40:80               Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">  -&gt; 10.244.2.33:80               Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 循环访问测试</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># while true;do curl 10.97.97.97; sleep 5; done;</span>
</span></span><span class="line"><span class="cl">10.244.2.33
</span></span><span class="line"><span class="cl">10.244.2.33
</span></span><span class="line"><span class="cl">10.244.2.33
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 删除service</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl delete -f service-clusterip.yaml</span>
</span></span><span class="line"><span class="cl">service <span class="s2">&#34;service-clusterip&#34;</span> deleted
</span></span></code></pre></div><h5 id="734-headliness-类型的-service">7.3.4 HeadLiness 类型的 Service</h5>
<p>在某些场景中，开发人员可能不想使用 Service 提供的负载均衡功能，而希望自己来控制负载均衡策略，针对这种情况，kubernetes 提供了 HeadLiness Service，这类 Service 不会分配 Cluster IP，如果想要访问 service，只能通过 service 的域名进行查询。</p>
<p>创建 service-headliness.yaml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">service-headliness</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clusterIP</span><span class="p">:</span><span class="w"> </span><span class="l">None</span><span class="w"> </span><span class="c"># 将clusterIP设置为None，即可创建headliness Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建service</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f service-headliness.yaml</span>
</span></span><span class="line"><span class="cl">service/service-headliness created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 获取service， 发现CLUSTER-IP未分配</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get svc service-headliness -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE   SELECTOR
</span></span><span class="line"><span class="cl">service-headliness   ClusterIP   None         &lt;none&gt;        80/TCP    11s   <span class="nv">app</span><span class="o">=</span>nginx-pod
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看service详情</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl describe svc service-headliness  -n dev</span>
</span></span><span class="line"><span class="cl">Name:              service-headliness
</span></span><span class="line"><span class="cl">Namespace:         dev
</span></span><span class="line"><span class="cl">Labels:            &lt;none&gt;
</span></span><span class="line"><span class="cl">Annotations:       &lt;none&gt;
</span></span><span class="line"><span class="cl">Selector:          <span class="nv">app</span><span class="o">=</span>nginx-pod
</span></span><span class="line"><span class="cl">Type:              ClusterIP
</span></span><span class="line"><span class="cl">IP:                None
</span></span><span class="line"><span class="cl">Port:              &lt;unset&gt;  80/TCP
</span></span><span class="line"><span class="cl">TargetPort:        80/TCP
</span></span><span class="line"><span class="cl">Endpoints:         10.244.1.39:80,10.244.1.40:80,10.244.2.33:80
</span></span><span class="line"><span class="cl">Session Affinity:  None
</span></span><span class="line"><span class="cl">Events:            &lt;none&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看域名的解析情况</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl exec -it pc-deployment-66cb59b984-8p84h -n dev /bin/sh</span>
</span></span><span class="line"><span class="cl">/ <span class="c1"># cat /etc/resolv.conf</span>
</span></span><span class="line"><span class="cl">nameserver 10.96.0.10
</span></span><span class="line"><span class="cl">search dev.svc.cluster.local svc.cluster.local cluster.local
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># dig @10.96.0.10 service-headliness.dev.svc.cluster.local</span>
</span></span><span class="line"><span class="cl">service-headliness.dev.svc.cluster.local. <span class="m">30</span> IN A 10.244.1.40
</span></span><span class="line"><span class="cl">service-headliness.dev.svc.cluster.local. <span class="m">30</span> IN A 10.244.1.39
</span></span><span class="line"><span class="cl">service-headliness.dev.svc.cluster.local. <span class="m">30</span> IN A 10.244.2.33
</span></span></code></pre></div><h5 id="735-nodeport-类型的-service">7.3.5 NodePort 类型的 Service</h5>
<p>在之前的样例中，创建的 Service 的 ip 地址只有集群内部才可以访问，如果希望将 Service 暴露给集群外部使用，那么就要使用到另外一种类型的 Service，称为 NodePort 类型。NodePort 的工作原理其实就是将 service 的端口映射到 Node 的一个端口上，然后就可以通过<code>NodeIp:NodePort</code>来访问 service 了。</p>
<p><a href="/p/2024122601/upload/image-20200620175731338.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200620175731338.png"
	width="543"
	height="262"
	srcset="/p/2024122601/upload/image-20200620175731338_hu1bd2a86722faeb72cb4974d50f5f9b49_5323_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200620175731338_hu1bd2a86722faeb72cb4974d50f5f9b49_5323_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<p>创建 service-nodeport.yaml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">service-nodeport</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w"> </span><span class="c"># service类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">30002</span><span class="w"> </span><span class="c"># 指定绑定的node的端口(默认的取值范围是：30000-32767), 如果不指定，会默认分配</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建service</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f service-nodeport.yaml</span>
</span></span><span class="line"><span class="cl">service/service-nodeport created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看service</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get svc -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME               TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>       SELECTOR
</span></span><span class="line"><span class="cl">service-nodeport   NodePort   10.105.64.191   &lt;none&gt;        80:30002/TCP  <span class="nv">app</span><span class="o">=</span>nginx-pod
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 接下来可以通过电脑主机的浏览器去访问集群中任意一个nodeip的30002端口，即可访问到pod</span>
</span></span></code></pre></div><h5 id="736-loadbalancer-类型的-service">7.3.6 LoadBalancer 类型的 Service</h5>
<p>LoadBalancer 和 NodePort 很相似，目的都是向外部暴露一个端口，区别在于 LoadBalancer 会在集群的外部再来做一个负载均衡设备，而这个设备需要外部环境支持的，外部服务发送到这个设备上的请求，会被设备负载之后转发到集群中。</p>
<p><a href="/p/2024122601/upload/image-20200510103945494.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200510103945494.png"
	width="1101"
	height="419"
	srcset="/p/2024122601/upload/image-20200510103945494_hu488140ea0811c8b48bda5a3e74124738_20284_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200510103945494_hu488140ea0811c8b48bda5a3e74124738_20284_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<h5 id="737-externalname-类型的-service">7.3.7 ExternalName 类型的 Service</h5>
<p>ExternalName 类型的 Service 用于引入集群外部的服务，它通过<code>externalName</code>属性指定外部一个服务的地址，然后在集群内部访问此 service 就可以访问到外部的服务了。</p>
<p><a href="/p/2024122601/upload/image-20200510113311209.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200510113311209.png"
	width="779"
	height="304"
	srcset="/p/2024122601/upload/image-20200510113311209_huacf20d1089c9db168718639fe1ba2c03_16431_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200510113311209_huacf20d1089c9db168718639fe1ba2c03_16431_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Service
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: service-externalname
</span></span><span class="line"><span class="cl">  namespace: dev
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  type: ExternalName <span class="c1"># service类型</span>
</span></span><span class="line"><span class="cl">  externalName: www.baidu.com  <span class="c1">#改成ip地址也可以</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建service</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl  create -f service-externalname.yaml</span>
</span></span><span class="line"><span class="cl">service/service-externalname created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 域名解析</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># dig @10.96.0.10 service-externalname.dev.svc.cluster.local</span>
</span></span><span class="line"><span class="cl">service-externalname.dev.svc.cluster.local. <span class="m">30</span> IN CNAME www.baidu.com.
</span></span><span class="line"><span class="cl">www.baidu.com.          <span class="m">30</span>      IN      CNAME   www.a.shifen.com.
</span></span><span class="line"><span class="cl">www.a.shifen.com.       <span class="m">30</span>      IN      A       39.156.66.18
</span></span><span class="line"><span class="cl">www.a.shifen.com.       <span class="m">30</span>      IN      A       39.156.66.14
</span></span></code></pre></div><h4 id="74-ingress-介绍">7.4 Ingress 介绍</h4>
<p>在前面课程中已经提到，Service 对集群之外暴露服务的主要方式有两种：NotePort 和 LoadBalancer，但是这两种方式，都有一定的缺点：</p>
<ul>
<li>NodePort 方式的缺点是会占用很多集群机器的端口，那么当集群服务变多的时候，这个缺点就愈发明显</li>
<li>LB 方式的缺点是每个 service 需要一个 LB，浪费、麻烦，并且需要 kubernetes 之外设备的支持</li>
</ul>
<p>基于这种现状，kubernetes 提供了 Ingress 资源对象，Ingress 只需要一个 NodePort 或者一个 LB 就可以满足暴露多个 Service 的需求。工作机制大致如下图表示：</p>
<p><a href="/p/2024122601/upload/image-20200623092808049.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200623092808049.png"
	width="992"
	height="422"
	srcset="/p/2024122601/upload/image-20200623092808049_hu02ac4431da4a10358101851b70358138_11761_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200623092808049_hu02ac4431da4a10358101851b70358138_11761_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<p>实际上，Ingress 相当于一个 7 层的负载均衡器，是 kubernetes 对反向代理的一个抽象，它的工作原理类似于 Nginx，可以理解成在 Ingress 里建立诸多映射规则，Ingress Controller 通过监听这些配置规则并转化成 Nginx 的反向代理配置 , 然后对外部提供服务。在这里有两个核心概念：</p>
<ul>
<li>ingress：kubernetes 中的一个对象，作用是定义请求如何转发到 service 的规则</li>
<li>ingress controller：具体实现反向代理及负载均衡的程序，对 ingress 定义的规则进行解析，根据配置的规则来实现请求转发，实现方式有很多，比如 Nginx, Contour, Haproxy 等等</li>
</ul>
<p>Ingress（以 Nginx 为例）的工作原理如下：</p>
<ol>
<li>用户编写 Ingress 规则，说明哪个域名对应 kubernetes 集群中的哪个 Service</li>
<li>Ingress 控制器动态感知 Ingress 服务规则的变化，然后生成一段对应的 Nginx 反向代理配置</li>
<li>Ingress 控制器会将生成的 Nginx 配置写入到一个运行着的 Nginx 服务中，并动态更新</li>
<li>到此为止，其实真正在工作的就是一个 Nginx 了，内部配置了用户定义的请求转发规则</li>
</ol>
<p><a href="/p/2024122601/upload/image-20200516112704764.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200516112704764.png"
	width="906"
	height="433"
	srcset="/p/2024122601/upload/image-20200516112704764_hu7940e02fd8ffa980b9893f4737f38a16_21594_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200516112704764_hu7940e02fd8ffa980b9893f4737f38a16_21594_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<h4 id="75-ingress-使用">7.5 Ingress 使用</h4>
<h5 id="751-环境准备-搭建-ingress-环境">7.5.1 环境准备 搭建 ingress 环境</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="c"># 创建文件夹
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="err">[root@k8s-master01</span> <span class="err">~]</span><span class="c"># mkdir ingress-controller
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="err">[root@k8s-master01</span> <span class="err">~]</span><span class="c"># cd ingress-controller/
</span></span></span><span class="line"><span class="cl"><span class="c"></span>
</span></span><span class="line"><span class="cl"><span class="c"># 获取ingress-nginx，本次案例使用的是0.30版本
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nf">[root@k8s-master01 ingress-controller]# wget https</span><span class="o">:</span>/<span class="n">raw</span>.<span class="n">githubusercontent</span>.<span class="n">com</span>/<span class="n">kubernetes</span>/<span class="n">ingress</span>-<span class="n">nginx</span>/<span class="n">nginx</span>-0.30.0/<span class="n">deploy</span>/<span class="n">static</span>/<span class="n">mandatory</span>.<span class="n">yaml</span>
</span></span><span class="line"><span class="cl"><span class="nf">[root@k8s-master01 ingress-controller]# wget https</span><span class="o">:</span>/<span class="n">raw</span>.<span class="n">githubusercontent</span>.<span class="n">com</span>/<span class="n">kubernetes</span>/<span class="n">ingress</span>-<span class="n">nginx</span>/<span class="n">nginx</span>-0.30.0/<span class="n">deploy</span>/<span class="n">static</span>/<span class="n">provider</span>/<span class="n">baremetal</span>/<span class="n">service</span>-<span class="n">nodeport</span>.<span class="n">yaml</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 修改mandatory.yaml文件中的仓库
</span></span></span><span class="line"><span class="cl"><span class="c"># 修改quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0
</span></span></span><span class="line"><span class="cl"><span class="c"># 为quay-mirror.qiniu.com/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0
</span></span></span><span class="line"><span class="cl"><span class="c"># 创建ingress-nginx
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="err">[root@k8s-master01</span> <span class="err">ingress-controller]</span><span class="c"># kubectl apply -f ./
</span></span></span><span class="line"><span class="cl"><span class="c"></span>
</span></span><span class="line"><span class="cl"><span class="c"># 查看ingress-nginx
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="err">[root@k8s-master01</span> <span class="err">ingress-controller]</span><span class="c"># kubectl get pod -n ingress-nginx
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="err">NAME</span>                                           <span class="err">READY</span>   <span class="err">STATUS</span>    <span class="err">RESTARTS</span>   <span class="err">AGE</span>
</span></span><span class="line"><span class="cl"><span class="err">pod/nginx-ingress-controller-fbf967dd5-4qpbp</span>   <span class="err">1/1</span>     <span class="err">Running</span>   <span class="err">0</span>          <span class="err">12h</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 查看service
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="err">[root@k8s-master01</span> <span class="err">ingress-controller]</span><span class="c"># kubectl get svc -n ingress-nginx
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="err">NAME</span>            <span class="err">TYPE</span>       <span class="err">CLUSTER-IP</span>     <span class="err">EXTERNAL-IP</span>   <span class="err">PORT(S)</span>                      <span class="err">AGE</span>
</span></span><span class="line"><span class="cl"><span class="nf">ingress-nginx   NodePort   10.98.75.163   &lt;none&gt;        80</span><span class="o">:</span>32240/<span class="n">TCP</span><span class="p">,</span>443:31335/<span class="n">TCP</span>   11<span class="n">h</span>
</span></span></code></pre></div><h5 id="752-准备-service-和-pod">7.5.2 准备 service 和 pod</h5>
<p>为了后面的实验比较方便，创建如下图所示的模型</p>
<p><a href="/p/2024122601/upload/image-20200516102419998.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200516102419998.png"
	width="910"
	height="358"
	srcset="/p/2024122601/upload/image-20200516102419998_huc855de38bc71672aaa87dc5fb246b510_18162_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200516102419998_huc855de38bc71672aaa87dc5fb246b510_18162_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<p>创建 tomcat-nginx.yaml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tomcat-deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">tomcat-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">tomcat-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tomcat</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">tomcat:8.5-jre10-slim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clusterIP</span><span class="p">:</span><span class="w"> </span><span class="l">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tomcat-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">tomcat-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clusterIP</span><span class="p">:</span><span class="w"> </span><span class="l">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f tomcat-nginx.yaml</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get svc -n dev</span>
</span></span><span class="line"><span class="cl">NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>    AGE
</span></span><span class="line"><span class="cl">nginx-service    ClusterIP   None         &lt;none&gt;        80/TCP     48s
</span></span><span class="line"><span class="cl">tomcat-service   ClusterIP   None         &lt;none&gt;        8080/TCP   48s
</span></span></code></pre></div><h5 id="753-http-代理">7.5.3 Http 代理</h5>
<p>创建 ingress-http.yaml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ingress-http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">nginx.itheima.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">servicePort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">tomcat.itheima.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l">tomcat-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">servicePort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f ingress-http.yaml</span>
</span></span><span class="line"><span class="cl">ingress.extensions/ingress-http created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get ing ingress-http -n dev</span>
</span></span><span class="line"><span class="cl">NAME           HOSTS                                  ADDRESS   PORTS   AGE
</span></span><span class="line"><span class="cl">ingress-http   nginx.itheima.com,tomcat.itheima.com             <span class="m">80</span>      22s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看详情</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl describe ing ingress-http  -n dev</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Rules:
</span></span><span class="line"><span class="cl">Host                Path  Backends
</span></span><span class="line"><span class="cl">----                ----  --------
</span></span><span class="line"><span class="cl">nginx.itheima.com   / nginx-service:80 <span class="o">(</span>10.244.1.96:80,10.244.1.97:80,10.244.2.112:80<span class="o">)</span>
</span></span><span class="line"><span class="cl">tomcat.itheima.com  / tomcat-service:8080<span class="o">(</span>10.244.1.94:8080,10.244.1.95:8080,10.244.2.111:8080<span class="o">)</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 接下来,在本地电脑上配置host文件,解析上面的两个域名到192.168.109.100(master)上</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 然后,就可以分别访问tomcat.itheima.com:32240  和  nginx.itheima.com:32240 查看效果了</span>
</span></span></code></pre></div><h5 id="754-https-代理">7.5.4 Https 代理</h5>
<p>创建证书</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 生成证书</span>
</span></span><span class="line"><span class="cl">openssl req -x509 -sha256 -nodes -days <span class="m">365</span> -newkey rsa:2048 -keyout tls.key -out tls.crt -subj <span class="s2">&#34;/C=CN/ST=BJ/L=BJ/O=nginx/CN=itheima.com&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建密钥</span>
</span></span><span class="line"><span class="cl">kubectl create secret tls tls-secret --key tls.key --cert tls.crt
</span></span></code></pre></div><p>创建 ingress-https.yaml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ingress-https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">nginx.itheima.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">tomcat.itheima.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">tls-secret</span><span class="w"> </span><span class="c"># 指定秘钥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">nginx.itheima.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">servicePort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">tomcat.itheima.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l">tomcat-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">servicePort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f ingress-https.yaml</span>
</span></span><span class="line"><span class="cl">ingress.extensions/ingress-https created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get ing ingress-https -n dev</span>
</span></span><span class="line"><span class="cl">NAME            HOSTS                                  ADDRESS         PORTS     AGE
</span></span><span class="line"><span class="cl">ingress-https   nginx.itheima.com,tomcat.itheima.com   10.104.184.38   80, <span class="m">443</span>   2m42s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看详情</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl describe ing ingress-https -n dev</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">TLS:
</span></span><span class="line"><span class="cl">  tls-secret terminates nginx.itheima.com,tomcat.itheima.com
</span></span><span class="line"><span class="cl">Rules:
</span></span><span class="line"><span class="cl">Host              Path Backends
</span></span><span class="line"><span class="cl">----              ---- --------
</span></span><span class="line"><span class="cl">nginx.itheima.com  /  nginx-service:80 <span class="o">(</span>10.244.1.97:80,10.244.1.98:80,10.244.2.119:80<span class="o">)</span>
</span></span><span class="line"><span class="cl">tomcat.itheima.com /  tomcat-service:8080<span class="o">(</span>10.244.1.99:8080,10.244.2.117:8080,10.244.2.120:8080<span class="o">)</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 下面可以通过浏览器访问https:/nginx.itheima.com:31335 和 https:/tomcat.itheima.com:31335来查看了</span>
</span></span></code></pre></div><h3 id="8-数据存储">8. 数据存储</h3>
<p>在前面已经提到，容器的生命周期可能很短，会被频繁地创建和销毁。那么容器在销毁时，保存在容器中的数据也会被清除。这种结果对用户来说，在某些情况下是不乐意看到的。为了持久化保存容器的数据，kubernetes 引入了 Volume 的概念。</p>
<p>Volume 是 Pod 中能够被多个容器访问的共享目录，它被定义在 Pod 上，然后被一个 Pod 里的多个容器挂载到具体的文件目录下，kubernetes 通过 Volume 实现同一个 Pod 中不同容器之间的数据共享以及数据的持久化存储。Volume 的生命容器不与 Pod 中单个容器的生命周期相关，当容器终止或者重启时，Volume 中的数据也不会丢失。</p>
<p>kubernetes 的 Volume 支持多种类型，比较常见的有下面几个：</p>
<ul>
<li>简单存储：EmptyDir、HostPath、NFS</li>
<li>高级存储：PV、PVC</li>
<li>配置存储：ConfigMap、Secret</li>
</ul>
<h4 id="81-基本存储">8.1 基本存储</h4>
<h5 id="811-emptydir">8.1.1 EmptyDir</h5>
<p>EmptyDir 是最基础的 Volume 类型，一个 EmptyDir 就是 Host 上的一个空目录。</p>
<p>EmptyDir 是在 Pod 被分配到 Node 时创建的，它的初始内容为空，并且无须指定宿主机上对应的目录文件，因为 kubernetes 会自动分配一个目录，当 Pod 销毁时， EmptyDir 中的数据也会被永久删除。 EmptyDir 用途如下：</p>
<ul>
<li>临时空间，例如用于某些应用程序运行时所需的临时目录，且无须永久保留</li>
<li>一个容器需要从另一个容器中获取数据的目录（多容器共享目录）</li>
</ul>
<p>接下来，通过一个容器之间文件共享的案例来使用一下 EmptyDir。</p>
<p>在一个 Pod 中准备两个容器 nginx 和 busybox，然后声明一个 Volume 分别挂在到两个容器的目录中，然后 nginx 容器负责向 Volume 中写日志，busybox 中通过命令将日志内容读到控制台。</p>
<p><a href="/p/2024122601/upload/image-20200413174713773.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200413174713773.png"
	width="971"
	height="418"
	srcset="/p/2024122601/upload/image-20200413174713773_hu73a6d766ee7a3fcef85aaf3f59fc4e61_25887_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200413174713773_hu73a6d766ee7a3fcef85aaf3f59fc4e61_25887_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<p>创建一个 volume-emptydir.yaml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">volume-emptydir</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w"> </span><span class="c"># 将logs-volume挂在到nginx容器中，对应的目录为 /var/log/nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">logs-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/var/log/nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;tail -f /logs/access.log&#34;</span><span class="p">]</span><span class="w"> </span><span class="c"># 初始命令，动态读取指定文件中内容</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w"> </span><span class="c"># 将logs-volume 挂在到busybox容器中，对应的目录为 /logs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">logs-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/logs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w"> </span><span class="c"># 声明volume， name为logs-volume，类型为emptyDir</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">logs-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">emptyDir</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建Pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f volume-emptydir.yaml</span>
</span></span><span class="line"><span class="cl">pod/volume-emptydir created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods volume-emptydir -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME                  READY   STATUS    RESTARTS   AGE      IP       NODE   ......
</span></span><span class="line"><span class="cl">volume-emptydir       2/2     Running   <span class="m">0</span>          97s   10.42.2.9   node1  ......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 通过podIp访问nginx</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># curl 10.42.2.9</span>
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 通过kubectl logs命令查看指定容器的标准输出</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl logs -f volume-emptydir -n dev -c busybox</span>
</span></span><span class="line"><span class="cl">10.42.1.0 - - <span class="o">[</span>27/Jun/2021:15:08:54 +0000<span class="o">]</span> <span class="s2">&#34;GET / HTTP/1.1&#34;</span> <span class="m">200</span> <span class="m">612</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;curl/7.29.0&#34;</span> <span class="s2">&#34;-&#34;</span>
</span></span></code></pre></div><h5 id="812-hostpath">8.1.2 HostPath</h5>
<p>上节课提到，EmptyDir 中数据不会被持久化，它会随着 Pod 的结束而销毁，如果想简单的将数据持久化到主机中，可以选择 HostPath。</p>
<p>HostPath 就是将 Node 主机中一个实际目录挂在到 Pod 中，以供容器使用，这样的设计就可以保证 Pod 销毁了，但是数据依据可以存在于 Node 主机上。</p>
<p><a href="/p/2024122601/upload/image-20200413214031331.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200413214031331.png"
	width="1130"
	height="523"
	srcset="/p/2024122601/upload/image-20200413214031331_huff99311236a4fb4bf3c85f0da86c46b3_27745_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200413214031331_huff99311236a4fb4bf3c85f0da86c46b3_27745_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<p>创建一个 volume-hostpath.yaml：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">volume-hostpath</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">logs-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/var/log/nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;tail -f /logs/access.log&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">logs-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/logs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">logs-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/root/logs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">DirectoryOrCreate</span><span class="w"> </span><span class="c"># 目录存在就使用，不存在就先创建后使用</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">关于type的值的一点说明：
</span></span><span class="line"><span class="cl">    DirectoryOrCreate 目录存在就使用，不存在就先创建后使用
</span></span><span class="line"><span class="cl">    Directory   目录必须存在
</span></span><span class="line"><span class="cl">    FileOrCreate  文件存在就使用，不存在就先创建后使用
</span></span><span class="line"><span class="cl">    File 文件必须存在
</span></span><span class="line"><span class="cl">    Socket  unix套接字必须存在
</span></span><span class="line"><span class="cl">    CharDevice  字符设备必须存在
</span></span><span class="line"><span class="cl">    BlockDevice 块设备必须存在
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建Pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f volume-hostpath.yaml</span>
</span></span><span class="line"><span class="cl">pod/volume-hostpath created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看Pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods volume-hostpath -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME                  READY   STATUS    RESTARTS   AGE   IP             NODE   ......
</span></span><span class="line"><span class="cl">pod-volume-hostpath   2/2     Running   <span class="m">0</span>          16s   10.42.2.10     node1  ......
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#访问nginx</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># curl 10.42.2.10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl logs -f volume-emptydir -n dev -c busybox</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 接下来就可以去host的/root/logs目录下查看存储的文件了</span>
</span></span><span class="line"><span class="cl"><span class="c1">###  注意: 下面的操作需要到Pod所在的节点运行（案例中是node1）</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@node1 ~<span class="o">]</span><span class="c1"># ls /root/logs/</span>
</span></span><span class="line"><span class="cl">access.log  error.log
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 同样的道理，如果在此目录下创建一个文件，到容器中也是可以看到的</span>
</span></span></code></pre></div><h5 id="813-nfs">8.1.3 NFS</h5>
<p>HostPath 可以解决数据持久化的问题，但是一旦 Node 节点故障了，Pod 如果转移到了别的节点，又会出现问题了，此时需要准备单独的网络存储系统，比较常用的用 NFS、CIFS。</p>
<p>NFS 是一个网络文件存储系统，可以搭建一台 NFS 服务器，然后将 Pod 中的存储直接连接到 NFS 系统上，这样的话，无论 Pod 在节点上怎么转移，只要 Node 跟 NFS 的对接没问题，数据就可以成功访问。</p>
<p><a href="/p/2024122601/upload/image-20200413215133559.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200413215133559.png"
	width="1296"
	height="389"
	srcset="/p/2024122601/upload/image-20200413215133559_hub0a71275073c2663a4f2f9a86a781b90_28720_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200413215133559_hub0a71275073c2663a4f2f9a86a781b90_28720_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<p>1）首先要准备 nfs 的服务器，这里为了简单，直接是 master 节点做 nfs 服务器</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 在nfs上安装nfs服务</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@nfs ~<span class="o">]</span><span class="c1"># yum install nfs-utils -y</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 准备一个共享目录</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@nfs ~<span class="o">]</span><span class="c1"># mkdir /root/data/nfs -pv</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 将共享目录以读写权限暴露给192.168.5.0/24网段中的所有主机</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@nfs ~<span class="o">]</span><span class="c1"># vim /etc/exports</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@nfs ~<span class="o">]</span><span class="c1"># more /etc/exports</span>
</span></span><span class="line"><span class="cl">/root/data/nfs     192.168.5.0/24<span class="o">(</span>rw,no_root_squash<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 启动nfs服务</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@nfs ~<span class="o">]</span><span class="c1"># systemctl restart nfs</span>
</span></span></code></pre></div><p>2）接下来，要在的每个 node 节点上都安装下 nfs，这样的目的是为了 node 节点可以驱动 nfs 设备</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 在node上安装nfs服务，注意不需要启动</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># yum install nfs-utils -y</span>
</span></span></code></pre></div><p>3）接下来，就可以编写 pod 的配置文件了，创建 volume-nfs.yaml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">volume-nfs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">logs-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/var/log/nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;tail -f /logs/access.log&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">logs-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/logs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">logs-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">nfs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.5.6</span><span class="w"> </span><span class="c">#nfs服务器地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/root/data/nfs</span><span class="w"> </span><span class="c">#共享文件路径</span><span class="w">
</span></span></span></code></pre></div><p>4）最后，运行下 pod，观察结果</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f volume-nfs.yaml</span>
</span></span><span class="line"><span class="cl">pod/volume-nfs created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods volume-nfs -n dev</span>
</span></span><span class="line"><span class="cl">NAME                  READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">volume-nfs        2/2     Running   <span class="m">0</span>          2m9s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看nfs服务器上的共享目录，发现已经有文件了</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># ls /root/data/</span>
</span></span><span class="line"><span class="cl">access.log  error.log
</span></span></code></pre></div><h4 id="82-高级存储">8.2 高级存储</h4>
<p>前面已经学习了使用 NFS 提供存储，此时就要求用户会搭建 NFS 系统，并且会在 yaml 配置 nfs。由于 kubernetes 支持的存储系统有很多，要求客户全都掌握，显然不现实。为了能够屏蔽底层存储实现的细节，方便用户使用， kubernetes 引入 PV 和 PVC 两种资源对象。</p>
<ul>
<li>
<p>PV（Persistent Volume）是持久化卷的意思，是对底层的共享存储的一种抽象。一般情况下 PV 由 kubernetes 管理员进行创建和配置，它与底层具体的共享存储技术有关，并通过插件完成与共享存储的对接。</p>
</li>
<li>
<p>PVC（Persistent Volume Claim）是持久卷声明的意思，是用户对于存储需求的一种声明。换句话说，PVC 其实就是用户向 kubernetes 系统发出的一种资源需求申请。</p>
</li>
</ul>
<p><a href="/p/2024122601/upload/image-20200514194111567.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200514194111567.png"
	width="1099"
	height="642"
	srcset="/p/2024122601/upload/image-20200514194111567_hu293d0e2b7f67f5c51bc9752351993ba2_30599_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200514194111567_hu293d0e2b7f67f5c51bc9752351993ba2_30599_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<p>使用了 PV 和 PVC 之后，工作可以得到进一步的细分：</p>
<ul>
<li>存储：存储工程师维护</li>
<li>PV： kubernetes 管理员维护</li>
<li>PVC：kubernetes 用户维护</li>
</ul>
<h5 id="821-pv">8.2.1 PV</h5>
<p>PV 是存储资源的抽象，下面是资源清单文件:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pv2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nfs</span><span class="p">:</span><span class="w"> </span><span class="c"># 存储类型，与底层真正存储对应</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span><span class="w"> </span><span class="c"># 存储能力，目前只支持存储空间的设置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">2Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w"> </span><span class="c"># 访问模式</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="c"># 存储类别</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="c"># 回收策略</span><span class="w">
</span></span></span></code></pre></div><p>PV 的关键配置参数说明：</p>
<ul>
<li>
<p>存储类型</p>
<p>底层实际存储的类型，kubernetes 支持多种存储类型，每种存储类型的配置都有所差异</p>
</li>
<li>
<p>存储能力（capacity）</p>
</li>
</ul>
<p>目前只支持存储空间的设置( storage=1Gi )，不过未来可能会加入 IOPS、吞吐量等指标的配置</p>
<ul>
<li>
<p>访问模式（accessModes）</p>
<p>用于描述用户应用对存储资源的访问权限，访问权限包括下面几种方式：</p>
<ul>
<li>ReadWriteOnce（RWO）：读写权限，但是只能被单个节点挂载</li>
<li>ReadOnlyMany（ROX）： 只读权限，可以被多个节点挂载</li>
<li>ReadWriteMany（RWX）：读写权限，可以被多个节点挂载</li>
</ul>
<p><code>需要注意的是，底层不同的存储类型可能支持的访问模式不同</code></p>
</li>
<li>
<p>回收策略（persistentVolumeReclaimPolicy）</p>
<p>当 PV 不再被使用了之后，对其的处理方式。目前支持三种策略：</p>
<ul>
<li>Retain （保留） 保留数据，需要管理员手工清理数据</li>
<li>Recycle（回收） 清除 PV 中的数据，效果相当于执行 rm -rf /thevolume/*</li>
<li>Delete （删除） 与 PV 相连的后端存储完成 volume 的删除操作，当然这常见于云服务商的存储服务</li>
</ul>
<p><code>需要注意的是，底层不同的存储类型可能支持的回收策略不同</code></p>
</li>
<li>
<p>存储类别</p>
<p>PV 可以通过 storageClassName 参数指定一个存储类别</p>
<ul>
<li>具有特定类别的 PV 只能与请求了该类别的 PVC 进行绑定</li>
<li>未设定类别的 PV 则只能与不请求任何类别的 PVC 进行绑定</li>
</ul>
</li>
<li>
<p>状态（status）</p>
<p>一个 PV 的生命周期中，可能会处于 4 中不同的阶段：</p>
<ul>
<li>Available（可用）： 表示可用状态，还未被任何 PVC 绑定</li>
<li>Bound（已绑定）： 表示 PV 已经被 PVC 绑定</li>
<li>Released（已释放）： 表示 PVC 被删除，但是资源还未被集群重新声明</li>
<li>Failed（失败）： 表示该 PV 的自动回收失败</li>
</ul>
</li>
</ul>
<p>实验</p>
<p>使用 NFS 作为存储，来演示 PV 的使用，创建 3 个 PV，对应 NFS 中的 3 个暴露的路径。</p>
<ol>
<li>准备 NFS 环境</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建目录</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@nfs ~<span class="o">]</span><span class="c1"># mkdir /root/data/{pv1,pv2,pv3} -pv</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 暴露服务</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@nfs ~<span class="o">]</span><span class="c1"># more /etc/exports</span>
</span></span><span class="line"><span class="cl">/root/data/pv1     192.168.5.0/24<span class="o">(</span>rw,no_root_squash<span class="o">)</span>
</span></span><span class="line"><span class="cl">/root/data/pv2     192.168.5.0/24<span class="o">(</span>rw,no_root_squash<span class="o">)</span>
</span></span><span class="line"><span class="cl">/root/data/pv3     192.168.5.0/24<span class="o">(</span>rw,no_root_squash<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 重启服务</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@nfs ~<span class="o">]</span><span class="c1">#  systemctl restart nfs</span>
</span></span></code></pre></div><p>创建 pv.yaml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pv1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">ReadWriteMany</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Retain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nfs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/root/data/pv1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.5.6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pv2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">2Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">ReadWriteMany</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Retain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nfs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/root/data/pv2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.5.6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pv3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">3Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">ReadWriteMany</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Retain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nfs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/root/data/pv3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.5.6</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建 pv</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pv.yaml</span>
</span></span><span class="line"><span class="cl">persistentvolume/pv1 created
</span></span><span class="line"><span class="cl">persistentvolume/pv2 created
</span></span><span class="line"><span class="cl">persistentvolume/pv3 created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pv</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pv -o wide</span>
</span></span><span class="line"><span class="cl">NAME   CAPACITY   ACCESS MODES  RECLAIM POLICY  STATUS      AGE   VOLUMEMODE
</span></span><span class="line"><span class="cl">pv1    1Gi        RWX            Retain        Available    10s   Filesystem
</span></span><span class="line"><span class="cl">pv2    2Gi        RWX            Retain        Available    10s   Filesystem
</span></span><span class="line"><span class="cl">pv3    3Gi        RWX            Retain        Available    9s    Filesystem
</span></span></code></pre></div><h5 id="822-pvc">8.2.2 PVC</h5>
<p>PVC 是资源的申请，用来声明对存储空间、访问模式、存储类别需求信息。下面是资源清单文件:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pvc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w"> </span><span class="c"># 访问模式</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="c"># 采用标签对PV选择</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="c"># 存储类别</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="c"># 请求空间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">5Gi</span><span class="w">
</span></span></span></code></pre></div><p>PVC 的关键配置参数说明：</p>
<ul>
<li>访问模式（accessModes）</li>
</ul>
<p>用于描述用户应用对存储资源的访问权限</p>
<ul>
<li>
<p>选择条件（selector）</p>
<p>通过 Label Selector 的设置，可使 PVC 对于系统中己存在的 PV 进行筛选</p>
</li>
<li>
<p>存储类别（storageClassName）</p>
<p>PVC 在定义时可以设定需要的后端存储的类别，只有设置了该 class 的 pv 才能被系统选出</p>
</li>
<li>
<p>资源请求（Resources ）</p>
<p>描述对存储资源的请求</p>
</li>
</ul>
<p>实验</p>
<ol>
<li>创建 pvc.yaml，申请 pv</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pvc1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">ReadWriteMany</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pvc2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">ReadWriteMany</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pvc3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">ReadWriteMany</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建pvc</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pvc.yaml</span>
</span></span><span class="line"><span class="cl">persistentvolumeclaim/pvc1 created
</span></span><span class="line"><span class="cl">persistentvolumeclaim/pvc2 created
</span></span><span class="line"><span class="cl">persistentvolumeclaim/pvc3 created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pvc</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pvc  -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME   STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE   VOLUMEMODE
</span></span><span class="line"><span class="cl">pvc1   Bound    pv1      1Gi        RWX                           15s   Filesystem
</span></span><span class="line"><span class="cl">pvc2   Bound    pv2      2Gi        RWX                           15s   Filesystem
</span></span><span class="line"><span class="cl">pvc3   Bound    pv3      3Gi        RWX                           15s   Filesystem
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pv</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pv -o wide</span>
</span></span><span class="line"><span class="cl">NAME  CAPACITY ACCESS MODES  RECLAIM POLICY  STATUS    CLAIM       AGE     VOLUMEMODE
</span></span><span class="line"><span class="cl">pv1    1Gi        RWx        Retain          Bound    dev/pvc1    3h37m    Filesystem
</span></span><span class="line"><span class="cl">pv2    2Gi        RWX        Retain          Bound    dev/pvc2    3h37m    Filesystem
</span></span><span class="line"><span class="cl">pv3    3Gi        RWX        Retain          Bound    dev/pvc3    3h37m    Filesystem
</span></span></code></pre></div><p>创建 pods.yaml, 使用 pv</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="s2">&#34;while true;do echo pod1 &gt;&gt; /root/out.txt; sleep 10; done;&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/root/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l">pvc1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="s2">&#34;while true;do echo pod2 &gt;&gt; /root/out.txt; sleep 10; done;&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/root/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l">pvc2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pods.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod1 created
</span></span><span class="line"><span class="cl">pod/pod2 created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME   READY   STATUS    RESTARTS   AGE   IP            NODE
</span></span><span class="line"><span class="cl">pod1   1/1     Running   <span class="m">0</span>          14s   10.244.1.69   node1
</span></span><span class="line"><span class="cl">pod2   1/1     Running   <span class="m">0</span>          14s   10.244.1.70   node1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pvc</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pvc -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME   STATUS   VOLUME   CAPACITY   ACCESS MODES      AGE   VOLUMEMODE
</span></span><span class="line"><span class="cl">pvc1   Bound    pv1      1Gi        RWX               94m   Filesystem
</span></span><span class="line"><span class="cl">pvc2   Bound    pv2      2Gi        RWX               94m   Filesystem
</span></span><span class="line"><span class="cl">pvc3   Bound    pv3      3Gi        RWX               94m   Filesystem
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pv</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pv -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME   CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM       AGE     VOLUMEMODE
</span></span><span class="line"><span class="cl">pv1    1Gi        RWX            Retain           Bound    dev/pvc1    5h11m   Filesystem
</span></span><span class="line"><span class="cl">pv2    2Gi        RWX            Retain           Bound    dev/pvc2    5h11m   Filesystem
</span></span><span class="line"><span class="cl">pv3    3Gi        RWX            Retain           Bound    dev/pvc3    5h11m   Filesystem
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看nfs中的文件存储</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@nfs ~<span class="o">]</span><span class="c1"># more /root/data/pv1/out.txt</span>
</span></span><span class="line"><span class="cl">node1
</span></span><span class="line"><span class="cl">node1
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@nfs ~<span class="o">]</span><span class="c1"># more /root/data/pv2/out.txt</span>
</span></span><span class="line"><span class="cl">node2
</span></span><span class="line"><span class="cl">node2
</span></span></code></pre></div><h5 id="823-生命周期">8.2.3 生命周期</h5>
<p>PVC 和 PV 是一一对应的，PV 和 PVC 之间的相互作用遵循以下生命周期：</p>
<ul>
<li>
<p>资源供应：管理员手动创建底层存储和 PV</p>
</li>
<li>
<p>资源绑定：用户创建 PVC，kubernetes 负责根据 PVC 的声明去寻找 PV，并绑定</p>
<p>在用户定义好 PVC 之后，系统将根据 PVC 对存储资源的请求在已存在的 PV 中选择一个满足条件的</p>
<ul>
<li>一旦找到，就将该 PV 与用户定义的 PVC 进行绑定，用户的应用就可以使用这个 PVC 了</li>
<li>如果找不到，PVC 则会无限期处于 Pending 状态，直到等到系统管理员创建了一个符合其要求的 PV</li>
</ul>
<p>PV 一旦绑定到某个 PVC 上，就会被这个 PVC 独占，不能再与其他 PVC 进行绑定了</p>
</li>
<li>
<p>资源使用：用户可在 pod 中像 volume 一样使用 pvc</p>
<p>Pod 使用 Volume 的定义，将 PVC 挂载到容器内的某个路径进行使用。</p>
</li>
<li>
<p>资源释放：用户删除 pvc 来释放 pv</p>
<p>当存储资源使用完毕后，用户可以删除 PVC，与该 PVC 绑定的 PV 将会被标记为“已释放”，但还不能立刻与其他 PVC 进行绑定。通过之前 PVC 写入的数据可能还被留在存储设备上，只有在清除之后该 PV 才能再次使用。</p>
</li>
<li>
<p>资源回收：kubernetes 根据 pv 设置的回收策略进行资源的回收</p>
<p>对于 PV，管理员可以设定回收策略，用于设置与之绑定的 PVC 释放资源之后如何处理遗留数据的问题。只有 PV 的存储空间完成回收，才能供新的 PVC 绑定和使用</p>
</li>
</ul>
<p><a href="/p/2024122601/upload/image-20200515002806726.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200515002806726.png"
	width="1219"
	height="542"
	srcset="/p/2024122601/upload/image-20200515002806726_hucc81c1e815289c4f38265954d036e4f8_32246_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200515002806726_hucc81c1e815289c4f38265954d036e4f8_32246_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<h4 id="83-配置存储">8.3 配置存储</h4>
<h5 id="831-configmap">8.3.1 ConfigMap</h5>
<p>ConfigMap 是一种比较特殊的存储卷，它的主要作用是用来存储配置信息的。</p>
<p>创建 configmap.yaml，内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">configmap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">info</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    username:admin
</span></span></span><span class="line"><span class="cl"><span class="sd">    password:123456</span><span class="w">    
</span></span></span></code></pre></div><p>接下来，使用此配置文件创建 configmap</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建configmap</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f configmap.yaml</span>
</span></span><span class="line"><span class="cl">configmap/configmap created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看configmap详情</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl describe cm configmap -n dev</span>
</span></span><span class="line"><span class="cl">Name:         configmap
</span></span><span class="line"><span class="cl">Namespace:    dev
</span></span><span class="line"><span class="cl">Labels:       &lt;none&gt;
</span></span><span class="line"><span class="cl">Annotations:  &lt;none&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">Data</span>
</span></span><span class="line"><span class="cl"><span class="o">====</span>
</span></span><span class="line"><span class="cl">info:
</span></span><span class="line"><span class="cl">----
</span></span><span class="line"><span class="cl">username:admin
</span></span><span class="line"><span class="cl">password:123456
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Events:  &lt;none&gt;
</span></span></code></pre></div><p>接下来创建一个 pod-configmap.yaml，将上面创建的 configmap 挂载进去</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-configmap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w"> </span><span class="c"># 将configmap挂载到目录</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/configmap/config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w"> </span><span class="c"># 引用configmap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">configmap</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pod-configmap.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-configmap created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pod pod-configmap -n dev</span>
</span></span><span class="line"><span class="cl">NAME            READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod-configmap   1/1     Running   <span class="m">0</span>          6s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#进入容器</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl exec -it pod-configmap -n dev /bin/sh</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cd /configmap/config/</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ls</span>
</span></span><span class="line"><span class="cl">info
</span></span><span class="line"><span class="cl"><span class="c1"># more info</span>
</span></span><span class="line"><span class="cl">username:admin
</span></span><span class="line"><span class="cl">password:123456
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 可以看到映射已经成功，每个configmap都映射成了一个目录</span>
</span></span><span class="line"><span class="cl"><span class="c1"># key---&gt;文件     value----&gt;文件中的内容</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 此时如果更新configmap的内容, 容器中的值也会动态更新</span>
</span></span></code></pre></div><h5 id="832-secret">8.3.2 Secret</h5>
<p>在 kubernetes 中，还存在一种和 ConfigMap 非常类似的对象，称为 Secret 对象。它主要用于存储敏感信息，例如密码、秘钥、证书等等。</p>
<ol>
<li>首先使用 base64 对数据进行编码</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># echo -n &#39;admin&#39; | base64 #准备username</span>
</span></span><span class="line"><span class="cl"><span class="nv">YWRtaW4</span><span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># echo -n &#39;123456&#39; | base64 #准备password</span>
</span></span><span class="line"><span class="cl">MTIzNDU2
</span></span></code></pre></div><p>接下来编写 secret.yaml，并创建 Secret</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">YWRtaW4=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">MTIzNDU2</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建secret</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f secret.yaml</span>
</span></span><span class="line"><span class="cl">secret/secret created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看secret详情</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl describe secret secret -n dev</span>
</span></span><span class="line"><span class="cl">Name:         secret
</span></span><span class="line"><span class="cl">Namespace:    dev
</span></span><span class="line"><span class="cl">Labels:       &lt;none&gt;
</span></span><span class="line"><span class="cl">Annotations:  &lt;none&gt;
</span></span><span class="line"><span class="cl">Type:  Opaque
</span></span><span class="line"><span class="cl"><span class="nv">Data</span>
</span></span><span class="line"><span class="cl"><span class="o">====</span>
</span></span><span class="line"><span class="cl">password:  <span class="m">6</span> bytes
</span></span><span class="line"><span class="cl">username:  <span class="m">5</span> bytes
</span></span></code></pre></div><p>创建 pod-secret.yaml，将上面创建的 secret 挂载进去：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w"> </span><span class="c"># 将secret挂载到目录</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/secret/config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">secret</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">secret</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pod-secret.yaml</span>
</span></span><span class="line"><span class="cl">pod/pod-secret created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pod pod-secret -n dev</span>
</span></span><span class="line"><span class="cl">NAME            READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod-secret      1/1     Running   <span class="m">0</span>          2m28s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 进入容器，查看secret信息，发现已经自动解码了</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl exec -it pod-secret /bin/sh -n dev</span>
</span></span><span class="line"><span class="cl">/ <span class="c1"># ls /secret/config/</span>
</span></span><span class="line"><span class="cl">password  username
</span></span><span class="line"><span class="cl">/ <span class="c1"># more /secret/config/username</span>
</span></span><span class="line"><span class="cl">admin
</span></span><span class="line"><span class="cl">/ <span class="c1"># more /secret/config/password</span>
</span></span><span class="line"><span class="cl"><span class="m">123456</span>
</span></span></code></pre></div><p>至此，已经实现了利用 secret 实现了信息的编码。</p>
<h3 id="9-安全认证">9. 安全认证</h3>
<h4 id="91-访问控制概述">9.1 访问控制概述</h4>
<p>Kubernetes 作为一个分布式集群的管理工具，保证集群的安全性是其一个重要的任务。所谓的安全性其实就是保证对 Kubernetes 的各种客户端进行认证和鉴权操作。</p>
<p>客户端</p>
<p>在 Kubernetes 集群中，客户端通常有两类：</p>
<ul>
<li>User Account：一般是独立于 kubernetes 之外的其他服务管理的用户账号。</li>
<li>Service Account：kubernetes 管理的账号，用于为 Pod 中的服务进程在访问 Kubernetes 时提供身份标识。</li>
</ul>
<p><a href="/p/2024122601/upload/image-20200520102949189.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200520102949189.png"
	width="857"
	height="287"
	srcset="/p/2024122601/upload/image-20200520102949189_hu0e8ec5522157dda9600aff8e7ff8c49a_20744_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200520102949189_hu0e8ec5522157dda9600aff8e7ff8c49a_20744_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<p>认证、授权与准入控制</p>
<p>ApiServer 是访问及管理资源对象的唯一入口。任何一个请求访问 ApiServer，都要经过下面三个流程：</p>
<ul>
<li>Authentication（认证）：身份鉴别，只有正确的账号才能够通过认证</li>
<li>Authorization（授权）： 判断用户是否有权限对访问的资源执行特定的动作</li>
<li>Admission Control（准入控制）：用于补充授权机制以实现更加精细的访问控制功能。</li>
</ul>
<p><a href="/p/2024122601/upload/image-20200520103942580.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200520103942580.png"
	width="1017"
	height="214"
	srcset="/p/2024122601/upload/image-20200520103942580_huaca05647a92b4de56dba20e9345537d6_14526_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200520103942580_huaca05647a92b4de56dba20e9345537d6_14526_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<h4 id="92-认证管理">9.2 认证管理</h4>
<p>Kubernetes 集群安全的最关键点在于如何识别并认证客户端身份，它提供了 3 种客户端身份认证方式：</p>
<ul>
<li>
<p>HTTP Base 认证：通过用户名+密码的方式认证</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">    这种认证方式是把“用户名:密码”用BASE64算法进行编码后的字符串放在HTTP请求中的Header Authorization域里发送给服务端。服务端收到后进行解码，获取用户名及密码，然后进行用户身份认证的过程。
</span></span></code></pre></div></li>
<li>
<p>HTTP Token 认证：通过一个 Token 来识别合法用户</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">    这种认证方式是用一个很长的难以被模仿的字符串--Token来表明客户身份的一种方式。每个Token对应一个用户名，当客户端发起API调用请求时，需要在HTTP Header里放入Token，API Server接到Token后会跟服务器中保存的token进行比对，然后进行用户身份认证的过程。
</span></span></code></pre></div></li>
<li>
<p>HTTPS 证书认证：基于 CA 根证书签名的双向数字证书认证方式</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">    这种认证方式是安全性最高的一种方式，但是同时也是操作起来最麻烦的一种方式。
</span></span></code></pre></div></li>
</ul>
<p><a href="/p/2024122601/upload/image-20200518211037434.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200518211037434.png"
	width="980"
	height="487"
	srcset="/p/2024122601/upload/image-20200518211037434_hu116da862fc2264728160af50aa023299_29170_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200518211037434_hu116da862fc2264728160af50aa023299_29170_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<p>HTTPS 认证大体分为 3 个过程：</p>
<ol>
<li>
<p>证书申请和下发</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">  HTTPS通信双方的服务器向CA机构申请证书，CA机构下发根证书、服务端证书及私钥给申请者
</span></span></code></pre></div></li>
<li>
<p>客户端和服务端的双向认证</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">  1&gt; 客户端向服务器端发起请求，服务端下发自己的证书给客户端，
</span></span><span class="line"><span class="cl">     客户端接收到证书后，通过私钥解密证书，在证书中获得服务端的公钥，
</span></span><span class="line"><span class="cl">     客户端利用服务器端的公钥认证证书中的信息，如果一致，则认可这个服务器
</span></span><span class="line"><span class="cl">  2&gt; 客户端发送自己的证书给服务器端，服务端接收到证书后，通过私钥解密证书，
</span></span><span class="line"><span class="cl">     在证书中获得客户端的公钥，并用该公钥认证证书信息，确认客户端是否合法
</span></span></code></pre></div></li>
<li>
<p>服务器端和客户端进行通信</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">  服务器端和客户端协商好加密方案后，客户端会产生一个随机的秘钥并加密，然后发送到服务器端。
</span></span><span class="line"><span class="cl">  服务器端接收这个秘钥后，双方接下来通信的所有内容都通过该随机秘钥加密
</span></span></code></pre></div></li>
</ol>
<blockquote>
<p>注意: Kubernetes 允许同时配置多种认证方式，只要其中任意一个方式认证通过即可</p>
</blockquote>
<h4 id="93-授权管理">9.3 授权管理</h4>
<p>授权发生在认证成功之后，通过认证就可以知道请求用户是谁， 然后 Kubernetes 会根据事先定义的授权策略来决定用户是否有权限访问，这个过程就称为授权。</p>
<p>每个发送到 ApiServer 的请求都带上了用户和资源的信息：比如发送请求的用户、请求的路径、请求的动作等，授权就是根据这些信息和授权策略进行比较，如果符合策略，则认为授权通过，否则会返回错误。</p>
<p>API Server 目前支持以下几种授权策略：</p>
<ul>
<li>AlwaysDeny：表示拒绝所有请求，一般用于测试</li>
<li>AlwaysAllow：允许接收所有请求，相当于集群不需要授权流程（Kubernetes 默认的策略）</li>
<li>ABAC：基于属性的访问控制，表示使用用户配置的授权规则对用户请求进行匹配和控制</li>
<li>Webhook：通过调用外部 REST 服务对用户进行授权</li>
<li>Node：是一种专用模式，用于对 kubelet 发出的请求进行访问控制</li>
<li>RBAC：基于角色的访问控制（kubeadm 安装方式下的默认选项）</li>
</ul>
<p>RBAC(Role-Based Access Control) 基于角色的访问控制，主要是在描述一件事情：给哪些对象授予了哪些权限</p>
<p>其中涉及到了下面几个概念：</p>
<ul>
<li>对象：User、Groups、ServiceAccount</li>
<li>角色：代表着一组定义在资源上的可操作动作(权限)的集合</li>
<li>绑定：将定义好的角色跟用户绑定在一起</li>
</ul>
<p><a href="/p/2024122601/upload/image-20200519181209566.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200519181209566.png"
	width="911"
	height="464"
	srcset="/p/2024122601/upload/image-20200519181209566_huaba25eac4a3553497c268c4974f1c494_19659_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200519181209566_huaba25eac4a3553497c268c4974f1c494_19659_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<p>RBAC 引入了 4 个顶级资源对象：</p>
<ul>
<li>Role、ClusterRole：角色，用于指定一组权限</li>
<li>RoleBinding、ClusterRoleBinding：角色绑定，用于将角色（权限）赋予给对象</li>
</ul>
<p>Role、ClusterRole</p>
<p>一个角色就是一组权限的集合，这里的权限都是许可形式的（白名单）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># Role只能对命名空间内的资源进行授权，需要指定nameapce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">authorization-role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w"> </span><span class="c"># 支持的API组列表,&#34;&#34; 空字符串，表示核心API群</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;pods&#34;</span><span class="p">]</span><span class="w"> </span><span class="c"># 支持的资源对象列表</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;watch&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">]</span><span class="w"> </span><span class="c"># 允许的对资源对象的操作方法列表</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># ClusterRole可以对集群范围内资源、跨namespaces的范围资源、非资源类型进行授权</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">authorization-clusterrole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;pods&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;watch&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><p>需要详细说明的是，rules 中的参数：</p>
<ul>
<li>
<p>apiGroups: 支持的 API 组列表</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="s2">&#34;&#34;</span>,<span class="s2">&#34;apps&#34;</span>, <span class="s2">&#34;autoscaling&#34;</span>, <span class="s2">&#34;batch&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>resources：支持的资源对象列表</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="s2">&#34;services&#34;</span>, <span class="s2">&#34;endpoints&#34;</span>, <span class="s2">&#34;pods&#34;</span>,<span class="s2">&#34;secrets&#34;</span>,<span class="s2">&#34;configmaps&#34;</span>,<span class="s2">&#34;crontabs&#34;</span>,<span class="s2">&#34;deployments&#34;</span>,<span class="s2">&#34;jobs&#34;</span>,
</span></span><span class="line"><span class="cl"><span class="s2">&#34;nodes&#34;</span>,<span class="s2">&#34;rolebindings&#34;</span>,<span class="s2">&#34;clusterroles&#34;</span>,<span class="s2">&#34;daemonsets&#34;</span>,<span class="s2">&#34;replicasets&#34;</span>,<span class="s2">&#34;statefulsets&#34;</span>,
</span></span><span class="line"><span class="cl"><span class="s2">&#34;horizontalpodautoscalers&#34;</span>,<span class="s2">&#34;replicationcontrollers&#34;</span>,<span class="s2">&#34;cronjobs&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>verbs：对资源对象的操作方法列表</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="s2">&#34;get&#34;</span>, <span class="s2">&#34;list&#34;</span>, <span class="s2">&#34;watch&#34;</span>, <span class="s2">&#34;create&#34;</span>, <span class="s2">&#34;update&#34;</span>, <span class="s2">&#34;patch&#34;</span>, <span class="s2">&#34;delete&#34;</span>, <span class="s2">&#34;exec&#34;</span>
</span></span></code></pre></div></li>
</ul>
<p>RoleBinding、ClusterRoleBinding</p>
<p>角色绑定用来把一个角色绑定到一个目标对象上，绑定目标可以是 User、Group 或者 ServiceAccount。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># RoleBinding可以将同一namespace中的subject绑定到某个Role下，则此subject即具有该Role定义的权限</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">RoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">authorization-role-binding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">User</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">heima</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">authorization-role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># ClusterRoleBinding在整个集群级别和所有namespaces将特定的subject与ClusterRole绑定，授予权限</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">authorization-clusterrole-binding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">User</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">heima</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">authorization-clusterrole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span></code></pre></div><p>RoleBinding 引用 ClusterRole 进行授权</p>
<p>RoleBinding 可以引用 ClusterRole，对属于同一命名空间内 ClusterRole 定义的资源主体进行授权。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">    一种很常用的做法就是，集群管理员为集群范围预定义好一组角色（ClusterRole），然后在多个命名空间中重复使用这些ClusterRole。这样可以大幅提高授权管理工作效率，也使得各个命名空间下的基础性授权规则与使用体验保持一致。
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># 虽然authorization-clusterrole是一个集群角色，但是因为使用了RoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 所以heima只能读取dev命名空间中的资源</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">RoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">authorization-role-binding-ns</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">User</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">heima</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">authorization-clusterrole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span></code></pre></div><p>实战：创建一个只能管理 dev 空间下 Pods 资源的账号</p>
<ol>
<li>创建账号</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 1) 创建证书</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 pki<span class="o">]</span><span class="c1"># cd /etc/kubernetes/pki/</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 pki<span class="o">]</span><span class="c1"># (umask 077;openssl genrsa -out devman.key 2048)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 2) 用apiserver的证书去签署</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 2-1) 签名申请，申请的用户是devman,组是devgroup</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 pki<span class="o">]</span><span class="c1"># openssl req -new -key devman.key -out devman.csr -subj &#34;/CN=devman/O=devgroup&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 2-2) 签署证书</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 pki<span class="o">]</span><span class="c1"># openssl x509 -req -in devman.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out devman.crt -days 3650</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 3) 设置集群、用户、上下文信息</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 pki<span class="o">]</span><span class="c1"># kubectl config set-cluster kubernetes --embed-certs=true --certificate-authority=/etc/kubernetes/pki/ca.crt --server=https:/192.168.109.100:6443</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 pki<span class="o">]</span><span class="c1"># kubectl config set-credentials devman --embed-certs=true --client-certificate=/etc/kubernetes/pki/devman.crt --client-key=/etc/kubernetes/pki/devman.key</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 pki<span class="o">]</span><span class="c1"># kubectl config set-context devman@kubernetes --cluster=kubernetes --user=devman</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 切换账户到devman</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 pki<span class="o">]</span><span class="c1"># kubectl config use-context devman@kubernetes</span>
</span></span><span class="line"><span class="cl">Switched to context <span class="s2">&#34;devman@kubernetes&#34;</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看dev下pod，发现没有权限</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 pki<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">Error from server <span class="o">(</span>Forbidden<span class="o">)</span>: pods is forbidden: User <span class="s2">&#34;devman&#34;</span> cannot list resource <span class="s2">&#34;pods&#34;</span> in API group <span class="s2">&#34;&#34;</span> in the namespace <span class="s2">&#34;dev&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 切换到admin账户</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 pki<span class="o">]</span><span class="c1"># kubectl config use-context kubernetes-admin@kubernetes</span>
</span></span><span class="line"><span class="cl">Switched to context <span class="s2">&#34;kubernetes-admin@kubernetes&#34;</span>.
</span></span></code></pre></div><p>2） 创建 Role 和 RoleBinding，为 devman 用户授权</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dev-role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;pods&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;watch&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">RoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">authorization-role-binding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">User</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">devman</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dev-role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 pki<span class="o">]</span><span class="c1"># kubectl create -f dev-role.yaml</span>
</span></span><span class="line"><span class="cl">role.rbac.authorization.k8s.io/dev-role created
</span></span><span class="line"><span class="cl">rolebinding.rbac.authorization.k8s.io/authorization-role-binding created
</span></span></code></pre></div><p>切换账户，再次验证</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 切换账户到devman</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 pki<span class="o">]</span><span class="c1"># kubectl config use-context devman@kubernetes</span>
</span></span><span class="line"><span class="cl">Switched to context <span class="s2">&#34;devman@kubernetes&#34;</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 再次查看</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 pki<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">NAME                                 READY   STATUS             RESTARTS   AGE
</span></span><span class="line"><span class="cl">nginx-deployment-66cb59b984-8wp2k    1/1     Running            <span class="m">0</span>          4d1h
</span></span><span class="line"><span class="cl">nginx-deployment-66cb59b984-dc46j    1/1     Running            <span class="m">0</span>          4d1h
</span></span><span class="line"><span class="cl">nginx-deployment-66cb59b984-thfck    1/1     Running            <span class="m">0</span>          4d1h
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 为了不影响后面的学习,切回admin账户</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 pki<span class="o">]</span><span class="c1"># kubectl config use-context kubernetes-admin@kubernetes</span>
</span></span><span class="line"><span class="cl">Switched to context <span class="s2">&#34;kubernetes-admin@kubernetes&#34;</span>.
</span></span></code></pre></div><h4 id="94-准入控制">9.4 准入控制</h4>
<p>通过了前面的认证和授权之后，还需要经过准入控制处理通过之后，apiserver 才会处理这个请求。</p>
<p>准入控制是一个可配置的控制器列表，可以通过在 Api-Server 上通过命令行设置选择执行哪些准入控制器：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">--admission-control<span class="o">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeLabel,
</span></span><span class="line"><span class="cl">                      DefaultStorageClass,ResourceQuota,DefaultTolerationSeconds
</span></span></code></pre></div><p>只有当所有的准入控制器都检查通过之后，apiserver 才执行该请求，否则返回拒绝。</p>
<p>当前可配置的 Admission Control 准入控制如下：</p>
<ul>
<li>AlwaysAdmit：允许所有请求</li>
<li>AlwaysDeny：禁止所有请求，一般用于测试</li>
<li>AlwaysPullImages：在启动容器之前总去下载镜像</li>
<li>DenyExecOnPrivileged：它会拦截所有想在 Privileged Container 上执行命令的请求</li>
<li>ImagePolicyWebhook：这个插件将允许后端的一个 Webhook 程序来完成 admission controller 的功能。</li>
<li>Service Account：实现 ServiceAccount 实现了自动化</li>
<li>SecurityContextDeny：这个插件将使用 SecurityContext 的 Pod 中的定义全部失效</li>
<li>ResourceQuota：用于资源配额管理目的，观察所有请求，确保在 namespace 上的配额不会超标</li>
<li>LimitRanger：用于资源限制管理，作用于 namespace 上，确保对 Pod 进行资源限制</li>
<li>InitialResources：为未设置资源请求与限制的 Pod，根据其镜像的历史资源的使用情况进行设置</li>
<li>NamespaceLifecycle：如果尝试在一个不存在的 namespace 中创建资源对象，则该创建请求将被拒绝。当删除一个 namespace 时，系统将会删除该 namespace 中所有对象。</li>
<li>DefaultStorageClass：为了实现共享存储的动态供应，为未指定 StorageClass 或 PV 的 PVC 尝试匹配默认的 StorageClass，尽可能减少用户在申请 PVC 时所需了解的后端存储细节</li>
<li>DefaultTolerationSeconds：这个插件为那些没有设置 forgiveness tolerations 并具有 notready:NoExecute 和 unreachable:NoExecute 两种 taints 的 Pod 设置默认的“容忍”时间，为 5min</li>
<li>PodSecurityPolicy：这个插件用于在创建或修改 Pod 时决定是否根据 Pod 的 security context 和可用的 PodSecurityPolicy 对 Pod 的安全策略进行控制</li>
</ul>
<h3 id="10-dashboard">10. DashBoard</h3>
<p>之前在 kubernetes 中完成的所有操作都是通过命令行工具 kubectl 完成的。其实，为了提供更丰富的用户体验，kubernetes 还开发了一个基于 web 的用户界面（Dashboard）。用户可以使用 Dashboard 部署容器化的应用，还可以监控应用的状态，执行故障排查以及管理 kubernetes 中各种资源。</p>
<h4 id="101-部署-dashboard">10.1 部署 Dashboard</h4>
<ol>
<li>下载 yaml，并运行 Dashboard</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 下载yaml</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># wget  https:/raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修改kubernetes-dashboard的Service类型</span>
</span></span><span class="line"><span class="cl">kind: Service
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    k8s-app: kubernetes-dashboard
</span></span><span class="line"><span class="cl">  name: kubernetes-dashboard
</span></span><span class="line"><span class="cl">  namespace: kubernetes-dashboard
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  type: NodePort  <span class="c1"># 新增</span>
</span></span><span class="line"><span class="cl">  ports:
</span></span><span class="line"><span class="cl">    - port: <span class="m">443</span>
</span></span><span class="line"><span class="cl">      targetPort: <span class="m">8443</span>
</span></span><span class="line"><span class="cl">      nodePort: <span class="m">30009</span>  <span class="c1"># 新增</span>
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    k8s-app: kubernetes-dashboard
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 部署</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f recommended.yaml</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看namespace下的kubernetes-dashboard下的资源</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pod,svc -n kubernetes-dashboard</span>
</span></span><span class="line"><span class="cl">NAME                                            READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod/dashboard-metrics-scraper-c79c65bb7-zwfvw   1/1     Running   <span class="m">0</span>          111s
</span></span><span class="line"><span class="cl">pod/kubernetes-dashboard-56484d4c5-z95z5        1/1     Running   <span class="m">0</span>          111s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                               TYPE       CLUSTER-IP      EXTERNAL-IP  PORT<span class="o">(</span>S<span class="o">)</span>         AGE
</span></span><span class="line"><span class="cl">service/dashboard-metrics-scraper  ClusterIP  10.96.89.218    &lt;none&gt;       8000/TCP        111s
</span></span><span class="line"><span class="cl">service/kubernetes-dashboard       NodePort   10.104.178.171  &lt;none&gt;       443:30009/TCP   111s
</span></span></code></pre></div><p>2）创建访问账户，获取 token</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建账号</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01-1 ~<span class="o">]</span><span class="c1"># kubectl create serviceaccount dashboard-admin -n kubernetes-dashboard</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 授权</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01-1 ~<span class="o">]</span><span class="c1"># kubectl create clusterrolebinding dashboard-admin-rb --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:dashboard-admin</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 获取账号token</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1">#  kubectl get secrets -n kubernetes-dashboard | grep dashboard-admin</span>
</span></span><span class="line"><span class="cl">dashboard-admin-token-xbqhh        kubernetes.io/service-account-token   <span class="m">3</span>      2m35s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl describe secrets dashboard-admin-token-xbqhh -n kubernetes-dashboard</span>
</span></span><span class="line"><span class="cl">Name:         dashboard-admin-token-xbqhh
</span></span><span class="line"><span class="cl">Namespace:    kubernetes-dashboard
</span></span><span class="line"><span class="cl">Labels:       &lt;none&gt;
</span></span><span class="line"><span class="cl">Annotations:  kubernetes.io/service-account.name: dashboard-admin
</span></span><span class="line"><span class="cl">              kubernetes.io/service-account.uid: 95d84d80-be7a-4d10-a2e0-68f90222d039
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Type:  kubernetes.io/service-account-token
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">Data</span>
</span></span><span class="line"><span class="cl"><span class="o">====</span>
</span></span><span class="line"><span class="cl">namespace:  <span class="m">20</span> bytes
</span></span><span class="line"><span class="cl">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6ImJrYkF4bW5XcDhWcmNGUGJtek5NODFuSXl1aWptMmU2M3o4LTY5a2FKS2cifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4teGJxaGgiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiOTVkODRkODAtYmU3YS00ZDEwLWEyZTAtNjhmOTAyMjJkMDM5Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmVybmV0ZXMtZGFzaGJvYXJkOmRhc2hib2FyZC1hZG1pbiJ9.NAl7e8ZfWWdDoPxkqzJzTB46sK9E8iuJYnUI9vnBaY3Jts7T1g1msjsBnbxzQSYgAG--cV0WYxjndzJY_UWCwaGPrQrt_GunxmOK9AUnzURqm55GR2RXIZtjsWVP2EBatsDgHRmuUbQvTFOvdJB4x3nXcYLN2opAaMqg3rnU2rr-A8zCrIuX_eca12wIp_QiuP3SF-tzpdLpsyRfegTJZl6YnSGyaVkC9id-cxZRb307qdCfXPfCHR_2rt5FVfxARgg_C0e3eFHaaYQO7CitxsnIoIXpOFNAR8aUrmopJyODQIPqBWUehb7FhlU1DCduHnIIXVC_UICZ-MKYewBDLw
</span></span><span class="line"><span class="cl">ca.crt:     <span class="m">1025</span> bytes
</span></span></code></pre></div><p>3）通过浏览器访问 Dashboard 的 UI</p>
<p>在登录页面上输入上面的 token</p>
<p><a href="/p/2024122601/upload/image-20200520144548997.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200520144548997.png"
	width="1030"
	height="528"
	srcset="/p/2024122601/upload/image-20200520144548997_hu8bb8f85cd94ad2554f6c835378fadd46_22665_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200520144548997_hu8bb8f85cd94ad2554f6c835378fadd46_22665_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200520144548997"
	
>
</a></p>
<p>出现下面的页面代表成功</p>
<p><a href="/p/2024122601/upload/image-20200520144959353.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200520144959353.png"
	width="1911"
	height="925"
	srcset="/p/2024122601/upload/image-20200520144959353_hu62430018ccc94d98a96145359a521ef7_32101_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200520144959353_hu62430018ccc94d98a96145359a521ef7_32101_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200520144959353"
	
>
</a></p>
<h4 id="102-使用-dashboard">10.2 使用 DashBoard</h4>
<p>本章节以 Deployment 为例演示 DashBoard 的使用</p>
<p>查看</p>
<p>选择指定的命名空间<code>dev</code>，然后点击<code>Deployments</code>，查看 dev 空间下的所有 deployment</p>
<p><a href="/p/2024122601/upload/image-20200520154628679.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200520154628679.png"
	width="1890"
	height="389"
	srcset="/p/2024122601/upload/image-20200520154628679_hu84744dd4f6b6174f8e34f84dcc71466b_13550_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200520154628679_hu84744dd4f6b6174f8e34f84dcc71466b_13550_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<p>扩缩容</p>
<p>在<code>Deployment</code>上点击<code>规模</code>，然后指定<code>目标副本数量</code>，点击确定</p>
<p><a href="/p/2024122601/upload/image-20200520162605102.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200520162605102.png"
	width="1583"
	height="616"
	srcset="/p/2024122601/upload/image-20200520162605102_hu10943837f1a0fe4880bdc31723f88344_19980_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200520162605102_hu10943837f1a0fe4880bdc31723f88344_19980_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<p>编辑</p>
<p>在<code>Deployment</code>上点击<code>编辑</code>，然后修改<code>yaml文件</code>，点击确定</p>
<p><a href="/p/2024122601/upload/image-20200520163253644.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200520163253644.png"
	width="1557"
	height="382"
	srcset="/p/2024122601/upload/image-20200520163253644_hu05a45a0ea5115cd3fe8ad34ca94639e3_17758_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200520163253644_hu05a45a0ea5115cd3fe8ad34ca94639e3_17758_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20200520163253644"
	
>
</a></p>
<p>查看 Pod</p>
<p>点击<code>Pods</code>, 查看 pods 列表</p>
<p><a href="/p/2024122601/upload/image-20200520163552110.png" data-lightbox="image">
<img src="/p/2024122601/upload/image-20200520163552110.png"
	width="1879"
	height="535"
	srcset="/p/2024122601/upload/image-20200520163552110_hufd8369c3b7cb408edf44eb96c9a43773_34820_480x0_resize_box_3.png 480w, /p/2024122601/upload/image-20200520163552110_hufd8369c3b7cb408edf44eb96c9a43773_34820_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="img"
	
>
</a></p>
<p>操作 Pod</p>
<p>选中某个 Pod，可以对其执行日志（logs）、进入执行（exec）、编辑、删除操作</p>
<blockquote>
<p>Dashboard 提供了 kubectl 的绝大部分功能，这里不再一一演示</p>
</blockquote>

</section>


    <footer class="article-footer">
    
    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>


    

<aside class="related-content--wrapper">
    <h2 class="section-title"></h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image no-copy">
    <a href="/p/250110/">
        
        
            <div class="article-image">
                <img src="/p/250110/index.4b73b7234f8aed01955591d74ed2a711_hu32955b812d1006d3ea7bcb6e13a1ca94_144678_700x420_fill_box_smart1_3.png" 
                        width="700" 
                        height="420" 
                        loading="lazy"
                        alt="Featured image of post NFS动态提供Kubernetes后端存储卷(NFS Client Provisioner)"
                        data-key="250110" 
                        data-hash="md5-S3O3I0&#43;K7QGVVZHXTtKnEQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">NFS动态提供Kubernetes后端存储卷(NFS Client Provisioner)</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image no-copy">
    <a href="/p/250109/">
        
        
            <div class="article-image">
                <img src="/p/250109/index.ed208947c643f9db7d3175230cdf210b_hu83f0d3e5546af4775fd452b834ce817e_72494_700x420_fill_box_smart1_3.png" 
                        width="700" 
                        height="420" 
                        loading="lazy"
                        alt="Featured image of post 1分钟配置Kubectl命令自动补全功能"
                        data-key="250109" 
                        data-hash="md5-7SCJR8ZD&#43;dt9MXUjDN8hCw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">1分钟配置Kubectl命令自动补全功能</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image no-copy">
    <a href="/p/250108/">
        
        
            <div class="article-image">
                <img src="/p/250108/index.d20e49d8c22da735919e9281fcac64c5_hub8466684b472b0babce73b9d19dde495_291404_700x420_fill_box_smart1_3.png" 
                        width="700" 
                        height="420" 
                        loading="lazy"
                        alt="Featured image of post kubernetes 部署gitlab"
                        data-key="250108" 
                        data-hash="md5-0g5J2MItpzWRnpKB/KxkxQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">kubernetes 部署gitlab</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image no-copy">
    <a href="/p/2024122801/">
        
        
            <div class="article-image">
                <img src="/p/2024122801/index.3dd660b7cbd034277f0703d00132c850_hu577bcdfe50a970670accc4c7e4653423_55389_700x420_fill_q75_box_smart1.jpg" 
                        width="700" 
                        height="420" 
                        loading="lazy"
                        alt="Featured image of post kubernetes 如何避免滚动更新时服务中断"
                        data-key="2024122801" 
                        data-hash="md5-PdZgt8vQNCd/BwPQATLIUA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">kubernetes 如何避免滚动更新时服务中断</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image no-copy">
    <a href="/p/240824/">
        
        
            <div class="article-image">
                <img src="/p/240824/index.1069738c7454e8d93c67ca4d8bd57dd1_hu861124b96ba3977267ff32a0c417b886_194624_700x420_fill_box_smart1_3.png" 
                        width="700" 
                        height="420" 
                        loading="lazy"
                        alt="Featured image of post kubernetes部署Jenkins"
                        data-key="240824" 
                        data-hash="md5-EGlzjHRU6Nk8Z8pNi9V90Q==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">kubernetes部署Jenkins</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        <script>
  twikoo.init({
    envId: "",
    el: "#tcomment",
  });
</script>
    
    <div id="skip">
        <div class="skip-top">
          <a href="#top" class="skip-top" title="返回顶部">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
<title id="chevronUpIconTitle">返回顶部</title> 
<polyline points="6 14 12 8 18 14 18 14"/> 
</svg>
          </a>
        </div>
        
    </div>
    <script>
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        const scrollToggleBtn = document.querySelector('#skip');

        const handleScrollDebounced = debounce(function() {
            scrollToggleBtn.classList.remove('hidden');
        }, 1000);

        window.addEventListener('scroll', () => {
            scrollToggleBtn.classList.add('hidden');
            handleScrollDebounced();
        });
    </script>

                    <script type="text/javascript" src="/ts/main.js" defer></script>

  <script src="/js/lightbox-plus-jquery.js"></script>

  <script src="/js/pieces.js"></script>

  <script src="/js/twikoo.js"></script>



<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

                </div>
                
                    <div class="article-sidebar">
                        <aside class="right-sidebar">
    <form action="/search/" class="search-form" >
        <p>
            <input name="keyword" required placeholder="" />
        
            <button title="">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



            </button>
        </p>
    </form>
    <div class="info-widget no-copy widget--card">
    <div class="info-bg">
    </div>
  
    <div class="site-avatar">
      <img src="/images/apple-touch-icon.png" alt="" />
    </div>
  
    <div class="site-meta">
      <p class="site-name">运维匠</p>
      <p class="site-description">运维经验技术分享</p>
    </div>
    <div class="social">
      
      
    </div>
  </div>
    

    <div class="sticky">
  
<div class="widget--toc no-copy">
  <h2>📑 目录</h2>
  <nav id="TableOfContents">
  <ol>
    <li><a href="#kubernetes-详细教程">Kubernetes 详细教程</a>
      <ol>
        <li><a href="#1-kubernetes-介绍">1. Kubernetes 介绍</a>
          <ol>
            <li><a href="#11-应用部署方式演变">1.1 应用部署方式演变</a></li>
            <li><a href="#12-kubernetes-简介">1.2 kubernetes 简介</a></li>
            <li><a href="#13-kubernetes-组件">1.3 kubernetes 组件</a></li>
            <li><a href="#14-kubernetes-概念">1.4 kubernetes 概念</a></li>
          </ol>
        </li>
        <li><a href="#2-kubernetes-集群环境搭建">2. kubernetes 集群环境搭建</a>
          <ol>
            <li><a href="#21-前置知识点">2.1 前置知识点</a></li>
            <li><a href="#22-kubeadm-部署方式介绍">2.2 kubeadm 部署方式介绍</a></li>
            <li><a href="#23-安装要求">2.3 安装要求</a></li>
            <li><a href="#24-最终目标">2.4 最终目标</a></li>
            <li><a href="#25-准备环境">2.5 准备环境</a></li>
            <li><a href="#26-环境初始化">2.6 环境初始化</a></li>
            <li><a href="#27-集群测试">2.7 集群测试</a></li>
          </ol>
        </li>
        <li><a href="#3-资源管理">3. 资源管理</a>
          <ol>
            <li><a href="#31-资源管理介绍">3.1 资源管理介绍</a></li>
            <li><a href="#32-yaml-语言介绍">3.2 YAML 语言介绍</a></li>
            <li><a href="#33-资源管理方式">3.3 资源管理方式</a></li>
          </ol>
        </li>
        <li><a href="#332-命令式对象配置">3.3.2 命令式对象配置</a></li>
        <li><a href="#333-声明式对象配置">3.3.3 声明式对象配置</a></li>
        <li><a href="#4-实战入门">4. 实战入门</a>
          <ol>
            <li><a href="#41-namespace">4.1 Namespace</a></li>
            <li><a href="#42-pod">4.2 Pod</a></li>
            <li><a href="#43-label">4.3 Label</a></li>
            <li><a href="#44-deployment">4.4 Deployment</a></li>
            <li><a href="#45-service">4.5 Service</a></li>
          </ol>
        </li>
        <li><a href="#5-pod-详解">5. Pod 详解</a>
          <ol>
            <li><a href="#51-pod-介绍">5.1 Pod 介绍</a></li>
            <li><a href="#52-pod-配置">5.2 Pod 配置</a></li>
            <li><a href="#53-pod-生命周期">5.3 Pod 生命周期</a></li>
            <li><a href="#54-pod-调度">5.4 Pod 调度</a></li>
          </ol>
        </li>
        <li><a href="#6-pod-控制器详解">6. Pod 控制器详解</a>
          <ol>
            <li><a href="#61-pod-控制器介绍">6.1 Pod 控制器介绍</a></li>
            <li><a href="#62-replicasetrs">6.2 ReplicaSet(RS)</a></li>
            <li><a href="#63-deploymentdeploy">6.3 Deployment(Deploy)</a></li>
            <li><a href="#64-horizontal-pod-autoscalerhpa">6.4 Horizontal Pod Autoscaler(HPA)</a></li>
            <li><a href="#65-daemonsetds">6.5 DaemonSet(DS)</a></li>
            <li><a href="#66-job">6.6 Job</a></li>
            <li><a href="#67-cronjobcj">6.7 CronJob(CJ)</a></li>
          </ol>
        </li>
        <li><a href="#7-service-详解">7. Service 详解</a>
          <ol>
            <li><a href="#71-service-介绍">7.1 Service 介绍</a></li>
            <li><a href="#72-service-类型">7.2 Service 类型</a></li>
            <li><a href="#73-service-使用">7.3 Service 使用</a></li>
            <li><a href="#74-ingress-介绍">7.4 Ingress 介绍</a></li>
            <li><a href="#75-ingress-使用">7.5 Ingress 使用</a></li>
          </ol>
        </li>
        <li><a href="#8-数据存储">8. 数据存储</a>
          <ol>
            <li><a href="#81-基本存储">8.1 基本存储</a></li>
            <li><a href="#82-高级存储">8.2 高级存储</a></li>
            <li><a href="#83-配置存储">8.3 配置存储</a></li>
          </ol>
        </li>
        <li><a href="#9-安全认证">9. 安全认证</a>
          <ol>
            <li><a href="#91-访问控制概述">9.1 访问控制概述</a></li>
            <li><a href="#92-认证管理">9.2 认证管理</a></li>
            <li><a href="#93-授权管理">9.3 授权管理</a></li>
            <li><a href="#94-准入控制">9.4 准入控制</a></li>
          </ol>
        </li>
        <li><a href="#10-dashboard">10. DashBoard</a>
          <ol>
            <li><a href="#101-部署-dashboard">10.1 部署 Dashboard</a></li>
            <li><a href="#102-使用-dashboard">10.2 使用 DashBoard</a></li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav>
</div>

  <div class="random-posts widget--card">
    <h2>📄 随机文章</h2>
    <button id="random-btn" onclick="loadRandomPosts()" class="">
        <svg role="img" xmlns="http://www.w3.org/2000/svg" width="48px" height="48px" viewBox="0 0 24 24" aria-labelledby="refreshIconTitle" stroke-width="2" stroke-linecap="square" stroke-linejoin="miter" fill="none">
<polyline points="22 12 19 15 16 12"/> 
<path d="M11,20 C6.581722,20 3,16.418278 3,12 C3,7.581722 6.581722,4 11,4 C15.418278,4 19,7.581722 19,12 L19,14"/> 
</svg>
    </button>
    <div id="random-posts"></div>
</div>

<script>
    function loadRandomPosts() {
        const btn = document.getElementById('random-btn');
        btn.classList.add('rotate');  
        btn.addEventListener('animationend', function() {
            btn.classList.remove('rotate');  
        });
        fetch('/random.json')  
            .then(response => response.json())
            .then(data => {
                const postsContainer = document.getElementById('random-posts');
                postsContainer.innerHTML = ''; 
                const shuffled = data.articles.sort(() => 0.5 - Math.random()); 
                shuffled.slice(0, 5).forEach(post => { 
                    const postElement = document.createElement('div');
                    postElement.innerHTML = `
                    <a href="${post.url}">
                        <div class="random-post">
                            <div class="random-post-img">
                                <img src="${post.image}" alt="${post.title}">
                            </div>
                            <div class="random-post-content">
                                <h3>${post.title}</h3>
                                <p>${new Date(post.date).toLocaleDateString()}</p>
                            </div>
                        </div>
                    </a>
                    `;
                    postsContainer.appendChild(postElement);
                });
            });
    }
    
    
    loadRandomPosts();
    </script>
    
  
<section class="tagcloud--widget widget--card">
    <h2>🔖 标签</h2>

    <div class="tagcloud-tags">
        
            
                
                <a href="/tags/jenkins/" class="tagCloud-tag">
                    #jenkins<span class="tagcloud-count">1</span>
                </a>
            
                
                <a href="/tags/kubeasz/" class="tagCloud-tag">
                    #kubeasz<span class="tagcloud-count">1</span>
                </a>
            
                
                <a href="/tags/kubernetes/" class="tagCloud-tag">
                    #kubernetes<span class="tagcloud-count">1</span>
                </a>
            
                
                <a href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/" class="tagCloud-tag">
                    #云原生<span class="tagcloud-count">4</span>
                </a>
            
        
    </div>
<section>


</div>
</aside>

                    </div>
                
            </main>
        </div><footer class="site-footer no-copy">
    <div class="footer-info">
        <div class="left-footer">
            <section class="copyright">
                &copy; 
                
                    2023 - 
                
                2025 运维匠-运维工程师知识分享经验和最佳实践
            </section>
            <section class="static">
                
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                共创作了14篇文章，60.10k字
            </section>
        </div>
        <div class="right-footer">
            <section class="time">
                本站已运行<SPAN id=span_dt_dt></SPAN>
            </section>
            <section class="link-info">
                <span class="RSS">
                    <a href="https://gohugo.io/" target="_blank">Hugo</a>
                </span>
                
                
                
                

            </section>
        </div>
    </div>
</footer>

<SCRIPT language=javascript>
    function show_date_time(){
    window.setTimeout("show_date_time()", 1000);
    BirthDay=new Date("12\/04\/2023 00:00:00");
    today=new Date();
    timeold=(today.getTime()-BirthDay.getTime());
    sectimeold=timeold/1000
    secondsold=Math.floor(sectimeold);
    msPerDay=24*60*60*1000
    e_daysold=timeold/msPerDay
    daysold=Math.floor(e_daysold);
    e_hrsold=(e_daysold-daysold)*24;
    hrsold=Math.floor(e_hrsold);
    e_minsold=(e_hrsold-hrsold)*60;
    minsold=Math.floor((e_hrsold-hrsold)*60);
    seconds=Math.floor((e_minsold-minsold)*60);
    span_dt_dt.innerHTML=""+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";
    }
    show_date_time();
</SCRIPT></body>
    <script>
    
    var toggleButton = document.getElementById('toggleButton');
    var closeButton = document.getElementById('closeButton');
    var sidebar = document.getElementById('left-sidebar');
    var overlay = document.querySelector('.overlay');

    
    toggleButton.addEventListener('click', function() {
        sidebar.style.left = '0';
        overlay.style.display = 'block';
    });

    
    closeButton.addEventListener('click', function() {
        sidebar.style.left = '-500px';
        overlay.style.display = 'none';
    });
    </script>
</html>
